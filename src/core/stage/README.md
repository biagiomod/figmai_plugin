# Stage Rendering System

Unified architecture for rendering assistant outputs to the Figma canvas.

## Architecture

### Intermediate Representations (IRs)

- **Document IR** (`src/core/output/ir.ts`): Textual outputs (critiques, instructions, summaries)
- **DesignSpec IR** (`src/core/design/ir.ts`): JSON specs for generating Figma nodes

### Normalizers

- **`normalizeDesignCritique`**: Converts LLM response to Document IR
  - Tries JSON scorecard first
  - Falls back to markdown parsing

### Stage System

- **`anchor.ts`**: Placement logic (40px left of topmost page-level container)
- **`primitives.ts`**: Reusable helpers (fonts, frames, text nodes)
- **`renderDocument.ts`**: Renders Document IR to stage
- **`renderDesignSpec.ts`**: Renders DesignSpec IR to stage

### Selection Capture

- **`getSelectionContext`**: Gets selected node, anchor node, summary
- **`exportSelectionImages`**: Exports selection as PNG
- **`getNodeMetadata`**: Gets basic structural metadata

## Usage

### Design Critique

```typescript
import { normalizeDesignCritique } from './core/output/normalize'
import { renderDocumentToStage } from './core/stage/renderDocument'

const doc = normalizeDesignCritique(llmResponse)
await renderDocumentToStage(doc, { selectedNode, width: 640 })
```

### Code2Design

```typescript
import { parseDesignSpecJson, renderDesignSpecToStage } from './core/stage/renderDesignSpec'

const spec = parseDesignSpecJson(jsonInput)
if (spec) {
  await renderDesignSpecToStage(spec, { selectedNode, placement: 'left', offset: 40 })
}
```

## Manual Test Checklist

### Design Critique

1. **Nested Selection**:
   - Select a deeply nested node (e.g., text inside frame inside component)
   - Run Design Critique
   - ✅ Output appears 40px left of topmost page-level container
   - ✅ Top-aligned with container
   - ✅ No auto-layout errors

2. **No Selection**:
   - Deselect everything
   - Run Design Critique
   - ✅ Output appears centered in viewport

3. **JSON vs Markdown**:
   - Test with valid JSON response → scorecard renders
   - Test with markdown response → markdown blocks render

### Code2Design

1. **Basic DesignSpec**:
   - Paste example JSON (see below)
   - Call `renderDesignSpecToStage`
   - ✅ Frame created with correct dimensions
   - ✅ Text nodes created and positioned
   - ✅ Positioned 40px left of selection (or centered if no selection)

2. **Example DesignSpec**:
```json
{
  "version": 1,
  "root": {
    "type": "frame",
    "name": "Code2Design — Sample",
    "width": 360,
    "height": 220,
    "fills": [{"type":"SOLID","color":{"r":1,"g":1,"b":1},"opacity":1}],
    "strokes": [{"type":"SOLID","color":{"r":0.85,"g":0.85,"b":0.85},"opacity":1}],
    "cornerRadius": 12,
    "children": [
      { "type":"text", "name":"Title", "text":"Hello from JSON", "fontSize": 18, "fills":[{"type":"SOLID","color":{"r":0,"g":0,"b":0},"opacity":1}] },
      { "type":"text", "name":"Body", "text":"This was generated by Code2Design.", "fontSize": 12, "fills":[{"type":"SOLID","color":{"r":0.2,"g":0.2,"b":0.2},"opacity":1}] }
    ]
  }
}
```

## Best Practices

- All stage placement goes through `core/stage/anchor.ts`
- All stage creation goes through `core/stage/primitives.ts`
- All document rendering through `core/stage/renderDocument.ts`
- All design generation through `core/stage/renderDesignSpec.ts`
- All selection export + metadata through `core/selection/*`
- No assistant should directly implement placement math or font loading

