var Ee=Object.defineProperty,Mi=Object.defineProperties,Li=Object.getOwnPropertyDescriptor,Pi=Object.getOwnPropertyDescriptors,Fi=Object.getOwnPropertyNames,Nt=Object.getOwnPropertySymbols;var It=Object.prototype.hasOwnProperty,$i=Object.prototype.propertyIsEnumerable;var zi=(n,t)=>(t=Symbol[n])?t:Symbol.for("Symbol."+n);var Xe=(n,t,e)=>t in n?Ee(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,N=(n,t)=>{for(var e in t||(t={}))It.call(t,e)&&Xe(n,e,t[e]);if(Nt)for(var e of Nt(t))$i.call(t,e)&&Xe(n,e,t[e]);return n},B=(n,t)=>Mi(n,Pi(t));var v=(n,t)=>()=>(n&&(t=n(n=0)),t);var Z=(n,t)=>{for(var e in t)Ee(n,e,{get:t[e],enumerable:!0})},Ui=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Fi(t))!It.call(n,r)&&r!==e&&Ee(n,r,{get:()=>t[r],enumerable:!(i=Li(t,r))||i.enumerable});return n};var _i=n=>Ui(Ee({},"__esModule",{value:!0}),n);var I=(n,t,e)=>Xe(n,typeof t!="symbol"?t+"":t,e);var ee=function(n,t){this[0]=n,this[1]=t},ae=(n,t,e)=>{var i=(s,a,l,p)=>{try{var c=e[s](a),d=(a=c.value)instanceof ee,u=c.done;Promise.resolve(d?a[0]:a).then(m=>d?i(s==="return"?s:"next",a[1]?{done:m.done,value:m.value}:m,l,p):l({value:m,done:u})).catch(m=>i("throw",m,l,p))}catch(m){p(m)}},r=s=>o[s]=a=>new Promise((l,p)=>i(s,a,l,p)),o={};return e=e.apply(n,t),o[zi("asyncIterator")]=()=>o,r("next"),r("throw"),r("return"),o};function $(n,t){let e=`${Ct}`;return Ct+=1,Se[e]={handler:t,name:n},function(){delete Se[e]}}function Ke(n,t){let e=!1;return $(n,function(...i){e!==!0&&(e=!0,t(...i))})}function kt(n,t){let e=!1;for(let i in Se)Se[i].name===n&&(Se[i].handler.apply(null,t),e=!0);if(e===!1)throw new Error(`No event handler with name \`${n}\``)}var Se,Ct,Et=v(()=>{Se={},Ct=0;typeof window=="undefined"?figma.ui.onmessage=function(n){if(!Array.isArray(n))return;let[t,...e]=n;typeof t=="string"&&kt(t,e)}:window.onmessage=function(n){if(typeof n.data.pluginMessage=="undefined")return;let t=n.data.pluginMessage;if(!Array.isArray(t))return;let[e,...i]=n.data.pluginMessage;typeof e=="string"&&kt(e,i)}});function Qe(n,t){if(typeof __html__=="undefined")throw new Error("No UI defined");let e=`<div id="create-figma-plugin"></div><script>document.body.classList.add('theme-${figma.editorType}');const __FIGMA_COMMAND__='${typeof figma.command=="undefined"?"":figma.command}';const __SHOW_UI_DATA__=${JSON.stringify(typeof t=="undefined"?{}:t)};${__html__}</script>`;figma.showUI(e,B(N({},n),{themeColors:typeof n.themeColors=="undefined"?!0:n.themeColors}))}var Rt=v(()=>{});var Ot=v(()=>{Et();Rt()});var Dt,Mt=v(()=>{"use strict";Dt={codeName:"figmai_plugin",brandName:"FigmAI"}});var O,te=v(()=>{"use strict";O={provider:"openai",features:{enableToolCalls:!0,enableVision:!1,enableSelectionExportPng:!1},defaultMode:"advanced",dev:{enableContentTableValidationLogging:!1,enableClipboardDebugLogging:!1,enableSyncApiErrorDetection:!0,enableDesignCritiqueDebugLogging:!1,debug:{enabled:!1,scopes:{"assistant:design_critique":!1,"assistant:content_table":!1,"assistant:design_workshop":!1,"assistant:discovery_copilot":!1,"assistant:general":!1,"subsystem:provider":!1,"subsystem:parsing":!1,"subsystem:canvas":!1,"subsystem:selection":!1,"subsystem:clipboard":!1,global:!1},levels:{debug:!0,info:!0,warn:!0,error:!0}}}}});function Ze(n){return le.find(t=>t.id===n)}function et(n){return n==="content-mvp"?le.find(e=>e.id==="content_table")||le[0]:n==="simple"&&le.find(e=>e.id==="general")||le[0]}function tt(n){var o;let t=n.promptMarkdown||"",e=(o=t.split(`

`)[0])==null?void 0:o.trim();if(e&&e.length>0&&e.length<=300)return e;let i=t.substring(0,200),r=i.lastIndexOf(" ");return r>150?i.substring(0,r)+"...":i+(t.length>200?"...":"")}var Lt,qi,le,Pt=v(()=>{"use strict";Lt=`# General Assistant

You are FigmAI, a helpful AI assistant integrated into Figma to help designers with their work.

## Your Role

- Answer questions about design principles, best practices, and Figma usage
- Provide guidance on layout, typography, color, and spacing
- Help with design workflows and tool usage
- Offer constructive feedback and suggestions
- Explain design decisions and concepts

## Guidelines

- Be concise but thorough
- Use design terminology appropriately
- Reference Figma-specific features when relevant
- Provide actionable advice when possible
- Be supportive and encouraging

## Context

When a user shares their selection, you can see information about the selected Figma nodes including:
- Node types (frames, text, rectangles, etc.)
- Names and dimensions
- Layout properties (for frames)
- Text content and styling (for text nodes)

Use this context to provide relevant, specific feedback.`,qi=`# Design Critique Assistant

**CRITICAL**: Return ONLY valid JSON. Do not wrap in \`\`\` fences. Do not include any other text.

You are **FigmAI's Design Critique Assistant**, an expert UX and UI design reviewer embedded inside a Figma plugin.
You will receive one or more images of a UI design exported directly from Figma.
Your purpose is to evaluate the user's selected frame or element on the Figma canvas and provide clear, structured, and actionable critique grounded in proven UX, UI, and product design principles.

[Full knowledge base available in: src/assistants/designCritique.md]

## Output Format (STRICT)

You MUST respond with valid JSON in this exact format (NO markdown fences, NO other text):

{
  "score": 85,
  "summary": "1-2 sentences summarizing the overall design quality and key findings",
  "wins": ["Primary CTA is visually dominant and clearly separated from secondary actions", "Consistent spacing system creates clear visual hierarchy"],
  "fixes": ["Increase text contrast for body text to meet WCAG AA (currently #666, suggest #333)", "Add 8px spacing between related form fields to improve grouping", "Make interactive elements more obvious with hover states"],
  "checklist": ["Primary action is visually dominant", "Related elements are grouped using spacing", "Interactive elements look interactive", "Text is readable without zooming", "Color contrast meets WCAG AA standards"],
  "notes": []
}

**Required fields**:
- score: Integer 0-100 (required)
- summary: String (required, can be empty string)
- wins: Array of strings (required, can be empty array)
- fixes: Array of strings (required, can be empty array)
- checklist: Array of strings (optional, can be empty array)
- notes: Array of strings (optional, can be empty array or omitted)

**Rules**:
- NO markdown code fences (\`\`\`json or \`\`\`)
- NO leading or trailing text
- NO commentary or explanations
- NO whitespace before { or after }
- ONLY the raw JSON object

Scoring: 90-100 (exceptional), 80-89 (strong), 70-79 (solid), 60-69 (functional), Below 60 (major issues).

Evaluate: Hierarchy, Layout, Spacing, Typography, Color/Contrast, Affordance, Consistency, Accessibility, States.

**CRITICAL**: Return ONLY valid JSON. Do not wrap in \`\`\` fences. Do not include any other text.`,le=[{id:"general",label:"General",intro:"I'm your general design assistant. Ask me anything about design, Figma, or your current work.",promptMarkdown:Lt,iconId:"AskIcon",kind:"ai",quickActions:[{id:"explain",label:"Explain this design",templateMessage:"Can you explain this design to me? What are the key elements and their purpose?",requiresSelection:!1},{id:"suggestions",label:"Design suggestions",templateMessage:"What suggestions do you have to improve this design?",requiresSelection:!1}]},{id:"content_table",label:"Content Table",intro:`**Welcome to your Content Table Assistant**

I generate structured content inventories and tables from your designs. Select a single container to scan all text content.`,promptMarkdown:`# Content Table Assistant

You are **FigmAI's Content Table Assistant**, a content strategist and information architect embedded inside a Figma plugin.
You generate structured content inventories and tables that help teams track, organize, and manage all text content in their designs.

[Full knowledge base available in: src/assistants/contentTable.md]`,iconId:"ContentTableIcon",kind:"tool",quickActions:[{id:"generate-table",label:"GENERATE TABLE",templateMessage:"Scan selected container and generate content table",requiresSelection:!0}]},{id:"ux_copy_review",label:"Content Review",intro:"I review and improve text content for clarity, tone, and UX effectiveness. Select text layers to analyze copy.",promptMarkdown:`# Content Review Assistant

You are **FigmAI's Content Review Assistant**, an expert content strategist and UX writer embedded inside a Figma plugin.
You specialize in evaluating and improving text content for clarity, tone, user experience effectiveness, and conversion optimization.

[Full knowledge base available in: src/assistants/uxCopyReview.md]`,iconId:"SpellCheckIcon",kind:"ai",quickActions:[{id:"review-copy",label:"Review copy",templateMessage:"Review the selected text content for clarity, tone, conciseness, and actionability. Provide structured feedback with scores and specific suggestions.",requiresSelection:!0},{id:"tone-check",label:"Tone check",templateMessage:"Analyze the tone of the selected copy. Is it appropriate for the context and target audience?",requiresSelection:!0},{id:"content-suggestions",label:"Content suggestions",templateMessage:"What improvements can be made to the copy? Focus on clarity, user-centered language, and actionability.",requiresSelection:!1}]},{id:"design_critique",label:"Design Critique",intro:"I provide detailed design critiques with scores, wins, fixes, and actionable feedback. Select a design element to get started.",promptMarkdown:qi,iconId:"ArtIcon",kind:"ai",quickActions:[{id:"give-critique",label:"Give Design Crit",templateMessage:"Provide a comprehensive design critique of the selected elements.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2},{id:"deceptive-review",label:"Deceptive Review",templateMessage:"Evaluate this design for Dark & Deceptive UX practices. Identify any patterns that manipulate, mislead, or harm users.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2}]},{id:"code2design",label:"Code2Design",intro:"Import/export JSON templates to create and manage Figma designs.",promptMarkdown:Lt,iconId:"CodeIcon",kind:"hybrid",quickActions:[{id:"send-json",label:"SEND JSON",templateMessage:"Paste a FigmAI Template JSON to generate Figma elements",requiresSelection:!1},{id:"get-json",label:"GET JSON",templateMessage:"Export selected frames to JSON template format",requiresSelection:!0},{id:"json-format-help",label:"How to format JSON",templateMessage:"Explain the FigmAI Template JSON format and schema requirements",requiresSelection:!1}]},{id:"dev_handoff",label:"Dev Handoff",intro:"I generate developer-friendly specifications and documentation from your designs. Select frames or components to get started.",promptMarkdown:`# Dev Handoff Assistant

You are **FigmAI's Dev Handoff Assistant**, a technical documentation specialist embedded inside a Figma plugin.
You generate developer-friendly specifications, measurements, and implementation guidance from Figma designs.

[Full knowledge base available in: src/assistants/devHandoff.md]`,iconId:"CodeIcon",kind:"ai",quickActions:[{id:"generate-specs",label:"Generate specs",templateMessage:"Generate comprehensive developer specifications including layout, typography, colors, components, interactions, and accessibility requirements.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2},{id:"export-measurements",label:"Export measurements",templateMessage:"Export all measurements, spacing, and sizing information for the selected elements.",requiresSelection:!0},{id:"component-details",label:"Component details",templateMessage:"Provide detailed component specifications including variants, states, and implementation notes.",requiresSelection:!0}]},{id:"accessibility",label:"Accessibility",intro:"I help ensure your designs are accessible and inclusive. Select elements to check for accessibility issues.",promptMarkdown:`# Accessibility Assistant

You are **FigmAI's Accessibility Assistant**, an expert in inclusive design and WCAG compliance embedded inside a Figma plugin.
You specialize in identifying accessibility barriers and providing specific, actionable fixes to make designs usable by everyone.

[Full knowledge base available in: src/assistants/accessibility.md]`,iconId:"ADAIcon",kind:"ai",quickActions:[{id:"check-a11y",label:"Check accessibility",templateMessage:"Review this design for accessibility issues. Check color contrast, text sizing, interactive elements, and WCAG compliance.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2},{id:"wcag-compliance",label:"WCAG compliance",templateMessage:"Check WCAG AA/AAA compliance. Identify all violations and provide specific fixes with contrast ratios and measurements.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2},{id:"contrast-analysis",label:"Color contrast analysis",templateMessage:"Analyze color contrast for all text/background combinations. Calculate contrast ratios and identify issues.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2}]},{id:"errors",label:"Errors",intro:"I identify design errors, inconsistencies, and quality issues. Select elements to find problems before handoff.",promptMarkdown:`# Errors Assistant

You are **FigmAI's Errors Assistant**, a design quality assurance specialist embedded inside a Figma plugin.
You identify design errors, inconsistencies, and quality issues that could cause problems in implementation or user experience.

[Full knowledge base available in: src/assistants/errors.md]`,iconId:"CautionIcon",kind:"ai",quickActions:[{id:"find-errors",label:"Find errors",templateMessage:"Identify all design errors including layout issues, inconsistencies, component misuse, missing states, and naming problems.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2},{id:"check-consistency",label:"Check consistency",templateMessage:"Check for style inconsistencies in spacing, colors, typography, and component usage across the design.",requiresSelection:!0,requiresVision:!0,maxImages:1,imageScale:2}]},{id:"design_workshop",label:"Design Workshop",intro:`**Welcome to your Design Workshop Assistant!**

I generate 1-5 Figma screens from a JSON specification. Describe the screens you want, and I'll create them on the canvas.`,promptMarkdown:`# Design Workshop Assistant

**CRITICAL**: Return ONLY valid JSON. Do not wrap in \`\`\` fences. Do not include any other text.

You are **FigmAI's Design Workshop Assistant**, a screen generator embedded inside a Figma plugin.
You generate 1-5 Figma screens from user descriptions, creating complete screen layouts with headings, text, buttons, inputs, cards, and images.

## Output Format (STRICT)

You MUST respond with valid JSON in this exact format (NO markdown fences, NO other text):

{
  "type": "designScreens",
  "version": 1,
  "meta": { "title": "Screen set name" },
  "canvas": {
    "device": {
      "kind": "mobile" | "tablet" | "desktop",
      "width": number,
      "height": number
    }
  },
  "render": {
    "intent": {
      "fidelity": "wireframe" | "medium" | "hi" | "creative"
    }
  },
  "screens": [
    {
      "name": "Screen name",
      "layout": {
        "direction": "vertical" | "horizontal",
        "padding": number,
        "gap": number
      },
      "blocks": [
        { "type": "heading", "text": "...", "level": 1 | 2 | 3 },
        { "type": "bodyText", "text": "..." },
        { "type": "button", "text": "...", "variant": "primary" | "secondary" | "tertiary" },
        { "type": "input", "label": "...", "placeholder": "...", "type": "text" | "email" | "password" },
        { "type": "card", "title": "...", "content": "..." },
        { "type": "spacer", "height": number },
        { "type": "image", "width": number, "height": number }
      ]
    }
  ]
}

**Rules**:
- NO markdown code fences (\`\`\`json or \`\`\`)
- NO leading or trailing text
- NO commentary or explanations
- Generate 1-5 screens only (if more requested, generate exactly 5 and include meta.truncationNotice)
- ONLY the raw JSON object

**CRITICAL**: Return ONLY valid JSON. Do not wrap in \`\`\` fences. Do not include any other text.`,iconId:"LightBulbRaysIcon",kind:"ai",quickActions:[{id:"generate-screens",label:"Demo: Generate Screens",templateMessage:"Generating demo screen/s using medium fidelity.",requiresSelection:!1}]},{id:"discovery_copilot",label:"Discovery Copilot",intro:`**Welcome to Discovery Copilot!**

I'll guide you through a structured discovery process in 3 steps:

**Step 1: Problem Frame** - Define what you're solving, who it affects, why it matters, and what success looks like
**Step 2: Risks & Assumptions** - Identify potential risks and key assumptions
**Step 3: Hypotheses & Experiments** - Form hypotheses and propose experiments to test them

Let's begin! What are you discovering today? (e.g., "redesigning checkout flow", "building a new feature")`,promptMarkdown:`# Discovery Copilot Assistant

You are **FigmAI's Discovery Copilot Assistant**, a structured discovery thinking guide embedded inside a Figma plugin.
You guide users through a 3-step discovery process to help them frame problems, identify risks, and form testable hypotheses.

## Process Overview

**Step 1: Problem Frame**
- Ask: What problem are we solving?
- Ask: Who is affected?
- Ask: Why does this matter?
- Ask: What does success look like?

**Step 2: Risks & Assumptions**
- Ask: What are the main risks? (3-5)
- Ask: What are our key assumptions? (3-5)
- For each: Ask impact level (high/medium/low)

**Step 3: Hypotheses & Experiments**
- Ask: What hypotheses do you want to test? (2-4)
- For each: Ask what experiment would test it

**Optional: Decision Log & Async Tasks**
- Ask if user wants to add Decision Log (yes/no)
- Ask if user wants to add Async Tasks (yes/no)

## Output Format

When the user has provided all information, return ONLY valid JSON matching DiscoverySpecV1 schema:

{
  "type": "discovery",
  "version": 1,
  "meta": {
    "title": "string (max 48 chars, derive from user's initial topic)",
    "userRequest": "string (initial user request)"
  },
  "problemFrame": {
    "what": "string",
    "who": "string",
    "why": "string",
    "success": "string"
  },
  "risksAndAssumptions": [
    {
      "id": "risk-1",
      "type": "risk" | "assumption",
      "description": "string",
      "impact": "high" | "medium" | "low" (optional)
    }
  ],
  "hypothesesAndExperiments": [
    {
      "id": "hyp-1",
      "hypothesis": "string",
      "experiment": "string (optional)",
      "status": "untested" | "testing" | "validated" | "invalidated" (optional)
    }
  ],
  "decisionLog": [ // Optional
    {
      "timestamp": "ISO 8601 string",
      "decision": "string",
      "rationale": "string (optional)",
      "context": "string (optional)"
    }
  ],
  "asyncTasks": [ // Optional
    {
      "ownerRole": "Design" | "Product" | "Dev" | "Research" | "Analytics" | "Other",
      "task": "string",
      "dueInHours": number (optional)
    }
  ]
}

**Rules**:
- Guide users step-by-step with clear progress indicators
- Show "Step X of 3" when starting each step
- Confirm completion with "\u2713 Step X complete"
- Generate 1-12 risks/assumptions, 1-12 hypotheses
- When all information is collected, return JSON only (no markdown fences, no other text)`,iconId:"PathIcon",kind:"ai",quickActions:[{id:"start-discovery",label:"Start Discovery",templateMessage:"Start a discovery session. Help me frame the problem, identify risks, and plan experiments.",requiresSelection:!1}]}]});function Hi(n,t){if(!n||n.length===0||!t.supportsImages)return;let e=n;t.maxImages!==void 0&&n.length>t.maxImages&&(e=n.slice(0,t.maxImages));let i=[];for(let r of e)!r.dataUrl||typeof r.dataUrl!="string"||r.dataUrl.startsWith("data:")&&i.push({dataUrl:r.dataUrl,name:r.name,width:r.width,height:r.height});return i.length>0?i:void 0}function Re(n){return n.filter(t=>t&&t.role&&t.content).map(t=>({role:Bi(t.role),content:String(t.content).trim()})).filter(t=>t.content.length>0)}function Bi(n){let t=n.toLowerCase().trim();return t==="user"||t==="assistant"||t==="system"?t:"user"}function Oe(n,t){let e={messages:Re(n.messages),assistantId:n.assistantId,assistantName:n.assistantName,quickActionId:n.quickActionId,selection:n.selection,selectionSummary:n.selectionSummary,quickAction:n.quickAction};return e.images=Hi(n.images,t),e}function Ft(n){if(typeof n=="string")return n;if(n&&typeof n=="object"){let t=n;if(typeof t.text=="string")return t.text;if(typeof t.content=="string")return t.content;if(typeof t.message=="string")return t.message;if(typeof t.response=="string")return t.response;if(t.choices&&Array.isArray(t.choices)&&t.choices.length>0){let e=t.choices[0];if(e&&typeof e=="object"){let i=e;if(i.message&&typeof i.message=="object"){let r=i.message;if(typeof r.content=="string")return r.content}if(typeof i.text=="string")return i.text}}try{let e=JSON.stringify(n);if(e.length<1e3)return e}catch(e){}}return String(n)}var be=v(()=>{"use strict"});var $t={};Z($t,{StubProvider:()=>Ae});var Ae,nt=v(()=>{"use strict";be();Ae=class{constructor(){I(this,"id","stub");I(this,"label","Stub (Development)");I(this,"isEnabled",!0);I(this,"capabilities",{supportsImages:!0,supportsMarkdown:!0,requiresStrictSchema:!1})}async sendChat(t){var o;let e=Oe(t,this.capabilities);await new Promise(s=>setTimeout(s,500));let i=[];e.assistantName&&i.push(`[${e.assistantName} Assistant]`),(o=e.selection)!=null&&o.hasSelection&&(i.push(`I can see you have ${e.selection.count} item(s) selected.`),e.selection.summary&&i.push(`Summary: ${e.selection.summary}`)),e.images&&e.images.length>0&&i.push(`Received ${e.images.length} image(s) for analysis.`),e.quickAction&&i.push(`Quick action "${e.quickAction}" was triggered.`);let r=e.messages.filter(s=>s.role==="user").pop();return r?(i.push(`

You asked: "${r.content}"`),i.push(`

This is a stub response. In production, this would be replaced with actual AI responses from the configured provider.`)):i.push(`

This is a stub response from the development provider.`),i.join(`
`)}async testConnection(){return{success:!0,message:"Stub provider is always available (development mode)"}}sendChatStream(t){return ae(this,null,function*(){let i=(yield new ee(this.sendChat(t))).split(" ");for(let r of i)yield new ee(new Promise(o=>setTimeout(o,50))),yield r+" "})}}});function _t(n){return n.trim().replace(/\/+$/,"")}function qt(n){return n.trim().replace(/\/+$/,"")}async function z(){try{let n=await figma.clientStorage.getAsync(Ut);if(n){let t=N(N({},zt),n);return t.proxyBaseUrl&&(t.proxyBaseUrl=_t(t.proxyBaseUrl)),t.internalApiUrl&&(t.internalApiUrl=qt(t.internalApiUrl)),t.connectionType||(t.connectionType="proxy"),t}}catch(n){console.warn("[Settings] Failed to load from storage:",n)}return N({},zt)}async function Ht(n){try{let t=await z(),e=N(N({},t),n);e.proxyBaseUrl&&(e.proxyBaseUrl=_t(e.proxyBaseUrl)),e.internalApiUrl&&(e.internalApiUrl=qt(e.internalApiUrl)),e.connectionType||(e.connectionType="proxy"),await figma.clientStorage.setAsync(Ut,e)}catch(t){throw console.error("[Settings] Failed to save:",t),t}}var Ut,zt,ce=v(()=>{"use strict";Ut="figmai_settings",zt={connectionType:"proxy",proxyBaseUrl:"",authMode:"shared_token",defaultModel:"gpt-4.1-mini",requestTimeoutMs:3e4}});function J(n){if(n instanceof M)switch(n.type){case"authentication":return"Authentication failed. Please check your token in Settings.";case"rate_limit":return"Rate limit exceeded. Please try again in a moment.";case"network":return`Network error: ${n.message}`;case"timeout":return"Request timeout. The server took too long to respond. Please try again.";case"invalid_request":return`Invalid request: ${n.message}`;case"provider_error":return n.statusCode&&n.statusCode>=500?`Server error (${n.statusCode}): The server encountered an error. Please try again later.`:`Provider error: ${n.message}`;default:return n.message}if(n instanceof Error)return n.message;if(n&&typeof n=="object"&&"status"in n&&"statusText"in n){let t=n;return`HTTP ${t.status}: ${t.statusText}`}if(n&&typeof n=="object")try{let t=JSON.stringify(n,null,2);return t.length>500?t.substring(0,500)+"...":t}catch(t){return String(n)}return String(n)}var M,de=v(()=>{"use strict";M=class extends Error{constructor(e,i,r,o,s){super(e);this.type=i;this.statusCode=r;this.responseBody=o;this.retryable=s;this.name="ProviderError"}isRetryable(){return this.retryable!==void 0?this.retryable:this.type==="network"||this.type==="timeout"||this.type==="provider_error"&&this.statusCode!==void 0&&this.statusCode>=500}}});function Le(n){let t=O.dev.debug;if(n==="assistant:design_critique"&&O.dev.enableDesignCritiqueDebugLogging||n==="subsystem:clipboard"&&O.dev.enableClipboardDebugLogging)return!0;if(!t.enabled)return!1;let e=t.scopes;return!!(e[n]===!0||e["assistant:*"]===!0&&n.startsWith("assistant:")||e["subsystem:*"]===!0&&n.startsWith("subsystem:")||e.global===!0)}function De(n){let t=O.dev.debug;return n==="error"?!0:t.enabled?t.levels[n]===!0:!1}function Me(n,t,e){let i=`[${n}]`,r=t==="error"?"[ERROR]":t==="warn"?"[WARN]":"";return`${i}${r?" "+r:""} ${e}`}function we(n){return{log(t,e){!Le(n)||!De("debug")||console.log(Me(n,"debug",t),e!=null?e:"")},info(t,e){!Le(n)||!De("info")||console.info(Me(n,"info",t),e!=null?e:"")},warn(t,e){!Le(n)||!De("warn")||console.warn(Me(n,"warn",t),e!=null?e:"")},error(t,e){De("error")&&console.error(Me(n,"error",t),e!=null?e:"")}}}var E,ne=v(()=>{"use strict";te();E={isEnabled(n){return Le(n)},scope(n){return we(n)},log(n,t){we("global").log(n,t)},info(n,t){we("global").info(n,t)},warn(n,t){we("global").warn(n,t)},error(n,t){we("global").error(n,t)}}});async function Bt(n,t,e){if(!(typeof AbortController!="undefined")||!e||e<=0)return fetch(n,t);let r=new AbortController,o=setTimeout(()=>r.abort(),e);try{let s={method:t.method,headers:t.headers,body:t.body,signal:r.signal};return await fetch(n,s)}finally{clearTimeout(o)}}var G,it,st,Vt=v(()=>{"use strict";ce();de();be();ne();G=class n extends M{constructor(t,e="unknown",i,r,o){super(t,e,i,r,o),this.name="ProxyError"}static fromResponse(t,e,i){let r,o;t===401||t===403?(r="authentication",o=!1):t===429?(r="rate_limit",o=!0):t>=400&&t<500?(r="invalid_request",o=!1):t>=500?(r="provider_error",o=!0):r="unknown";let s=`Proxy request failed: ${t} ${e}${i?`. ${i}`:""}`;return new n(s,r,t,i,o)}static fromNetworkError(t){return t.name==="AbortError"?new n("Request timeout. The proxy server took too long to respond.","timeout",void 0,void 0,!0):new n(`Failed to communicate with proxy: ${t.message}`,"network",void 0,void 0,!0)}},it=class{normalizeProxyBaseUrl(t){return t.trim().replace(/\/+$/,"")}async getAuthHeaders(){let t=await z(),e={"Content-Type":"application/json",Accept:"application/json"};return t.authMode==="shared_token"&&t.sharedToken?e["X-FigmAI-Token"]=t.sharedToken:t.authMode==="session_token"&&t.sessionToken&&(e.Authorization=`Bearer ${t.sessionToken}`),e}async healthCheck(){let t=await z();if(!t.proxyBaseUrl)return{success:!1,message:"Proxy base URL not configured"};let i=`${this.normalizeProxyBaseUrl(t.proxyBaseUrl)}/health`;try{let r=Date.now(),o=await Bt(i,{method:"GET",headers:{Accept:"application/json"}},5e3),s=Date.now()-r;if(o.ok){try{await o.json()}catch(a){}return{success:!0,message:`Connection successful (${s}ms)`,latency:s}}else{let a="";try{a=await o.text()}catch(l){a="Unable to read error response"}return{success:!1,message:`Connection failed: ${o.status} ${o.statusText}${a?`. ${a}`:""}`}}}catch(r){return r instanceof Error&&r.name==="AbortError"?{success:!1,message:"Connection timeout. The proxy server took too long to respond."}:{success:!1,message:`Could not connect to proxy: ${J(r)}`}}}async chat(t,e={}){var c;let i=await z();if(!i.proxyBaseUrl)throw new G("Proxy base URL not configured. Please set it in Settings.");let o=`${this.normalizeProxyBaseUrl(i.proxyBaseUrl)}/v1/chat`,s=await this.getAuthHeaders(),a={model:e.model||i.defaultModel,messages:t.map(d=>({role:d.role,content:d.content}))};e.assistantId&&(a.assistantId=e.assistantId),e.quickActionId&&(a.quickActionId=e.quickActionId);let l=e.assistantId==="design_critique"||e.quickActionId==="give-critique";l&&(a.response_format={type:"json_object"});let p=E.scope("subsystem:provider");if(l&&E.isEnabled("subsystem:provider")){let d={assistantId:e.assistantId,quickActionId:e.quickActionId,response_format:a.response_format,model:a.model,messageCount:t.length,hasSelectionSummary:!!e.selectionSummary,imageCount:((c=e.images)==null?void 0:c.length)||0};p.log("REQUEST_PAYLOAD",N({provider:"proxy"},d))}e.selectionSummary&&(a.selectionSummary=e.selectionSummary),e.images&&e.images.length>0&&(a.images=e.images.map(d=>({dataUrl:d.dataUrl,name:d.name,width:d.width,height:d.height})));try{let d=await Bt(o,{method:"POST",headers:s,body:JSON.stringify(a)},i.requestTimeoutMs);if(!d.ok){let f="";try{f=await d.text()}catch(h){f="Unable to read error response"}throw new G(`Proxy request failed: ${d.status} ${d.statusText}${f?`. ${f}`:""}`,"unknown",d.status,f)}let u;try{u=await d.json()}catch(f){try{let h=await d.text();if(h)return h}catch(h){}throw new G("Invalid response format from proxy: expected JSON or text","invalid_request",d.status)}let m=Ft(u);if(!m)throw new G("Empty response from proxy","invalid_request",d.status);if((e.assistantId==="design_critique"||e.quickActionId==="give-critique")&&E.isEnabled("subsystem:provider")){p.log("RAW_RESPONSE_HEAD",{provider:"proxy",head:m.slice(0,120)}),p.log("RAW_RESPONSE_LENGTH",{provider:"proxy",length:m.length});let f=m.trim();f=f.replace(/^```json\s*/i,"").replace(/^```\s*/i,"").replace(/\s*```$/i,"");try{JSON.parse(f),p.log("JSON_VALIDATION",{provider:"proxy",status:"PASS"})}catch(h){let S=m.substring(0,500);p.warn("Design Critique response is not valid JSON",{provider:"proxy",preview:S}),p.log("JSON_VALIDATION",{provider:"proxy",status:"FAIL",error:h instanceof Error?h.message:String(h)})}}return m}catch(d){throw d instanceof G?d:d instanceof Error?d.name==="AbortError"?new G("Request timeout. The proxy server took too long to respond.","timeout"):new G(`Failed to communicate with proxy: ${d.message}`,"network"):new G(`Failed to communicate with proxy: ${J(d)}`,"unknown")}}},st=new it});var ve,jt=v(()=>{"use strict";Vt();ce();be();ve=class{constructor(){I(this,"id","openai");I(this,"label","OpenAI");I(this,"isEnabled",!0);I(this,"capabilities",{supportsImages:!0,supportsMarkdown:!0,requiresStrictSchema:!1,maxImages:void 0})}async sendChat(t){let e=await z(),i=Oe(t,this.capabilities),r=i.messages.map(o=>({role:o.role,content:o.content}));return await st.chat(r,{model:e.defaultModel,assistantId:i.assistantId,quickActionId:i.quickActionId,selectionSummary:i.selectionSummary,images:i.images})}async testConnection(){return await st.healthCheck()}sendChatStream(t){return ae(this,null,function*(){yield yield new ee(this.sendChat(t))})}}});var Jt={};Z(Jt,{InternalApiProvider:()=>xe});async function Wt(n,t,e){if(!(typeof AbortController!="undefined")||!e||e<=0)return fetch(n,t);let r=new AbortController,o=setTimeout(()=>r.abort(),e);try{let s={method:t.method,headers:t.headers,body:t.body,signal:r.signal};return await fetch(n,s)}finally{clearTimeout(o)}}var xe,ot=v(()=>{"use strict";de();ce();ne();xe=class{constructor(){I(this,"id","internal-api");I(this,"label","Internal API");I(this,"isEnabled",!0);I(this,"capabilities",{supportsImages:!1,supportsMarkdown:!0,requiresStrictSchema:!1,maxImages:0,supportsPreambleInjection:!0})}normalizeInternalApiUrl(t){return t.trim().replace(/\/+$/,"")}cleanJsonString(t){let e=t.trim();if(!e.startsWith("{")&&!e.startsWith("["))return t;let i=e.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t");try{let r=JSON.parse(i);return r&&typeof r=="object"&&"result"in r&&typeof r.result=="string"?r.result:JSON.stringify(r)}catch(r){return t}}extractInternalApiAssistantText(t){if(!t)return null;if(typeof t=="string"){let i=t.trim();return i.length>0?this.cleanJsonString(i):null}if(typeof t!="object"||Array.isArray(t))return Array.isArray(t)?null:String(t);let e=t;if(e.Prompts&&Array.isArray(e.Prompts)&&e.Prompts.length>0){let i=e.Prompts[0];if(i&&typeof i.ResponseFromAssistant=="string")return this.cleanJsonString(i.ResponseFromAssistant)}if("result"in e&&e.result!=null){if(typeof e.result=="string")return this.cleanJsonString(e.result);if(typeof e.result=="object"&&!Array.isArray(e.result))try{return JSON.stringify(e.result,null,2)}catch(i){return String(e.result)}return Array.isArray(e.result)?null:String(e.result)}return null}async sendChat(t){let e=await z();if(!e.internalApiUrl)throw new M("Internal API URL not configured. Please set it in Settings.","invalid_request");let i=this.normalizeInternalApiUrl(e.internalApiUrl),r=t.messages.filter(l=>l.role==="user").map(l=>l.content).join(`

`);if(!r)throw new M("No user message found in request","invalid_request");let o={type:"generalChat",message:r,kbName:"figma"},s=i;E.scope("subsystem:provider").log("Sending request",{provider:"internal-api",url:s,messageLength:r.length,hasSelectionSummary:!!t.selectionSummary});try{let l=await Wt(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)},e.requestTimeoutMs);if(!l.ok){let d="";try{d=await l.text()}catch(u){d="Unable to read error response"}if(l.status===401)throw new M("Authentication failed. Please ensure you're connected to your organization network. If this persists, try using Proxy mode instead.","authentication",l.status,d,!1);if(l.status===500)throw new M("Service unavailable. The Internal API is temporarily unavailable. Please try again later or contact your administrator.","provider_error",l.status,d,!0);if(l.status===0||l.status>=400){let u=l.status===0;throw new M(u?"CORS error: The request was blocked. Please verify the origin is in manifest.json networkAccess.allowedDomains and the server allows requests from Figma.":"Could not connect to Internal API. Please check your network connection and ensure you're on your organization network.","network",l.status,d,!0)}else throw new M(`Internal API request failed: ${l.status} ${l.statusText}${d?`. ${d.substring(0,200)}`:""}`,"unknown",l.status,d)}let p,c=null;try{p=await l.json(),c=this.extractInternalApiAssistantText(p)}catch(d){try{let u=await l.text();if(u&&(c=this.extractInternalApiAssistantText(u),!c))return u}catch(u){}if(!c)throw new M("Invalid response format from Internal API: expected JSON or text","invalid_request",l.status)}if(!c){if(typeof p=="string")return p;if(p&&typeof p=="object")try{return JSON.stringify(p,null,2)}catch(u){}throw E.scope("subsystem:provider").error("Invalid response format",{provider:"internal-api",data:p}),new M("Invalid response format from Internal API: expected Prompts array or result field","invalid_request",l.status)}return c}catch(l){throw l instanceof M?l:l instanceof Error?l.name==="AbortError"?new M("Request timeout. The Internal API took too long to respond.","timeout",void 0,void 0,!0):new M(`Failed to communicate with Internal API: ${l.message}`,"network",void 0,void 0,!0):new M(`Failed to communicate with Internal API: ${J(l)}`,"unknown")}}async testConnection(t){let e=t||(await z()).internalApiUrl;if(!e)return{success:!1,message:"Internal API URL not configured"};let i=this.normalizeInternalApiUrl(e),r={type:"generalChat",message:"test",kbName:"figma"},o=await z(),s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)};try{let a=await Wt(i,s,o.requestTimeoutMs),l="",p=a.status;try{let d=await a.text();l=d.substring(0,300);try{let u=JSON.parse(d);l=JSON.stringify(u).substring(0,300)}catch(u){}}catch(d){l="Unable to read response body"}let c={url:i,method:"POST",headers:{"Content-Type":"application/json"},credentials:"none",statusCode:p,responseBody:l};return a.ok?{success:!0,message:"Connection successful. Response received.",diagnostics:c}:{success:!1,message:`Connection failed: ${a.status} ${a.statusText}`,diagnostics:c}}catch(a){let l=a instanceof Error?a.name:"Unknown",p=a instanceof Error?a.message:J(a),c=`Connection test failed: ${p}`;return l==="TypeError"&&p.includes("fetch")&&(c+=`

This is commonly caused by CORS or a missing/incorrect networkAccess.allowedDomains origin in manifest.json.`),{success:!1,message:c,diagnostics:{url:i,method:"POST",headers:{"Content-Type":"application/json"},credentials:"none",errorName:l,errorMessage:p}}}}sendChatStream(t){return ae(this,null,function*(){yield yield new ee(this.sendChat(t))})}}});var Pe,Gt=v(()=>{"use strict";de();Pe=class{constructor(){I(this,"id","claude");I(this,"label","Claude (Coming soon)");I(this,"isEnabled",!1);I(this,"capabilities",{supportsImages:!0,supportsMarkdown:!0,requiresStrictSchema:!1})}async sendChat(t){throw new M("Claude provider is not yet implemented","invalid_request")}async testConnection(){return{success:!1,message:"Claude provider is not yet implemented"}}}});var Fe,Yt=v(()=>{"use strict";de();Fe=class{constructor(){I(this,"id","copilot");I(this,"label","Copilot (Coming soon)");I(this,"isEnabled",!1);I(this,"capabilities",{supportsImages:!1,supportsMarkdown:!1,requiresStrictSchema:!0})}async sendChat(t){throw new M("Copilot provider is not yet implemented","invalid_request")}async testConnection(){return{success:!1,message:"Copilot provider is not yet implemented"}}}});async function K(n){let t=n||O.provider,e=await z();if(e.connectionType==="internal-api"&&e.internalApiUrl)return new xe;if(e.proxyBaseUrl||!e.connectionType||e.connectionType==="proxy")return new ve;switch(t){case"openai":return new ve;case"claude":return new Pe;case"copilot":return new Fe;default:return new Ae}}var Xt=v(()=>{"use strict";nt();jt();ot();Gt();Yt();te();ce()});var at,lt,Kt=v(()=>{"use strict";at={id:"ANNOTATE_SELECTION",name:"Annotate Selection",description:"Adds annotation notes near selected nodes",requiresSelection:!0,async execute(n,t){if(!(t!=null&&t.hasSelection))return"Error: Selection required for annotation tool";let e=figma.currentPage.selection;if(e.length===0)return"Error: No nodes selected";let i=n.text||"Annotation",r=[];for(let o of e){let s=figma.createText();try{await figma.loadFontAsync({family:"Inter",style:"Regular"}),s.fontName={family:"Inter",style:"Regular"},s.fontSize=12,s.characters=i,s.fills=[{type:"SOLID",color:{r:.2,g:.2,b:.2}}],s.x=o.x+o.width+10,s.y=o.y,figma.currentPage.appendChild(s),r.push(s)}catch(a){console.warn("Failed to create annotation:",a)}}return r.length>0?(figma.currentPage.selection=r,`Successfully added ${r.length} annotation(s)`):"Failed to create annotations"}},lt={id:"CREATE_CHECKLIST_FRAME",name:"Create Checklist Frame",description:"Creates a new auto-layout frame with checklist items",requiresSelection:!1,async execute(n){let t=n.items||["Item 1","Item 2","Item 3"],e=figma.createFrame();e.name="Checklist",e.layoutMode="VERTICAL",e.paddingLeft=16,e.paddingRight=16,e.paddingTop=16,e.paddingBottom=16,e.itemSpacing=8,e.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}];try{await figma.loadFontAsync({family:"Inter",style:"Regular"});for(let i of t){let r=figma.createText();r.fontName={family:"Inter",style:"Regular"},r.fontSize=14,r.characters=`\u2610 ${i}`,r.fills=[{type:"SOLID",color:{r:0,g:0,b:0}}],e.appendChild(r)}return e.x=figma.viewport.center.x-100,e.y=figma.viewport.center.y-100,figma.currentPage.appendChild(e),figma.currentPage.selection=[e],figma.viewport.scrollAndZoomIntoView([e]),`Successfully created checklist frame with ${t.length} item(s)`}catch(i){return`Error creating checklist: ${i}`}}}});function Vi(n){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return t?{r:parseInt(t[1],16)/255,g:parseInt(t[2],16)/255,b:parseInt(t[3],16)/255}:null}function Qt(n){return n.hex?Vi(n.hex):n.r!==void 0&&n.g!==void 0&&n.b!==void 0?{r:Math.max(0,Math.min(1,n.r)),g:Math.max(0,Math.min(1,n.g)),b:Math.max(0,Math.min(1,n.b))}:null}function Zt(n,t,e,i,r){if(t>12)return i.push(`${r}: Maximum depth of 12 exceeded`),!1;if(e.count>300)return i.push(`${r}: Maximum node count of 300 exceeded`),!1;if(typeof n!="object"||n===null)return i.push(`${r}: Must be an object`),!1;let o=n;if(typeof o.type!="string")return i.push(`${r}.type: Must be a string`),!1;if(!["FRAME","TEXT","RECTANGLE"].includes(o.type))return i.push(`${r}.type: Must be one of FRAME, TEXT, RECTANGLE`),!1;if(e.count++,o.type==="TEXT"){if(!o.text||typeof o.text!="object")return i.push(`${r}.text: TEXT nodes require a text object`),!1;let s=o.text;if(typeof s.value!="string")return i.push(`${r}.text.value: Must be a string`),!1;if(s.fontSize!==void 0&&(typeof s.fontSize!="number"||s.fontSize<1||s.fontSize>500))return i.push(`${r}.text.fontSize: Must be a number between 1 and 500`),!1}if(o.type==="FRAME"){if(o.layout!==void 0){if(typeof o.layout!="object"||o.layout===null)return i.push(`${r}.layout: Must be an object`),!1;if(o.layout.mode!=="AUTO_LAYOUT")return i.push(`${r}.layout.mode: Must be AUTO_LAYOUT`),!1}if(o.children!==void 0){if(!Array.isArray(o.children))return i.push(`${r}.children: Must be an array`),!1;for(let s=0;s<o.children.length;s++)Zt(o.children[s],t+1,e,i,`${r}.children[${s}]`)}}if(o.style!==void 0){if(typeof o.style!="object"||o.style===null)return i.push(`${r}.style: Must be an object`),!1;let s=o.style;if(s.fills!==void 0){if(!Array.isArray(s.fills))return i.push(`${r}.style.fills: Must be an array`),!1;for(let a=0;a<s.fills.length;a++){let l=s.fills[a];if(l.type!=="SOLID")return i.push(`${r}.style.fills[${a}].type: Must be SOLID`),!1;if(!l.color||typeof l.color!="object")return i.push(`${r}.style.fills[${a}].color: Must be an object`),!1;let p=l.color;if(!Qt(p))return i.push(`${r}.style.fills[${a}].color: Invalid color format`),!1}}if(s.radius!==void 0&&(typeof s.radius!="number"||s.radius<0||s.radius>1e3))return i.push(`${r}.style.radius: Must be a number between 0 and 1000`),!1}return!0}function en(n){let t=[],e;try{e=JSON.parse(n)}catch(i){return{ok:!1,errors:[`Invalid JSON: ${i}`]}}if(typeof e.schemaVersion!="string"?t.push("schemaVersion: Must be a string"):e.schemaVersion!=="1.0"&&t.push('schemaVersion: Must be "1.0"'),!e.root)t.push("root: Required");else{let i={count:0};Zt(e.root,0,i,t,"root")}return t.length>0?{ok:!1,errors:t,summary:`Validation failed with ${t.length} error(s)`}:{ok:!0,errors:[],summary:"Template is valid"}}function ue(n){let t=Qt(n);return t||{r:0,g:0,b:0}}var tn=v(()=>{"use strict"});async function nn(n,t,e){let i=n.type;if(t[i]||(t[i]=0),t[i]++,i==="FRAME"){let r=figma.createFrame();if(r.name=n.name||"Frame",n.layout&&(r.layoutMode=n.layout.direction==="HORIZONTAL"?"HORIZONTAL":"VERTICAL",n.layout.padding&&(r.paddingLeft=n.layout.padding.left||0,r.paddingRight=n.layout.padding.right||0,r.paddingTop=n.layout.padding.top||0,r.paddingBottom=n.layout.padding.bottom||0),n.layout.gap!==void 0&&(r.itemSpacing=n.layout.gap),n.layout.sizing&&(typeof n.layout.sizing.width=="number"&&r.resize(n.layout.sizing.width,r.height),typeof n.layout.sizing.height=="number"&&r.resize(r.width,n.layout.sizing.height))),n.style){if(n.style.fills&&n.style.fills.length>0){let o=n.style.fills[0],s=ue(o.color);r.fills=[{type:"SOLID",color:s}]}if(n.style.strokes&&n.style.strokes.length>0){let o=n.style.strokes[0],s=ue(o.color);r.strokes=[{type:"SOLID",color:s}],r.strokeWeight=o.weight||1}n.style.radius!==void 0&&(r.cornerRadius=n.style.radius)}if(n.children)for(let o of n.children){let s=await nn(o,t,e);s&&r.appendChild(s)}return e.push(r),r}if(i==="TEXT"){let r=figma.createText();if(r.name=n.name||"Text",!n.text)return null;let o=n.text.fontFamily||"Inter",s=n.text.fontStyle||"Regular";try{await figma.loadFontAsync({family:o,style:s}),r.fontName={family:o,style:s}}catch(a){try{await figma.loadFontAsync({family:"Inter",style:"Regular"}),r.fontName={family:"Inter",style:"Regular"}}catch(l){return null}}if(r.characters=n.text.value,r.fontSize=n.text.fontSize||14,n.style&&n.style.fills&&n.style.fills.length>0){let a=n.style.fills[0],l=ue(a.color);r.fills=[{type:"SOLID",color:l}]}return e.push(r),r}if(i==="RECTANGLE"){let r=figma.createRectangle();if(r.name=n.name||"Rectangle",r.resize(100,100),n.style){if(n.style.fills&&n.style.fills.length>0){let o=n.style.fills[0],s=ue(o.color);r.fills=[{type:"SOLID",color:s}]}if(n.style.strokes&&n.style.strokes.length>0){let o=n.style.strokes[0],s=ue(o.color);r.strokes=[{type:"SOLID",color:s}],r.strokeWeight=o.weight||1}n.style.radius!==void 0&&(r.cornerRadius=n.style.radius)}return e.push(r),r}return null}function ct(n){if(n.type==="FRAME"){let t={type:"FRAME",name:n.name};n.layoutMode!=="NONE"&&(t.layout={mode:"AUTO_LAYOUT",direction:n.layoutMode==="HORIZONTAL"?"HORIZONTAL":"VERTICAL",padding:{top:n.paddingTop,right:n.paddingRight,bottom:n.paddingBottom,left:n.paddingLeft},gap:n.itemSpacing,sizing:{width:n.width,height:n.height}});let e={};if(n.fills&&Array.isArray(n.fills)&&n.fills.length>0){let i=n.fills[0];i.type==="SOLID"&&(e.fills=[{type:"SOLID",color:{r:i.color.r,g:i.color.g,b:i.color.b}}])}if(n.strokes&&Array.isArray(n.strokes)&&n.strokes.length>0){let i=n.strokes[0];i.type==="SOLID"&&(e.strokes=[{type:"SOLID",color:{r:i.color.r,g:i.color.g,b:i.color.b},weight:n.strokeWeight}])}return n.cornerRadius!==void 0&&typeof n.cornerRadius=="number"&&(e.radius=n.cornerRadius),Object.keys(e).length>0&&(t.style=e),n.children&&n.children.length>0&&(t.children=n.children.map(i=>ct(i)).filter(i=>i!==null)),t}if(n.type==="TEXT"){let t={type:"TEXT",name:n.name,text:{value:n.characters,fontSize:typeof n.fontSize=="number"?n.fontSize:void 0,fontFamily:n.fontName&&typeof n.fontName!="symbol"?n.fontName.family:void 0,fontStyle:n.fontName&&typeof n.fontName!="symbol"?n.fontName.style:void 0}},e={};if(n.fills&&Array.isArray(n.fills)&&n.fills.length>0){let i=n.fills[0];i.type==="SOLID"&&(e.fills=[{type:"SOLID",color:{r:i.color.r,g:i.color.g,b:i.color.b}}])}return Object.keys(e).length>0&&(t.style=e),t}if(n.type==="RECTANGLE"){let t={type:"RECTANGLE",name:n.name},e={};if(n.fills&&Array.isArray(n.fills)&&n.fills.length>0){let i=n.fills[0];i.type==="SOLID"&&(e.fills=[{type:"SOLID",color:{r:i.color.r,g:i.color.g,b:i.color.b}}])}if(n.strokes&&Array.isArray(n.strokes)&&n.strokes.length>0){let i=n.strokes[0];i.type==="SOLID"&&(e.strokes=[{type:"SOLID",color:{r:i.color.r,g:i.color.g,b:i.color.b},weight:n.strokeWeight}])}return n.cornerRadius!==void 0&&typeof n.cornerRadius=="number"&&(e.radius=n.cornerRadius),Object.keys(e).length>0&&(t.style=e),t}return null}var dt,ut,rn=v(()=>{"use strict";tn();dt={id:"CREATE_FROM_TEMPLATE_JSON",name:"Create From Template JSON",description:"Creates Figma elements from a JSON template",requiresSelection:!1,async execute(n){let t=n.rawJson;if(!t||typeof t!="string")return"Error: rawJson parameter is required";let e=en(t);if(!e.ok)return`Validation failed:
${e.errors.join(`
`)}`;let i;try{i=JSON.parse(t)}catch(s){return"Error: Failed to parse JSON"}let r={},o=[];try{let s=await nn(i.root,r,o);if(!s)return"Error: Failed to create root node";let a=figma.viewport.center;return s.x=a.x-s.width/2,s.y=a.y-s.height/2,figma.currentPage.appendChild(s),figma.currentPage.selection=[s],figma.viewport.scrollAndZoomIntoView([s]),`Successfully created ${Object.entries(r).map(([p,c])=>`${c} ${p}${c>1?"s":""}`).join(", ")}`}catch(s){return`Error creating nodes: ${s}`}}};ut={id:"EXPORT_SELECTION_TO_TEMPLATE_JSON",name:"Export Selection to Template JSON",description:"Exports selected frames to JSON template format",requiresSelection:!0,async execute(n,t){if(!(t!=null&&t.hasSelection))return"Error: Selection required for export";let e=figma.currentPage.selection;if(e.length===0)return"Error: No nodes selected";try{let i;if(e.length>1){let o=e.map(s=>ct(s));i={schemaVersion:"1.0",meta:{name:"Export"},root:{type:"FRAME",name:"Export",children:o.filter(s=>s!==null)}}}else{let o=ct(e[0]);if(!o)return"Error: Selected node cannot be exported";i={schemaVersion:"1.0",meta:{name:o.name||"Export"},root:o}}return`JSON_EXPORT:${JSON.stringify(i,null,2)}`}catch(i){return`Error exporting: ${i}`}}}});function sn(n){return ji.get(n)}var ji,on=v(()=>{"use strict";Kt();rn();ji=new Map([[at.id,at],[lt.id,lt],[dt.id,dt],[ut.id,ut]])});async function an(n,t){let e=sn(n.name);if(!e)return`Error: Unknown tool "${n.name}"`;if(e.requiresSelection&&!(t!=null&&t.hasSelection))return`Error: Tool "${e.name}" requires a selection`;try{return await e.execute(n.arguments,t)}catch(i){return`Error executing tool "${e.name}": ${i}`}}var ln=v(()=>{"use strict";on()});function ie(n){let t=figma.currentPage.selection,e=t.length;if(e===0)return{count:0,summary:"No selection",hasSelection:!1,names:[]};let i=new Map;for(let l of t)i.set(l.id,l);let r=[];if(n&&n.length>0){for(let l of n){let p=i.get(l);p&&r.push(p.name||"Unnamed")}for(let l of t)n.includes(l.id)||r.push(l.name||"Unnamed")}else for(let l of t)r.push(l.name||"Unnamed");let o=new Map;for(let l of t){let p=l.type;o.set(p,(o.get(p)||0)+1)}let s=[];o.forEach((l,p)=>{s.push(`${l} ${p}${l>1?"s":""}`)});let a=s.join(", ");return{count:e,summary:a,hasSelection:!0,names:r}}var pt=v(()=>{"use strict"});function cn(n,t=3,e=0){let i=[];if(e>=t)return i;if(n.type==="TEXT"){let o=n.characters.trim();o.length>0&&i.push(o)}if("children"in n){let r=n;for(let o of r.children)i.push(...cn(o,t,e+1))}return i}function Wi(n){try{let t={};if(n.variantProperties&&Object.assign(t,n.variantProperties),n.componentProperties)for(let[e,i]of Object.entries(n.componentProperties))i.type==="BOOLEAN"||i.type==="TEXT"?t[e]=i.value:i.type==="INSTANCE_SWAP"?i.value&&typeof i.value=="object"&&"name"in i.value?t[e]=i.value.name:typeof i.value=="string"?t[e]=i.value:typeof i.value=="boolean"?t[e]=i.value?"True":"False":t[e]="None":i.type==="VARIANT"&&(t[e]=i.value);return Object.keys(t).length>0?t:void 0}catch(t){return}}async function Ji(n){var t;try{let e=await n.getMainComponentAsync().catch(()=>null);return O.dev.enableSyncApiErrorDetection&&console.log("[INSTANCE_DEBUG] resolveInstanceComponentName:",{nodeId:n.id,nodeName:n.name,nodeType:n.type,hasMainComponent:!!e,mainComponentName:e==null?void 0:e.name}),(t=e==null?void 0:e.name)!=null?t:null}catch(e){return O.dev.enableSyncApiErrorDetection&&console.warn("[INSTANCE_DEBUG] resolveInstanceComponentName failed:",{nodeId:n.id,nodeName:n.name,error:e instanceof Error?e.message:String(e)}),null}}async function dn(n){let t=figma.currentPage.selection,e=t.length;if(e===0)return{count:0,nodes:[]};let i=new Map;for(let p of t)i.set(p.id,p);let r=[];if(n&&n.length>0){for(let p of n){let c=i.get(p);c&&r.push(c)}for(let p of t)n.includes(p.id)||r.push(p)}else r.push(...t);let o=[];r.forEach((p,c)=>{p.type==="INSTANCE"&&o.push({node:p,index:c})});let s=await Promise.all(o.map(({node:p})=>Ji(p))),a=new Map;o.forEach(({node:p},c)=>{a.set(p.id,s[c])});let l=r.map(p=>{var d;let c={id:p.id,name:p.name||"Unnamed",type:p.type};if("width"in p&&"height"in p&&(c.width=Math.round(p.width),c.height=Math.round(p.height)),"x"in p&&"y"in p&&(c.x=Math.round(p.x),c.y=Math.round(p.y)),p.type==="TEXT"){let u=p,m=u.characters;if(c.textContent=m.substring(0,500),typeof u.fontSize=="number"&&(c.fontSize=Math.round(u.fontSize)),typeof u.fontName!="symbol"){c.fontFamily=`${u.fontName.family} ${u.fontName.style}`;let g=u.fontName.style.match(/(\d+)|(Bold|Regular|Light|Medium|SemiBold|Black|Thin)/i);g&&(c.fontWeight=g[0])}typeof u.lineHeight=="number"?c.lineHeight=Math.round(u.lineHeight*100)/100:u.lineHeight&&typeof u.lineHeight=="object"&&(u.lineHeight.unit==="AUTO"||"value"in u.lineHeight&&typeof u.lineHeight.value=="number"&&(c.lineHeight=Math.round(u.lineHeight.value*100)/100)),typeof u.letterSpacing=="object"&&u.letterSpacing.value!==void 0&&(c.letterSpacing=Math.round(u.letterSpacing.value*100)/100),typeof u.textAlignHorizontal=="string"&&(c.textAlign=u.textAlignHorizontal)}if(p.type==="FRAME"||p.type==="COMPONENT"||p.type==="INSTANCE"){let u=p;"children"in u&&(c.childCount=u.children.length);let m=cn(u,3);if(m.length>0){c.hasText=!0;let g=m.join(" ").substring(0,1e3);c.allTextContent=g,!c.textContent&&m[0]&&(c.textContent=m[0].substring(0,200))}if(u.layoutMode!=="NONE"&&(c.layoutMode=u.layoutMode,typeof u.itemSpacing=="number"&&(c.itemSpacing=Math.round(u.itemSpacing)),typeof u.paddingTop=="number"&&(c.padding={top:Math.round(u.paddingTop),right:Math.round(u.paddingRight),bottom:Math.round(u.paddingBottom),left:Math.round(u.paddingLeft)}),typeof u.primaryAxisAlignItems=="string"&&(c.primaryAxisAlignItems=u.primaryAxisAlignItems),typeof u.counterAxisAlignItems=="string"&&(c.counterAxisAlignItems=u.counterAxisAlignItems),typeof u.primaryAxisSizingMode=="string"&&(c.primaryAxisSizingMode=u.primaryAxisSizingMode),typeof u.counterAxisSizingMode=="string"&&(c.counterAxisSizingMode=u.counterAxisSizingMode)),"layoutAlign"in u&&typeof u.layoutAlign=="string"&&(c.layoutAlign=u.layoutAlign),"layoutGrow"in u&&typeof u.layoutGrow=="number"&&(c.layoutGrow=u.layoutGrow),p.type==="COMPONENT")c.isComponent=!0;else if(p.type==="INSTANCE"){c.isInstance=!0;let g=p,f=(d=a.get(g.id))!=null?d:null;f&&(c.componentName=f);let h=Wi(g);h&&(c.componentProperties=h)}}if("fills"in p&&Array.isArray(p.fills)&&p.fills.length>0){let u=[];for(let m of p.fills.slice(0,3))if(m.type==="SOLID"&&m.color){let g=Math.round(m.color.r*255),f=Math.round(m.color.g*255),h=Math.round(m.color.b*255),S=m.opacity!==void 0?Math.round(m.opacity*100)/100:1;S<1?u.push(`rgba(${g}, ${f}, ${h}, ${S})`):u.push(`rgb(${g}, ${f}, ${h})`)}u.length>0&&(c.fills=u)}if("strokes"in p&&Array.isArray(p.strokes)&&p.strokes.length>0){let u=[];for(let m of p.strokes.slice(0,2))if(m.type==="SOLID"&&m.color){let g=Math.round(m.color.r*255),f=Math.round(m.color.g*255),h=Math.round(m.color.b*255);u.push(`rgb(${g}, ${f}, ${h})`)}u.length>0&&(c.strokes=u),typeof p.strokeWeight=="number"&&(c.strokeWeight=Math.round(p.strokeWeight))}return"cornerRadius"in p&&typeof p.cornerRadius=="number"?c.cornerRadius=Math.round(p.cornerRadius):"topLeftRadius"in p&&typeof p.topLeftRadius=="number"&&(c.cornerRadius=Math.round(p.topLeftRadius)),"opacity"in p&&typeof p.opacity=="number"&&p.opacity<1&&(c.opacity=Math.round(p.opacity*100)/100),c});return{count:e,nodes:l}}function un(n){if(n.count===0)return"No selection";let t=[];t.push(`Selected ${n.count} node${n.count>1?"s":""}:`);for(let e of n.nodes){let i=[];if(i.push(`
${e.name} (${e.type})`),e.width&&e.height&&i.push(`Size: ${e.width}\xD7${e.height}px`),e.x!==void 0&&e.y!==void 0&&i.push(`Position: (${e.x}, ${e.y})`),e.textContent){let o=e.textContent.length>100?e.textContent.substring(0,100)+"...":e.textContent;i.push(`Text: "${o}"`)}else if(e.allTextContent){let o=e.allTextContent.length>100?e.allTextContent.substring(0,100)+"...":e.allTextContent;i.push(`Contains text: "${o}"`)}let r=[];if(e.fontSize&&r.push(`${e.fontSize}px`),e.fontFamily&&r.push(e.fontFamily),e.fontWeight&&r.push(`weight: ${e.fontWeight}`),e.lineHeight&&r.push(`line-height: ${e.lineHeight}`),e.letterSpacing&&r.push(`letter-spacing: ${e.letterSpacing}`),e.textAlign&&r.push(`align: ${e.textAlign}`),r.length>0&&i.push(`Typography: ${r.join(", ")}`),e.layoutMode){let o=[];o.push(`Layout: ${e.layoutMode}`),e.itemSpacing!==void 0&&o.push(`gap: ${e.itemSpacing}px`),e.padding&&o.push(`padding: ${e.padding.top}/${e.padding.right}/${e.padding.bottom}/${e.padding.left}px`),e.primaryAxisAlignItems&&o.push(`primary-align: ${e.primaryAxisAlignItems}`),e.counterAxisAlignItems&&o.push(`counter-align: ${e.counterAxisAlignItems}`),e.primaryAxisSizingMode&&o.push(`primary-sizing: ${e.primaryAxisSizingMode}`),e.counterAxisSizingMode&&o.push(`counter-sizing: ${e.counterAxisSizingMode}`),i.push(o.join(", "))}if(e.isComponent)i.push("Type: Component");else if(e.isInstance&&(i.push(`Type: Instance of "${e.componentName||"Unknown"}"`),e.componentProperties)){let o=Object.entries(e.componentProperties).map(([s,a])=>`${s}: ${String(a)}`).join(", ");o&&i.push(`Properties: ${o}`)}if(e.childCount!==void 0&&i.push(`Children: ${e.childCount}`),e.fills&&e.fills.length>0&&i.push(`Fill: ${e.fills.join(", ")}`),e.strokes&&e.strokes.length>0){let o=e.strokeWeight?`${e.strokes.join(", ")}, ${e.strokeWeight}px`:e.strokes.join(", ");i.push(`Stroke: ${o}`)}e.cornerRadius!==void 0&&i.push(`Corner radius: ${e.cornerRadius}px`),e.opacity!==void 0&&i.push(`Opacity: ${e.opacity}`),t.push(i.join(" | "))}return t.join(`
`)}var pn=v(()=>{"use strict";te()});function Gi(n){if(n.type!=="FRAME"&&n.type!=="COMPONENT"&&n.type!=="INSTANCE")return!1;let t=n;if("width"in t&&"height"in t){let e=t.width,i=t.height;if(e<10||i<10||e>1e4||i>1e4)return!1}return"children"in t?t.children.length>0:!0}function Yi(n,t,e){let i=n*t*e*e;return Math.ceil(i*4)}function Xi(n){if(n.length===0)return null;let t=[],e=[],i=[],r=[];for(let s of n)s.type==="FRAME"?t.push(s):s.type==="COMPONENT"?e.push(s):s.type==="INSTANCE"?i.push(s):r.push(s);let o=t.filter(Gi);return o.length>0?(o.sort((s,a)=>{let l="width"in s&&"height"in s?s.width*s.height:0;return("width"in a&&"height"in a?a.width*a.height:0)-l}),o[0]):t.length>0?t[0]:e.length>0?e[0]:i.length>0?i[0]:r.length>0?r[0]:n[0]}async function mn(n={}){let{maxImages:t=1,imageScale:e=2,preferFrames:i=!0,maxWidth:r=4096,maxHeight:o=4096,maxSizeBytes:s=20*1024*1024}=n,a=figma.currentPage.selection;if(a.length===0)return[];let l=[];if(i){let c=Xi(a);c?l=[c]:l=[...a]}else l=[...a];l=l.slice(0,t);let p=[];for(let c of l)try{let d,u,m=e;if("width"in c&&"height"in c){d=c.width,u=c.height;let x=d*m,k=u*m;if(x>r||k>o){let P=r/d,b=o/u;if(m=Math.min(P,b,e),m<.5){console.warn(`[Export] Node ${c.id} too large, skipping export`);continue}}if(Yi(d,u,m)>s){let P=s/4,b=Math.sqrt(P/(d*u));if(m=Math.min(m,b),m<.5){console.warn(`[Export] Node ${c.id} would exceed size limit, skipping export`);continue}}}let g=await c.exportAsync({format:"PNG",constraint:{type:"SCALE",value:m}});if(g.length>s){console.warn(`[Export] Exported image for node ${c.id} exceeds size limit (${g.length} bytes), skipping`);continue}let h=`data:image/png;base64,${figma.base64Encode(g)}`,S,w;d&&u&&(S=Math.round(d*m),w=Math.round(u*m)),p.push({dataUrl:h,name:c.name||"Unnamed",width:S,height:w}),console.log(`[Export] Successfully exported ${c.name||"Unnamed"}: ${S}x${w}px at ${m}x scale, ${Math.round(g.length/1024)}KB`)}catch(d){console.error(`[Export] Failed to export node ${c.id} (${c.name||"Unnamed"}):`,d)}return p}var gn=v(()=>{"use strict"});async function $e(n){var l,p;let{selectionOrder:t,quickAction:e,provider:i}=n,r=ie(t),o={selection:r};r.hasSelection&&(o.selectionSummary=un(await dn(t)));let s=(e==null?void 0:e.requiresVision)===!0,a=i.capabilities.supportsImages;if(s&&a&&r.hasSelection)try{let c=(l=e.maxImages)!=null?l:1,d=(p=e.imageScale)!=null?p:2,u=await mn({maxImages:c,imageScale:d,preferFrames:!0});if(u.length>0){let m=i.capabilities.maxImages;m!==void 0?o.images=u.slice(0,m):o.images=u,console.log(`[SelectionContext] Exported ${o.images.length} image(s) for vision analysis`),o.images.forEach((g,f)=>{let h=g.dataUrl.length*.75,S=g.dataUrl.substring(0,80)+"...";console.log(`[SelectionContext] Image ${f+1}: ${g.name||"Unnamed"}, ${g.width}x${g.height}, ~${Math.round(h/1024)}KB, preview: ${S}`)})}else console.warn("[SelectionContext] Vision required but no images exported - continuing with summary only")}catch(c){console.error("[SelectionContext] Failed to export images (continuing with summary only):",c)}return o}var fn=v(()=>{"use strict";pt();pn();gn()});var hn={};Z(hn,{computePlacement:()=>mt,getAbsoluteBounds:()=>yn,getAnchorBounds:()=>pe,getTopLevelContainerNode:()=>V});function V(n){let t=n;for(;t&&t.parent;){if(t.parent.type==="PAGE")return t;t=t.parent}return n}function yn(n){let t=null;if("absoluteBoundingBox"in n&&n.absoluteBoundingBox){let e=n.absoluteBoundingBox;t={x:e.x,y:e.y,width:e.width,height:e.height}}else if("absoluteRenderBounds"in n&&n.absoluteRenderBounds){let e=n.absoluteRenderBounds;t={x:e.x,y:e.y,width:e.width,height:e.height}}else if("absoluteTransform"in n&&"width"in n&&"height"in n){let e=n.absoluteTransform,i=e[0][2],r=e[1][2],o=n.width,s=n.height;typeof i=="number"&&typeof r=="number"&&typeof o=="number"&&typeof s=="number"&&!isNaN(i)&&!isNaN(r)&&!isNaN(o)&&!isNaN(s)&&o>0&&s>0&&(t={x:i,y:r,width:o,height:s})}else if("x"in n&&"y"in n&&"width"in n&&"height"in n){let e=0,i=0,r=n;for(;r&&!(!r.parent||r.parent.type==="PAGE"||r.parent.type==="DOCUMENT");){if("x"in r&&"y"in r){let l=r;e+=l.x,i+=l.y}r=r.parent}let o=n,s=o.width,a=o.height;typeof e=="number"&&typeof i=="number"&&typeof s=="number"&&typeof a=="number"&&!isNaN(e)&&!isNaN(i)&&!isNaN(s)&&!isNaN(a)&&s>0&&a>0&&(t={x:e,y:i,width:s,height:a})}return t&&t.x===0&&t.y===0&&n.parent&&n.parent.type!=="PAGE"?(console.warn(`[getAbsoluteBounds] Rejecting (0,0) bounds for node ${n.name} with parent ${n.parent.type}`),null):t}function pe(n){return yn(n)}function mt(n,t,e,i={}){var c,d,u;let r=(c=i.mode)!=null?c:"left",o=(d=i.offset)!=null?d:40,s=(u=i.minX)!=null?u:0;if(!n){let m=figma.viewport.center,g=m.x-t/2,f=m.y-e/2;return{x:Math.max(g,s),y:Math.max(f,40)}}let a,l;switch(r){case"left":a=n.x-t-o,l=n.y;break;case"right":a=n.x+n.width+o,l=n.y;break;case"above":a=n.x,l=n.y-e-o;break;case"below":a=n.x,l=n.y+n.height+o;break;case"center":a=n.x+n.width/2-t/2,l=n.y+n.height/2-e/2;break;default:a=n.x-t-o,l=n.y}return a=Math.max(a,s),l=Math.max(l,40),{x:a,y:l}}var re=v(()=>{"use strict"});async function q(){let n={regular:{family:"Inter",style:"Regular"},bold:{family:"Inter",style:"Bold"},italic:{family:"Inter",style:"Italic"},boldItalic:{family:"Inter",style:"Bold Italic"}};try{await figma.loadFontAsync(n.regular),await figma.loadFontAsync(n.bold),await figma.loadFontAsync(n.italic);try{await figma.loadFontAsync(n.boldItalic)}catch(t){n.boldItalic=n.bold}}catch(t){try{n.regular={family:"Roboto",style:"Regular"},n.bold={family:"Roboto",style:"Bold"},n.italic={family:"Roboto",style:"Italic"},n.boldItalic={family:"Roboto",style:"Bold Italic"},await figma.loadFontAsync(n.regular),await figma.loadFontAsync(n.bold),await figma.loadFontAsync(n.italic);try{await figma.loadFontAsync(n.boldItalic)}catch(e){n.boldItalic=n.bold}}catch(e){n.regular={family:"Inter",style:"Regular"},n.bold=n.regular,n.italic=n.regular,n.boldItalic=n.regular}}return n}function Sn(n,t,e,i,r){let o=figma.createFrame();return o.name=n,o.x=t,o.y=e,o.resize(i,r),o}async function y(n,t={}){var r,o;let e=await q(),i=figma.createText();return i.name="Text",i.fontName=(r=t.fontName)!=null?r:e.regular,i.fontSize=(o=t.fontSize)!=null?o:12,i.characters=n,i.textAutoResize="HEIGHT",t.fills&&(i.fills=t.fills),t.lineHeight&&(i.lineHeight=t.lineHeight),t.letterSpacing&&(i.letterSpacing=t.letterSpacing),t.textAlign&&(i.textAlignHorizontal=t.textAlign),i}function U(n,t,e={}){var r,o,s,a;let i=figma.createFrame();return i.name=n,i.layoutMode=t,i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="AUTO",e.padding&&(i.paddingTop=(r=e.padding.top)!=null?r:0,i.paddingRight=(o=e.padding.right)!=null?o:0,i.paddingBottom=(s=e.padding.bottom)!=null?s:0,i.paddingLeft=(a=e.padding.left)!=null?a:0),e.gap!==void 0&&(i.itemSpacing=e.gap),e.primaryAxisAlign&&(i.primaryAxisAlignItems=e.primaryAxisAlign),e.counterAxisAlign&&(i.counterAxisAlignItems=e.counterAxisAlign),i}var se=v(()=>{"use strict"});async function bn(n){let t=await q();await figma.loadFontAsync({family:"Inter",style:"Semi Bold"});let e=640,i=16,r=12,o=20,s=Sn("FigmAI \u2014 Scorecard",0,0,e,100);s.fills=[{type:"SOLID",color:{r:.98,g:.98,b:.98}}],s.strokes=[{type:"SOLID",color:{r:.85,g:.85,b:.85}}],s.strokeWeight=1,s.cornerRadius=8;let a=i,l=figma.createFrame();l.name="Header",l.resize(e-i*2,30),l.x=i,l.y=a,l.fills=[],s.appendChild(l);let p=await y("Design Critique",{fontSize:16,fontName:t.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});p.x=0,p.y=0,l.appendChild(p);let c=figma.createFrame();c.name="Score Badge",c.resize(80,28),c.x=e-i*2-80,c.y=1,c.cornerRadius=12;let d={r:.96,g:.62,b:.04};c.fills=[{type:"SOLID",color:{r:d.r*.15,g:d.g*.15,b:d.b*.15}}],c.strokes=[{type:"SOLID",color:d,opacity:.3}],c.strokeWeight=1;let u=await y(`${me.score}`,{fontSize:14,fontName:t.bold,fills:[{type:"SOLID",color:d}]});u.x=12,u.y=6,c.appendChild(u);let m=await y("/100",{fontSize:12,fontName:t.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});m.x=u.x+u.width+4,m.y=7,c.appendChild(m),l.appendChild(c),a+=l.height+r;let g=await y("Placeholder (no LLM)",{fontSize:11,fontName:t.italic,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});g.x=i,g.y=a,g.resize(e-i*2,g.height),s.appendChild(g),a+=g.height+o;let f=await y(me.summary,{fontSize:13,fontName:t.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});f.x=i,f.y=a,f.resize(e-i*2,f.height),s.appendChild(f),a+=f.height+o;let h=await y("Wins",{fontSize:14,fontName:{family:"Inter",style:"Semi Bold"},fills:[{type:"SOLID",color:{r:.16,g:.73,b:.51}}]});h.x=i,h.y=a,s.appendChild(h),a+=h.height+8;for(let b of me.wins){let A=await y(`\u2022 ${b}`,{fontSize:12,fontName:t.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});A.x=i,A.y=a,A.resize(e-i*2,A.height),s.appendChild(A),a+=A.height+6}a+=o-6;let S=await y("Fixes",{fontSize:14,fontName:{family:"Inter",style:"Semi Bold"},fills:[{type:"SOLID",color:{r:.96,g:.62,b:.04}}]});S.x=i,S.y=a,s.appendChild(S),a+=S.height+8;for(let b of me.fixes){let A=await y(`\u2022 ${b}`,{fontSize:12,fontName:t.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});A.x=i,A.y=a,A.resize(e-i*2,A.height),s.appendChild(A),a+=A.height+6}a+=o-6;let w=await y("Checklist",{fontSize:14,fontName:{family:"Inter",style:"Semi Bold"},fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});w.x=i,w.y=a,s.appendChild(w),a+=w.height+8;for(let b of me.checklist){let A=await y(b,{fontSize:12,fontName:t.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});A.x=i,A.y=a,A.resize(e-i*2,A.height),s.appendChild(A),a+=A.height+6}a+=o-6;let x=await y("Notes",{fontSize:14,fontName:{family:"Inter",style:"Semi Bold"},fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});x.x=i,x.y=a,s.appendChild(x),a+=x.height+8;for(let b of me.notes){let A=await y(`\u2022 ${b}`,{fontSize:12,fontName:t.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});A.x=i,A.y=a,A.resize(e-i*2,A.height),s.appendChild(A),a+=A.height+6}a+=i,s.resize(e,a);let k=n?V(n):void 0,C=k?pe(k):null,P=mt(C,s.width,s.height,{mode:"left",offset:40});s.x=P.x,s.y=P.y,figma.currentPage.appendChild(s),figma.currentPage.selection=[s],figma.viewport.scrollAndZoomIntoView([s])}var me,An=v(()=>{"use strict";re();se();me={score:82,summary:"This is a placeholder scorecard for visual design iteration. It demonstrates the scorecard layout without calling the LLM.",wins:["Clear visual hierarchy with consistent spacing","Strong color contrast meets WCAG AA standards","Interactive elements have clear affordances"],fixes:["Increase text contrast for body text (currently #666, suggest #333)","Add 8px spacing between related form fields to improve grouping","Make hover states more obvious with visual feedback"],checklist:["\u2713 Primary action is visually dominant","\u2713 Related elements are grouped using spacing","\u2717 Interactive elements need hover states","\u2713 Text is readable without zooming"],notes:["Overall solid design with room for improvement in micro-interactions","Consider adding loading states for async actions"]}});function wn(n){return n?V(n):null}function vn(n,t,e={}){var x,k,C,P;let i=(x=e.spacing)!=null?x:40,r=(k=e.side)!=null?k:"left",o=(C=e.minX)!=null?C:0,s=(P=e.minY)!=null?P:40,a=E.scope("subsystem:placement");if(!n){let b=figma.viewport.center,A=Math.max(b.x-t.width/2,o),T=Math.max(b.y-t.height/2,s);return a.log("No target bounds, using viewport center",{x:A,y:T,viewport:{x:b.x,y:b.y}}),{x:A,y:T,method:"viewport-center",reason:"no_selection"}}let l=t.width+i,p,c,d;if(r==="left")p=n.x-l,c=n.y,d=p>=o;else{p=n.x+n.width+i,c=n.y;let b=figma.viewport.bounds.width||1920;d=p+t.width<=b}if(d)return a.log("Placing on primary side",{side:r,x:p,y:c,targetBounds:{x:n.x,y:n.y,width:n.width,height:n.height}}),{x:Math.max(p,o),y:Math.max(c,s),method:r==="left"?"anchor-left":"anchor-right"};let u=r==="left"?"right":"left",m,g,f;if(u==="left")m=n.x-l,g=n.y,f=m>=o;else{m=n.x+n.width+i,g=n.y;let b=figma.viewport.bounds.width||1920;f=m+t.width<=b}if(f)return a.log("Primary side failed, using opposite side",{primarySide:r,fallbackSide:u,x:m,y:g,reason:r==="left"?"insufficient_left_space":"insufficient_right_space"}),{x:Math.max(m,o),y:Math.max(g,s),method:u==="left"?"anchor-left":"anchor-right",reason:r==="left"?"insufficient_left_space":"insufficient_right_space"};let h=figma.viewport.center,S=Math.max(h.x-t.width/2,o),w=Math.max(h.y-t.height/2,s);return a.warn("Both sides failed, using viewport center",{primarySide:r,fallbackSide:u,primaryX:p,fallbackX:m,viewportCenter:{x:S,y:w},reason:"insufficient_space_both_sides"}),{x:S,y:w,method:"viewport-center",reason:"insufficient_space_both_sides"}}function xn(n,t){n.parent!==figma.currentPage&&figma.currentPage.appendChild(n),n.x=t.x,n.y=t.y,figma.currentPage.selection=[n],figma.viewport.scrollAndZoomIntoView([n])}var Tn=v(()=>{"use strict";re();ne()});var In={};Z(In,{computeAnchorBoundsForArtifact:()=>Qi,findExistingArtifactsByType:()=>Nn,getTopLevelContainerNodeForArtifact:()=>Ki,placeArtifactFrame:()=>Te,removeExistingArtifacts:()=>Y});function Ki(n){return V(n)}function Nn(n,t,e){let i=[];function r(o){if(o.type==="FRAME"){let s=o;s.name.startsWith("FigmAI Artifact \u2014 ")&&s.getPluginData("figmai.artifactType")===t&&(e!==void 0?s.getPluginData("figmai.artifactVersion")===e&&i.push(s):i.push(s))}if("children"in o)for(let s of o.children)r(s)}return r(n),i}function Y(n,t){let e=figma.currentPage,i=Nn(e,n,t);if(n==="critique"){let o=s=>{if(s.type==="FRAME"){let a=s;if(a.name==="FigmAI \u2014 Critique"||a.name==="FigmAI \u2014 Critique (fallback)"){let l=a.getPluginData("figmai.artifactType");(l==="critique"||!l)&&i.push(a)}}if("children"in s)for(let a of s.children)o(a)};o(e)}let r=Array.from(new Set(i));for(let o of r)o.remove();if(r.length>0){let o=t?` (${t})`:"";console.log(`[Artifacts] Removed ${r.length} existing artifact(s) of type: ${n}${o}`)}}async function Te(n){let{type:t,assistant:e,selectedNode:i,width:r=640,spacing:o=40,version:s,replace:a=!0}=n;a&&Y(t,s);let l=figma.createFrame(),p=t.charAt(0).toUpperCase()+t.slice(1);s?l.name=`FigmAI Artifact \u2014 ${p} (${s})`:l.name=`FigmAI Artifact \u2014 ${p}`,l.layoutMode="VERTICAL",l.primaryAxisSizingMode="AUTO",l.counterAxisSizingMode="FIXED",l.resize(r,100),l.paddingTop=0,l.paddingRight=0,l.paddingBottom=0,l.paddingLeft=0,l.itemSpacing=0,l.setPluginData("figmai.artifactType",t),l.setPluginData("figmai.assistant",e),s&&l.setPluginData("figmai.artifactVersion",s),figma.currentPage.appendChild(l);let c=wn(i),d=c?pe(c):null,u=vn(d,{width:l.width,height:l.height},{spacing:o,side:"left",minX:0,minY:40}),m=E.scope("subsystem:placement");return u.method!=="anchor-left"&&m.log("Placement fallback used",{method:u.method,reason:u.reason,position:{x:u.x,y:u.y},targetBounds:d?{x:d.x,y:d.y,width:d.width,height:d.height}:null}),xn(l,{x:u.x,y:u.y}),l}var Qi,Ne=v(()=>{"use strict";Tn();re();ne();Qi=pe});function Zi(n,t,e){let r=60*t;return n.length<=r?n:n.substring(0,r-3)+"..."}function er(n){return!n.parent||n.parent.type!=="FRAME"?!1:n.parent.layoutMode!=="NONE"}function j(n){var t,e;if(!(n.type!=="FRAME"&&n.type!=="COMPONENT"&&n.type!=="INSTANCE"&&n.type!=="TEXT")){if(!er(n)){let i=((t=n.parent)==null?void 0:t.type)==="FRAME"?n.parent.name:"none",r=((e=n.parent)==null?void 0:e.type)==="FRAME"?n.parent.layoutMode:"NONE";console.log(`[safeSetFillX] Skipping FILL for ${n.name} (${n.type}): parent=${i}, layoutMode=${r}`);return}(n.type==="FRAME"||n.type==="COMPONENT"||n.type==="INSTANCE"||n.type==="TEXT")&&(n.layoutSizingHorizontal="FILL")}}function L(n){n.setPluginData("figmai.buildScope","scorecard_v2")}function tr(n){let t=figma.currentPage,e=[];for(let i of t.children){if(i===n)continue;if(i.getPluginData("figmai.buildScope")==="scorecard_v2"&&e.push(i),i.name==="Header"&&i.type==="FRAME"){let o=i.getPluginData("figmai.artifactType");(!o||o==="")&&e.push(i)}}for(let i of e)console.warn(`[renderScorecardV2] Removing stray node: ${i.name} (${i.id})`),i.remove();e.length>0&&console.log(`[renderScorecardV2] Cleaned up ${e.length} stray node(s)`)}async function nr(n,t,e){let i=figma.createFrame();i.name="Header",i.layoutMode="HORIZONTAL",i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="AUTO",i.primaryAxisAlignItems="SPACE_BETWEEN",i.counterAxisAlignItems="CENTER",L(i),n.appendChild(i),j(i);let r=figma.createFrame();r.name="Title Column",r.layoutMode="VERTICAL",r.primaryAxisSizingMode="AUTO",r.counterAxisSizingMode="AUTO",r.itemSpacing=4,L(r),i.appendChild(r);let o=await y("Design Critique",{fontSize:22,fontName:e.bold,fills:[{type:"SOLID",color:{r:0,g:0,b:0}}]});L(o),r.appendChild(o);let s=await y("Heuristic evaluation",{fontSize:12,fontName:e.regular,fills:[{type:"SOLID",color:{r:.42,g:.45,b:.5}}]});if(L(s),r.appendChild(s),t.score!==null){let a=figma.createFrame();a.name="Score Badge",a.layoutMode="HORIZONTAL",a.primaryAxisSizingMode="AUTO",a.counterAxisSizingMode="AUTO",a.paddingTop=6,a.paddingRight=12,a.paddingBottom=6,a.paddingLeft=12,a.cornerRadius=999,L(a),i.appendChild(a);let l,p;t.score>=85?(l={r:.91,g:.97,b:.93},p={r:.09,g:.4,b:.2}):t.score>=70?(l={r:1,g:.97,b:.93},p={r:.6,g:.2,b:.07}):(l={r:1,g:.88,b:.88},p={r:.6,g:.11,b:.11}),a.fills=[{type:"SOLID",color:l}];let c=await y(`${t.score} / 100`,{fontSize:13,fontName:e.bold,fills:[{type:"SOLID",color:p}]});L(c),a.appendChild(c)}return i}async function ir(n,t,e){if(!t.summary)return null;let i=await y(Zi(t.summary,3,14),{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:{r:.07,g:.09,b:.15}}]});return L(i),n.appendChild(i),j(i),i}async function rr(n,t,e){let i=figma.createFrame();if(i.name="Two Column Body",i.layoutMode="HORIZONTAL",i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="AUTO",i.itemSpacing=16,L(i),n.appendChild(i),j(i),t.wins.length>0){let r=await Cn("Wins",t.wins.slice(0,4),t.wins.length,e,i);j(r)}if(t.fixes.length>0){let r=await Cn("Fixes",t.fixes.slice(0,4),t.fixes.length,e,i);j(r)}return i}async function sr(n,t,e){if(t.checklist.length===0)return null;let i=figma.createFrame();i.name="Checklist",i.layoutMode="VERTICAL",i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="AUTO",i.itemSpacing=8,L(i),n.appendChild(i),j(i);let r=await y("Checklist",{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:0,g:0,b:0}}]});L(r),i.appendChild(r);let o=t.checklist.slice(0,5);for(let s of o){let a=figma.createFrame();a.name="Checklist Row",a.layoutMode="HORIZONTAL",a.primaryAxisSizingMode="AUTO",a.counterAxisSizingMode="AUTO",a.itemSpacing=8,a.counterAxisAlignItems="CENTER",L(a),i.appendChild(a),j(a);let l=s.trim().startsWith("\u2713")||s.trim().startsWith("\u2714"),p=l?"\u2713":"\u2715",c=s.replace(/^[]\s*/,"").trim(),d=await y(p,{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:l?{r:.16,g:.73,b:.51}:{r:.94,g:.27,b:.27}}]});L(d),a.appendChild(d);let u=await y(c,{fontSize:13,fontName:e.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});L(u),a.appendChild(u),j(u)}if(t.checklist.length>5){let s=await y(`+ ${t.checklist.length-5} more`,{fontSize:12,fontName:e.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});L(s),i.appendChild(s)}return i}async function or(n,t,e){if(!t.notes||t.notes.length===0)return null;let i=figma.createFrame();i.name="Notes",i.layoutMode="VERTICAL",i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="AUTO",i.itemSpacing=6,L(i),n.appendChild(i),j(i);let r=await y("Notes",{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});L(r),i.appendChild(r);let o=t.notes.slice(0,2);for(let s of o){let a=await y(`\u2022 ${s}`,{fontSize:13,fontName:e.regular,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});L(a),i.appendChild(a),j(a)}return i}async function Cn(n,t,e,i,r){let o=figma.createFrame();o.name=n,o.layoutMode="VERTICAL",o.primaryAxisSizingMode="AUTO",o.counterAxisSizingMode="AUTO",o.itemSpacing=8,L(o),r.appendChild(o);let s=await y(n,{fontSize:14,fontName:i.bold,fills:[{type:"SOLID",color:{r:0,g:0,b:0}}]});L(s),o.appendChild(s);let a=figma.createFrame();a.name="Divider",a.layoutMode="HORIZONTAL",a.primaryAxisSizingMode="AUTO",a.counterAxisSizingMode="FIXED",a.resize(100,1),a.fills=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],L(a),o.appendChild(a),j(a);for(let l of t){let p=await y(`\u2022 ${l}`,{fontSize:13,fontName:i.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});L(p),o.appendChild(p),j(p)}if(e>4){let l=await y(`+ ${e-4} more`,{fontSize:12,fontName:i.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});L(l),o.appendChild(l)}return o}async function gt(n,t,e){let i=(e==null?void 0:e.runId)||"unknown",r=O.dev.enableDesignCritiqueDebugLogging,o=await q();if(await figma.loadFontAsync({family:"Inter",style:"Semi Bold"}),n.layoutMode="VERTICAL",n.paddingTop=20,n.paddingRight=20,n.paddingBottom=20,n.paddingLeft=20,n.itemSpacing=16,n.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],n.strokes=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],n.strokeWeight=1,n.cornerRadius=16,r&&console.log("[buildScorecardContent] Building header..."),await nr(n,t,o),r&&console.log("[buildScorecardContent] Header built, root.children:",n.children.map(a=>a.name)),t.summary&&(r&&console.log("[buildScorecardContent] Building summary..."),await ir(n,t,o),r&&console.log("[buildScorecardContent] Summary built, root.children:",n.children.map(a=>a.name))),(t.wins.length>0||t.fixes.length>0)&&(r&&console.log("[buildScorecardContent] Building two-column body..."),await rr(n,t,o),r&&console.log("[buildScorecardContent] Two-column body built, root.children:",n.children.map(a=>a.name))),t.checklist.length>0&&(r&&console.log("[buildScorecardContent] Building checklist..."),await sr(n,t,o),r&&console.log("[buildScorecardContent] Checklist built, root.children:",n.children.map(a=>a.name))),t.notes&&t.notes.length>0&&(r&&console.log("[buildScorecardContent] Building notes..."),await or(n,t,o),r&&console.log("[buildScorecardContent] Notes built, root.children:",n.children.map(a=>a.name))),n.children.length===0)throw new Error("v2 scorecard rendered empty - no children appended to root");r&&(console.log("[buildScorecardContent] \u2705 Build complete, root.children:",n.children.map(a=>a.name)),console.log("[buildScorecardContent] Root has",n.children.length,"direct children")),tr(n);let s=figma.currentPage;for(let a of s.children)if(a!==n&&a.name==="Header"&&a.type==="FRAME"){let l=a.getPluginData("figmai.artifactType");(!l||l==="")&&(console.error(`[buildScorecardContent] \u274C Found stray Header node at page root: ${a.id}`),a.remove())}}async function kn(n,t,e){let i=(e==null?void 0:e.runId)||"unknown";O.dev.enableDesignCritiqueDebugLogging&&console.log(`[DC ${i}] renderScorecardV2 ENTER`);let o=null;try{return o=await Te({type:"scorecard",assistant:"design_critique",selectedNode:t,width:560,spacing:40,version:"v2",replace:!0}),await gt(o,n,e),figma.currentPage.selection=[o],figma.viewport.scrollAndZoomIntoView([o]),console.log(`[DC ${i}] renderScorecardV2 EXIT`,{childCount:o.children.length,rootName:o.name,rootId:o.id}),o}catch(s){if(console.error("[renderScorecardV2] Error during render:",s),o)try{o.remove(),console.log("[renderScorecardV2] Removed root frame due to error")}catch(p){console.error("[renderScorecardV2] Failed to remove root:",p)}let a=figma.currentPage,l=[];for(let p of a.children)p.getPluginData("figmai.buildScope")==="scorecard_v2"&&l.push(p);for(let p of l)try{p.remove(),console.log(`[renderScorecardV2] Removed stray node: ${p.name}`)}catch(c){console.error(`[renderScorecardV2] Failed to remove stray node ${p.name}:`,c)}throw s}}var ft=v(()=>{"use strict";Ne();se();te()});async function ar(n){try{let t=await n.getMainComponentAsync().catch(()=>null);return O.dev.enableSyncApiErrorDetection&&console.log("[INSTANCE_DEBUG] resolveInstanceMainComponent:",{nodeId:n.id,nodeName:n.name,nodeType:n.type,hasMainComponent:!!t,mainComponentName:t==null?void 0:t.name,mainComponentKey:t==null?void 0:t.key}),t}catch(t){return O.dev.enableSyncApiErrorDetection&&console.warn("[INSTANCE_DEBUG] resolveInstanceMainComponent failed:",{nodeId:n.id,nodeName:n.name,error:t instanceof Error?t.message:String(t)}),null}}async function En(n){let t=n;for(;t;){if(t.type==="INSTANCE"){let e=t,i=await ar(e);if(i){let r=e.variantProperties&&Object.keys(e.variantProperties).length>0?Object.fromEntries(Object.entries(e.variantProperties).map(([o,s])=>[o,typeof s=="string"?s:String(s)])):void 0;return{kind:"instance",name:i.name,key:i.key,variantProperties:r}}}else if(t.type==="COMPONENT"){let e=t;return{kind:"component",name:e.name,key:e.key}}else if(t.type==="COMPONENT_SET"){let e=t;return{kind:"componentSet",name:e.name,key:e.key}}if(t.parent){if(t.parent.type==="PAGE"||t.parent.type==="DOCUMENT")break;if("visible"in t.parent)t=t.parent;else break}else break}return{kind:"custom",name:"Custom"}}function yt(n){try{let t=figma.fileKey;if(!t)return`figma://node-id=${n.replace(/:/g,"-")}`;let e=encodeURIComponent(n);return`https://www.figma.com/file/${t}?node-id=${e}`}catch(t){return console.warn("[Scanner] Failed to build canonical Figma URL:",t),`figma://node-id=${n.replace(/:/g,"-")}`}}function lr(n){return[...n].sort((t,e)=>{let i=t.y-e.y;return Math.abs(i)>1?i:t.x-e.x})}function Rn(n,t){let e=n.name.toLowerCase(),i=n.characters.toLowerCase();if(e.includes("error")||i.includes("error")||e.includes("invalid"))return"Error";if(e.includes("cta")||e.includes("button")||e.includes("action"))return"CTA";if(e.includes("headline")||e.includes("title")||e.includes("heading"))return"Headline";if(e.includes("placeholder")||i.includes("enter")||i.includes("type"))return"Placeholder";if(e.includes("tooltip")||e.includes("hint"))return"Tooltip";if(e.includes("helper")||e.includes("help")||e.includes("description"))return"Helper";if(e.includes("body")||e.includes("text")||e.includes("content"))return"Body"}function On(n){try{return new RegExp(n)}catch(t){return console.warn(`[ContentTable] Invalid regex pattern ignored: "${n}"`,t),null}}function Dn(n,t,e){if(!e)return!1;if(e.nodeNamePatterns&&e.nodeNamePatterns.length>0)for(let i of e.nodeNamePatterns){let r=On(i);if(r&&r.test(n.name))return!0}if(e.nodeIdPrefixes&&e.nodeIdPrefixes.length>0){for(let i of e.nodeIdPrefixes)if(n.id.startsWith(i))return!0}if(e.componentKeyAllowlist&&e.componentKeyAllowlist.length>0&&(!t.key||!e.componentKeyAllowlist.includes(t.key))||e.componentKeyDenylist&&e.componentKeyDenylist.length>0&&t.key&&e.componentKeyDenylist.includes(t.key))return!0;if(e.textValuePatterns&&e.textValuePatterns.length>0)for(let i of e.textValuePatterns){let r=On(i);if(r&&r.test(n.characters))return!0}return!1}function Mn(n){if(!n||n.trim().length===0)return n;let t=/\r\n|\r|\n/,e=n.split(t),i=`
`;n.includes(`\r
`)?i=`\r
`:n.includes("\r")?i="\r":n.includes(`
`)&&(i=`
`);function r(g){let f=g.match(/^\s*\d+\s*[\.\)\-]\s*(.+)$/);return f!==null&&f[1].trim().length>0}function o(g){let f=g.match(/^\s*[\-\*]\s*(.+)$/);return f!==null&&f[1].trim().length>0}function s(g){let f=g.match(/^\s*\d+\s*[\.\)\-]\s*(.+)$/);return f?f[1].trimStart():null}function a(g){let f=g.match(/^\s*[\-\*]\s*(.+)$/);return f?f[1].trimStart():null}let l=0;for(let g of e)(r(g)||o(g))&&l++;let p=e.filter(g=>g.trim().length>0),c=l===0&&p.length>=3&&e.length>=3;return l>=2||c?e.map((g,f)=>{let h=s(g);if(h!==null&&h.length>0)return`- ${h}`;let S=a(g);return S!==null&&S.length>0?`- ${S}`:c&&g.trim().length>0&&f>0?`- ${g.trimStart()}`:g}).join(i):n}async function Ln(n,t,e=[],i=null,r,o=new Map,s={}){var l,p,c;if(!n.visible)return;let a=null;if(r)if(o.has(n.id))a=(l=o.get(n.id))!=null?l:null;else{let d=n.type;if(d==="FRAME"||d==="INSTANCE"||d==="COMPONENT"||d==="COMPONENT_SET"||d==="TEXT")try{a=r(n)}catch(u){console.warn(`[ContentTable] Design system detection failed for node ${n.id}:`,u),a=null}o.set(n.id,a),a&&a.isDesignSystem&&(s[n.id]=a)}if(n.type==="TEXT"){let d=n,u=await En(d);if(Dn(d,u,i))return;let m=e.length>0?e.join(" / "):d.name,g=yt(d.id),f=Rn(d,m),h=(p=o.get(d.id))!=null?p:null,S={id:d.id,nodeId:d.id,nodeUrl:g,component:u,field:{label:d.name,path:m,role:f},content:{type:"text",value:Mn(d.characters)},textLayerName:d.name,meta:{visible:d.visible!==!1,locked:d.locked===!0},notes:"",contentKey:"",jiraTicket:"",adaNotes:"",errorMessage:f==="Error"?d.characters:"",designSystem:h&&h.isDesignSystem?h:void 0};t.push(S)}if("children"in n){let d=lr(n.children);for(let u of d)if(u.visible){if(u.type==="TEXT"){let m=u,g=await En(m);if(Dn(m,g,i))continue;let f=null;if(r)if(o.has(m.id))f=(c=o.get(m.id))!=null?c:null;else{try{f=r(m)}catch(C){console.warn(`[ContentTable] Design system detection failed for node ${m.id}:`,C),f=null}o.set(m.id,f),f&&f.isDesignSystem&&(s[m.id]=f)}let S=[...e,m.name].join(" / "),w=yt(m.id),x=Rn(m,S),k={id:m.id,nodeId:m.id,nodeUrl:w,component:g,field:{label:m.name,path:S,role:x},content:{type:"text",value:Mn(m.characters)},textLayerName:m.name,meta:{visible:m.visible!==!1,locked:m.locked===!0},notes:"",contentKey:"",jiraTicket:"",adaNotes:"",errorMessage:x==="Error"?m.characters:"",designSystem:f&&f.isDesignSystem?f:void 0};t.push(k)}else if("children"in u){let m=[...e,u.name];await Ln(u,t,m,i,r,o,s)}}}}async function cr(n){try{let e="width"in n?n.width:100,i=Math.min(1,100/e),r=await n.exportAsync({format:"PNG",constraint:{type:"SCALE",value:i}});return`data:image/png;base64,${figma.base64Encode(r)}`}catch(t){console.warn("[Scanner] Failed to export thumbnail:",t);return}}async function Pn(n,t=null,e){let i=n.parent,r=i&&i.type==="PAGE"?i.name:"Unknown Page",o=i&&i.type==="PAGE"?i.id:"",s=[],a=new Map,l={};await Ln(n,s,[n.name],t,e,a,l);let p=await cr(n),c=yt(n.id),d={contentModel:"Universal v2",contentStage:"Draft",adaStatus:"\u23F3 Pending",legalStatus:"\u23F3 Pending",lastUpdated:new Date().toISOString(),version:"v1",rootNodeId:n.id,rootNodeName:n.name,rootNodeUrl:c,thumbnailDataUrl:p},u={type:"universal-content-table",version:1,generatedAtISO:new Date().toISOString(),source:{pageId:o,pageName:r,selectionNodeId:n.id,selectionName:n.name},meta:d,items:s};return Object.keys(l).length>0&&(u.designSystemByNodeId=l),u}var Fn=v(()=>{"use strict";te()});function Ie(){return{confluenceApi:void 0,createConfluence:void 0,designSystem:void 0,auth:void 0,getContentTableIgnoreRules:void 0,detectDesignSystemComponent:void 0,postProcessContentTable:void 0}}var ht=v(()=>{"use strict"});var $n={};Z($n,{default:()=>ur});var dr,ur,zn=v(()=>{"use strict";ht();dr=Ie(),ur=dr});async function Un(){try{let n=await Promise.resolve().then(()=>(zn(),$n));return n.default&&typeof n.default=="object"?n.default:"createWorkAdapter"in n&&typeof n.createWorkAdapter=="function"?n.createWorkAdapter():Ie()}catch(n){return Ie()}}var _n=v(()=>{"use strict";ht()});function qn(n){let t=[],e=[];if(!n||typeof n!="object")return e.push("Table is not an object"),{ok:!1,warnings:t,errors:e};let i=n;if(i.type!=="universal-content-table"&&e.push('Missing or invalid type field (must be "universal-content-table")'),(typeof i.version!="number"||i.version!==1)&&e.push("Missing or invalid version field (must be 1)"),(!i.generatedAtISO||typeof i.generatedAtISO!="string")&&e.push("Missing or invalid generatedAtISO field"),!i.source||typeof i.source!="object")e.push("Missing or invalid source field");else{let o=i.source;typeof o.pageId!="string"&&e.push("source.pageId is missing or invalid"),typeof o.pageName!="string"&&e.push("source.pageName is missing or invalid"),typeof o.selectionNodeId!="string"&&e.push("source.selectionNodeId is missing or invalid"),typeof o.selectionName!="string"&&e.push("source.selectionName is missing or invalid")}if(!i.meta||typeof i.meta!="object")e.push("Missing or invalid meta field");else{let o=i.meta,s=["contentModel","contentStage","adaStatus","legalStatus","lastUpdated","version","rootNodeId","rootNodeName","rootNodeUrl"];for(let a of s)typeof o[a]!="string"&&e.push(`meta.${a} is missing or invalid`)}return Array.isArray(i.items)?(i.items.forEach((o,s)=>{if(!o||typeof o!="object"){e.push(`items[${s}] is not an object`);return}let a=o,l=["id","nodeId","nodeUrl","component","field","content","meta"];for(let p of l)p in a||e.push(`items[${s}].${p} is missing`);if(a.component&&typeof a.component=="object"){let p=a.component;typeof p.kind!="string"&&e.push(`items[${s}].component.kind is missing or invalid`),typeof p.name!="string"&&e.push(`items[${s}].component.name is missing or invalid`)}if(a.field&&typeof a.field=="object"){let p=a.field;typeof p.label!="string"&&e.push(`items[${s}].field.label is missing or invalid`),typeof p.path!="string"&&e.push(`items[${s}].field.path is missing or invalid`)}if(a.content&&typeof a.content=="object"){let p=a.content;p.type!=="text"&&e.push(`items[${s}].content.type is missing or invalid (must be "text")`),typeof p.value!="string"&&e.push(`items[${s}].content.value is missing or invalid`)}if(a.meta&&typeof a.meta=="object"){let p=a.meta;typeof p.visible!="boolean"&&e.push(`items[${s}].meta.visible is missing or invalid`),typeof p.locked!="boolean"&&e.push(`items[${s}].meta.locked is missing or invalid`)}}),i.designSystemByNodeId!==void 0&&(typeof i.designSystemByNodeId!="object"||Array.isArray(i.designSystemByNodeId)||i.designSystemByNodeId===null)&&e.push("designSystemByNodeId must be an object map (Record<string, DesignSystemDetectionResult>)"),pr&&(t.length>0&&console.warn("[ContentTableValidation] Warnings:",t),e.length>0&&console.error("[ContentTableValidation] Errors:",e)),{ok:e.length===0,warnings:t,errors:e}):(e.push("items is not an array"),{ok:e.length===0,warnings:t,errors:e})}function Hn(n){var e,i;let t=JSON.parse(JSON.stringify(n));return Array.isArray(t.items)||(t.items=[]),t.meta||(t.meta={contentModel:"Universal v2",contentStage:"Draft",adaStatus:"\u23F3 Pending",legalStatus:"\u23F3 Pending",lastUpdated:new Date().toISOString(),version:"v1",rootNodeId:((e=t.source)==null?void 0:e.selectionNodeId)||"",rootNodeName:((i=t.source)==null?void 0:i.selectionName)||"",rootNodeUrl:""}),t.source||(t.source={pageId:"",pageName:"Unknown Page",selectionNodeId:"",selectionName:"Unknown Selection"}),t.items=t.items.map((r,o)=>{let s=N({},r);return s.id||(s.id=s.nodeId||`item_${o}`),s.nodeId||(s.nodeId=s.id),s.nodeUrl||(s.nodeUrl=""),s.component?s.component={kind:s.component.kind||"custom",name:s.component.name||"Unknown Component",key:s.component.key,variantProperties:s.component.variantProperties}:s.component={kind:"custom",name:"Unknown Component"},s.field?s.field={label:s.field.label||"Unknown Field",path:s.field.path||"",role:s.field.role}:s.field={label:"Unknown Field",path:""},s.content?s.content={type:s.content.type||"text",value:s.content.value||""}:s.content={type:"text",value:""},s.meta?s.meta={visible:typeof s.meta.visible=="boolean"?s.meta.visible:!0,locked:typeof s.meta.locked=="boolean"?s.meta.locked:!1}:s.meta={visible:!0,locked:!1},s.textLayerName=s.textLayerName,s.notes=s.notes,s.contentKey=s.contentKey,s.jiraTicket=s.jiraTicket,s.adaNotes=s.adaNotes,s.errorMessage=s.errorMessage,s.designSystem=s.designSystem,s}),t.designSystemByNodeId!==void 0&&t.designSystemByNodeId!==null&&(typeof t.designSystemByNodeId!="object"||Array.isArray(t.designSystemByNodeId))&&delete t.designSystemByNodeId,t}var pr,Bn=v(()=>{"use strict";te();pr=O.dev.enableContentTableValidationLogging});var ze,Vn=v(()=>{"use strict";Fn();_n();Bn();ze=class{canHandle(t,e){return t==="content_table"&&e==="generate-table"}async handleResponse(t){var s;let{selectionOrder:e,sendAssistantMessage:i,replaceStatusMessage:r}=t;if(e.length===0){let a="Select a single container to scan.";return r(a,!0),figma.notify(a),{handled:!0}}if(e.length>1){let a="Only one selection allowed. Select a single container.";return r(a,!0),figma.notify(a),{handled:!0}}let o=await figma.getNodeByIdAsync(e[0]);if(!o){let a="Selected node not found.";return r(a,!0),figma.notify(a),{handled:!0}}if(o.type==="DOCUMENT"||o.type==="PAGE"){let a="Please select a container (frame, component, etc.), not a page or document.";return r(a,!0),figma.notify(a),{handled:!0}}try{let a=await Un(),l=((s=a.getContentTableIgnoreRules)==null?void 0:s.call(a))||null,p=a.detectDesignSystemComponent,c=await Pn(o,l,p);if(a.postProcessContentTable)try{let m={pageId:c.source.pageId,pageName:c.source.pageName,rootNodeId:c.meta.rootNodeId};c=await a.postProcessContentTable({table:c,selectionContext:m}),console.log("[ContentTableHandler] Content table post-processed by Work adapter")}catch(m){console.error("[ContentTableHandler] Error in postProcessContentTable hook:",m)}c=Hn(c);let d=qn(c);!d.ok&&d.errors.length>0&&console.error("[ContentTableHandler] Content table validation errors:",d.errors),d.warnings.length>0&&console.warn("[ContentTableHandler] Content table validation warnings:",d.warnings);let u=c.items.length;return r(u===0?"No text items found in the selected container.":`Found ${u} text item${u===1?"":"s"}. Table generated.`),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_GENERATED",table:c}}),console.log("[ContentTableHandler] Content table generated:",u,"items"),{handled:!0}}catch(a){let l=a instanceof Error?a.message:"Unknown error";return r(`Error: ${l}`,!0),figma.notify(`Error generating table: ${l}`),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_ERROR",error:l}}),{handled:!0}}}}});function ge(n){let t=n.trim();try{let c=JSON.parse(t);if(typeof c=="object"&&c!==null)return t}catch(c){}let e=t.match(/```(?:json)?\s*([\s\S]*?)```/);if(e&&e[1]){let c=e[1].trim();try{return JSON.parse(c),c}catch(d){}}let i=t.indexOf("{");if(i===-1)return null;let r=0,o=!1,s=!1,a=i,l=-1;for(let c=i;c<t.length;c++){let d=t[c];if(s){s=!1;continue}if(d==="\\"){s=!0;continue}if(d==='"'){o=!o;continue}if(!o){if(d==="{")r++;else if(d==="}"&&(r--,r===0)){l=c;break}}}if(r!==0||l===-1)return null;let p=t.substring(a,l+1).trim();try{return JSON.parse(p),p}catch(c){return null}}function St(n,t=!1){var p,c,d;let e=E.scope("subsystem:parsing"),i=n.trim(),r=t||E.isEnabled("subsystem:parsing");r&&e.log("Raw response",{head:i.substring(0,500)});let o=ge(i);if(!o){let u=i.match(/```(?:json)?\s*([\s\S]*?)```/)?"code fence":"balanced JSON";return r&&e.log("Failed to extract JSON",{method:u}),{error:"No valid JSON object found in response"}}if(r){let u=i.startsWith("{")?"direct":i.match(/```(?:json)?\s*([\s\S]*?)```/)?"code fence":"balanced";e.log("JSON extracted",{method:u})}let s;try{s=JSON.parse(o)}catch(u){return r&&e.error("JSON parse error",{error:u instanceof Error?u.message:String(u)}),{error:"JSON parse error: "+(u instanceof Error?u.message:String(u))}}r&&e.log("Parsed top-level keys",{keys:Object.keys(s)});let a=(p=s.score)!=null?p:s.overallScore;if(a==null)return r&&e.log("Validation failure: Missing score field"),{error:"Missing required field: score"};if(typeof a!="number")return r&&e.log("Validation failure: score is not a number",{type:typeof a,score:a}),{error:"Invalid score: must be a number"};if(a<0||a>100)return r&&e.log("Validation failure: score out of range",{score:a}),{error:`Invalid score: must be between 0 and 100, got ${a}`};if(!Array.isArray(s.wins))return r&&e.log("Validation failure: wins is not an array",{type:typeof s.wins}),{error:"Missing or invalid wins: must be an array"};if(!Array.isArray(s.fixes))return r&&e.log("Validation failure: fixes is not an array",{type:typeof s.fixes}),{error:"Missing or invalid fixes: must be an array"};let l={score:a,summary:typeof s.summary=="string"?s.summary:"",wins:s.wins.map(u=>String(u)),fixes:s.fixes.map(u=>String(u)),checklist:Array.isArray(s.checklist)?s.checklist.map(u=>String(u)):[],notes:Array.isArray(s.notes)?s.notes.map(u=>String(u)):void 0};return r&&e.log("Validation passed",{score:l.score,wins:l.wins.length,fixes:l.fixes.length,checklist:l.checklist.length,notes:(d=(c=l.notes)==null?void 0:c.length)!=null?d:0}),{data:l}}var Ue=v(()=>{"use strict";ne()});function Wn(n,t=!1){let e=t?E.scope("normalize:deceptive_report"):null;if(!n||typeof n!="string"){let d="Invalid response: response is not a string";return e==null||e.error("Parse failed",{error:d}),{error:d}}let i=n.trim();if(!i){let d="Invalid response: response is empty";return e==null||e.error("Parse failed",{error:d}),{error:d}}let r=ge(i);if(!r){let d="No valid JSON found in response";return e==null||e.error("Parse failed",{error:d,responseHead:i.substring(0,200)}),{error:d}}e==null||e.log("Extracted JSON",{jsonString:r.substring(0,200)});let o;try{o=JSON.parse(r)}catch(d){let u=`JSON parse error: ${d instanceof Error?d.message:String(d)}`;return e==null||e.error("Parse failed",{error:u,jsonString:r.substring(0,200)}),{error:u}}if(!o||typeof o!="object"||Array.isArray(o)){let d="Invalid response: root must be an object";return e==null||e.error("Parse failed",{error:d}),{error:d}}let s=o;if(typeof s.summary!="string"){let d="Invalid response: summary must be a string";return e==null||e.error("Parse failed",{error:d}),{error:d}}if(!["None","Low","Medium","High"].includes(s.overallSeverity)){let d='Invalid response: overallSeverity must be "None", "Low", "Medium", or "High"';return e==null||e.error("Parse failed",{error:d,overallSeverity:s.overallSeverity}),{error:d}}if(!Array.isArray(s.findings)){let d="Invalid response: findings must be an array";return e==null||e.error("Parse failed",{error:d}),{error:d}}let a=[];for(let d=0;d<s.findings.length;d++){let u=s.findings[d];if(!u||typeof u!="object"||Array.isArray(u)){e==null||e.warn("Invalid finding skipped",{index:d});continue}let m=u;if(typeof m.category!="string"||!["Low","Medium","High"].includes(m.severity)||typeof m.description!="string"||typeof m.whyDeceptive!="string"||typeof m.userHarm!="string"||typeof m.remediation!="string"){e==null||e.warn("Invalid finding skipped",{index:d,finding:m});continue}a.push({category:m.category,severity:m.severity,description:m.description,whyDeceptive:m.whyDeceptive,userHarm:m.userHarm,remediation:m.remediation,evidence:typeof m.evidence=="string"?m.evidence:void 0})}if(!Array.isArray(s.dimensionsChecklist)){let d="Invalid response: dimensionsChecklist must be an array";return e==null||e.error("Parse failed",{error:d}),{error:d}}if(s.dimensionsChecklist.length!==10){let d=`Invalid response: dimensionsChecklist must contain exactly 10 items, got ${s.dimensionsChecklist.length}`;return e==null||e.error("Parse failed",{error:d,count:s.dimensionsChecklist.length}),{error:d}}let l=new Set,p=[];for(let d=0;d<s.dimensionsChecklist.length;d++){let u=s.dimensionsChecklist[d];if(!u||typeof u!="object"||Array.isArray(u)){let g=`Invalid response: dimensionsChecklist[${d}] must be an object`;return e==null||e.error("Parse failed",{error:g}),{error:g}}let m=u;if(typeof m.dimension!="string"||typeof m.passed!="boolean"){let g=`Invalid response: dimensionsChecklist[${d}] must have dimension (string) and passed (boolean)`;return e==null||e.error("Parse failed",{error:g,check:m}),{error:g}}if(!jn.includes(m.dimension)){let g=`Invalid response: unknown dimension "${m.dimension}" in checklist`;return e==null||e.error("Parse failed",{error:g,dimension:m.dimension}),{error:g}}if(l.has(m.dimension)){let g=`Invalid response: duplicate dimension "${m.dimension}" in checklist`;return e==null||e.error("Parse failed",{error:g,dimension:m.dimension}),{error:g}}l.add(m.dimension),p.push({dimension:m.dimension,passed:m.passed})}for(let d of jn)if(!l.has(d)){let u=`Invalid response: missing dimension "${d}" in checklist`;return e==null||e.error("Parse failed",{error:u,missingDimension:d}),{error:u}}let c={summary:s.summary,overallSeverity:s.overallSeverity,findings:a,dimensionsChecklist:p};return e==null||e.log("Parse success",{summaryLength:c.summary.length,overallSeverity:c.overallSeverity,findingsCount:c.findings.length,dimensionsChecklistCount:c.dimensionsChecklist.length}),{data:c}}var jn,Jn=v(()=>{"use strict";Ue();ne();jn=["Forced Action","Nagging","Obstruction","Sneaking","Interface Interference","False Urgency/Scarcity","Confirmshaming","Trick Questions","Hidden Subscription/Roach Motel","Misleading Defaults"]});var Gn={};Z(Gn,{ScorecardComponent:()=>_e,scorecardComponent:()=>mr});var _e,mr,Yn=v(()=>{"use strict";ft();_e=class{getDefaultWidth(){return 560}async render(t){let{root:e,data:i}=t;if(!i||typeof i!="object")throw new Error("ScorecardComponent requires ScorecardData object");let r=i,o=t.options.debug;await gt(e,r,o)}},mr=new _e});var Xn={};Z(Xn,{DeceptiveReportComponent:()=>qe,deceptiveReportComponent:()=>gr});var qe,gr,Kn=v(()=>{"use strict";se();qe=class{getDefaultWidth(){return 600}async render(t){var p;let{root:e,data:i}=t;if(!i||typeof i!="object")throw new Error("DeceptiveReportComponent requires DeceptiveReportData object");let r=i,o=await q();await figma.loadFontAsync({family:"Inter",style:"Semi Bold"}),await figma.loadFontAsync({family:"Inter",style:"Regular"}),e.layoutMode="VERTICAL",e.paddingTop=24,e.paddingRight=24,e.paddingBottom=24,e.paddingLeft=24,e.itemSpacing=20,e.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],e.strokes=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],e.strokeWeight=1,e.cornerRadius=16;let s=await y("Dark & Deceptive UX Review",{fontSize:20,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});e.appendChild(s);let a=((p=t.selectedNode)==null?void 0:p.name)||"[No selection]",l=await y(`Reviewed: ${a}`,{fontSize:12,fontName:o.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});if(e.appendChild(l),r.overallSeverity!=="None"){let c=figma.createFrame();c.name="Severity Badge",c.layoutMode="HORIZONTAL",c.primaryAxisSizingMode="AUTO",c.counterAxisSizingMode="AUTO",c.paddingTop=6,c.paddingRight=12,c.paddingBottom=6,c.paddingLeft=12,c.cornerRadius=12,c.itemSpacing=6;let d={Low:{r:.96,g:.65,b:.14},Medium:{r:.96,g:.52,b:.26},High:{r:.92,g:.26,b:.21}},u=d[r.overallSeverity]||d.Medium;c.fills=[{type:"SOLID",color:{r:u.r*.15,g:u.g*.15,b:u.b*.15}}],c.strokes=[{type:"SOLID",color:u,opacity:.3}],c.strokeWeight=1;let m=await y(`Severity: ${r.overallSeverity}`,{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:u}]});c.appendChild(m),e.appendChild(c)}if(r.summary){let c=figma.createFrame();c.name="Summary",c.layoutMode="VERTICAL",c.primaryAxisSizingMode="AUTO",c.counterAxisSizingMode="FIXED",c.resize(e.width-48,100),c.itemSpacing=8;let d=await y("Summary",{fontSize:14,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});c.appendChild(d);let u=await y(r.summary,{fontSize:13,fontName:o.regular,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});c.appendChild(u),e.appendChild(c)}if(r.dimensionsChecklist&&r.dimensionsChecklist.length>0){let c=await y("Dimensions Checked",{fontSize:16,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});e.appendChild(c);let d=figma.createFrame();d.name="Dimensions Checklist",d.layoutMode="VERTICAL",d.primaryAxisSizingMode="AUTO",d.counterAxisSizingMode="FIXED",d.resize(e.width-48,100),d.itemSpacing=8,d.paddingTop=12,d.paddingRight=12,d.paddingBottom=12,d.paddingLeft=12,d.fills=[{type:"SOLID",color:{r:.98,g:.98,b:.98}}],d.strokes=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],d.strokeWeight=1,d.cornerRadius=8;for(let u of r.dimensionsChecklist){let m=figma.createFrame();m.name=`Dimension: ${u.dimension}`,m.layoutMode="HORIZONTAL",m.primaryAxisSizingMode="AUTO",m.counterAxisSizingMode="AUTO",m.itemSpacing=10,m.counterAxisAlignItems="CENTER";let g=u.passed?"\u2713":"\u2717",f=u.passed?{r:.2,g:.6,b:.3}:{r:.92,g:.26,b:.21},h=await y(g,{fontSize:16,fontName:o.bold,fills:[{type:"SOLID",color:f}]});m.appendChild(h);let S=await y(u.dimension,{fontSize:13,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});m.appendChild(S),d.appendChild(m)}e.appendChild(d)}if(r.findings.length>0){let c=await y(`Findings (${r.findings.length})`,{fontSize:16,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});e.appendChild(c);let d={High:0,Medium:1,Low:2},u=[...r.findings].sort((m,g)=>d[m.severity]-d[g.severity]);for(let m of u){let g=figma.createFrame();g.name=`Finding: ${m.category}`,g.layoutMode="VERTICAL",g.primaryAxisSizingMode="AUTO",g.counterAxisSizingMode="FIXED",g.resize(e.width-48,100),g.paddingTop=16,g.paddingRight=16,g.paddingBottom=16,g.paddingLeft=16,g.itemSpacing=12,g.fills=[{type:"SOLID",color:{r:.98,g:.98,b:.98}}],g.strokes=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],g.strokeWeight=1,g.cornerRadius=8;let f=figma.createFrame();f.name="Header",f.layoutMode="HORIZONTAL",f.primaryAxisSizingMode="AUTO",f.counterAxisSizingMode="AUTO",f.itemSpacing=8,f.counterAxisAlignItems="CENTER";let h=await y(m.category,{fontSize:14,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});f.appendChild(h);let S=figma.createFrame();S.name="Severity",S.layoutMode="HORIZONTAL",S.primaryAxisSizingMode="AUTO",S.counterAxisSizingMode="AUTO",S.paddingTop=4,S.paddingRight=8,S.paddingBottom=4,S.paddingLeft=8,S.cornerRadius=6;let x={Low:{r:.96,g:.65,b:.14},Medium:{r:.96,g:.52,b:.26},High:{r:.92,g:.26,b:.21}}[m.severity];S.fills=[{type:"SOLID",color:{r:x.r*.15,g:x.g*.15,b:x.b*.15}}],S.strokes=[{type:"SOLID",color:x,opacity:.3}],S.strokeWeight=1;let k=await y(m.severity,{fontSize:11,fontName:o.bold,fills:[{type:"SOLID",color:x}]});S.appendChild(k),f.appendChild(S),g.appendChild(f);let C=await y("What was found:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});g.appendChild(C);let P=await y(m.description,{fontSize:12,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});g.appendChild(P);let b=await y("Why it's deceptive:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});g.appendChild(b);let A=await y(m.whyDeceptive,{fontSize:12,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});g.appendChild(A);let T=await y("Potential user harm:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});g.appendChild(T);let oe=await y(m.userHarm,{fontSize:12,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});g.appendChild(oe);let W=await y("Suggested remediation:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.6,b:.3}}]});g.appendChild(W);let Ri=await y(m.remediation,{fontSize:12,fontName:o.regular,fills:[{type:"SOLID",color:{r:.2,g:.5,b:.2}}]});if(g.appendChild(Ri),m.evidence){let Oi=await y("Evidence:",{fontSize:11,fontName:o.bold,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});g.appendChild(Oi);let Di=await y(m.evidence,{fontSize:11,fontName:o.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});g.appendChild(Di)}e.appendChild(g)}}else{let c=await y("No deceptive patterns identified in this design.",{fontSize:13,fontName:o.regular,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});e.appendChild(c)}}},gr=new qe});function Qn(n,t){He.has(n)&&console.warn(`[Artifacts] Overwriting existing artifact component for type: ${n}`),He.set(n,t)}async function Be(n,t){var o,s,a,l;let e=He.get(n.type);if(!e)throw new Error(`Unknown artifact type: ${n.type}. Available types: ${Array.from(He.keys()).join(", ")}`);let i=(o=n.width)!=null?o:e.getDefaultWidth(),r=await Te({type:n.type,assistant:n.assistant,selectedNode:n.selectedNode,width:i,spacing:(a=(s=n.placement)==null?void 0:s.spacing)!=null?a:40,version:n.version,replace:(l=n.replace)!=null?l:!0});return await e.render({root:r,selectedNode:n.selectedNode,options:n,data:t}),r}function fr(){Promise.resolve().then(()=>(Yn(),Gn)).then(({scorecardComponent:n})=>{Qn("scorecard",n)}).catch(n=>{console.error("[Artifacts] Failed to register scorecard component:",n)}),Promise.resolve().then(()=>(Kn(),Xn)).then(({deceptiveReportComponent:n})=>{Qn("deceptive-report",n)}).catch(n=>{console.error("[Artifacts] Failed to register deceptive report component:",n)})}var He,Zn=v(()=>{"use strict";Ne();He=new Map;fr()});function yr(n){let t=n.split(`
`),e=[],i=[],r=0;for(let s=0;s<t.length;s++){let a=t[s],l=r,p=0;if(a.match(/^#{1,3}\s+/)){let b=a.match(/^(#{1,3})\s+/);b&&(p=b[1].length,a=a.replace(/^#{1,3}\s+/,""))}let c=/^[-*]\s+/.test(a),d=a.match(/^\d+\.\s+/),u=!!d;if(c)a=a.replace(/^[-*]\s+/,"\u2022 ");else if(u){let b=d[0].replace(/\s+$/,"");a=a.replace(/^\d+\.\s+/,`${b} `)}let m=/\*\*([^*]+)\*\*/g,g=[],f;for(;(f=m.exec(a))!==null;)g.push({start:f.index,end:f.index+f[0].length,text:f[1]});let h=new RegExp("(?<!\\*)\\*([^*]+)\\*(?!\\*)","g"),S=[],w;for(;(w=h.exec(a))!==null;)g.some(A=>w.index>=A.start&&w.index<A.end)||S.push({start:w.index,end:w.index+w[0].length,text:w[1]});let x=new RegExp("(?<!_)_([^_]+)_(?!_)","g"),k;for(;(k=x.exec(a))!==null;)g.some(A=>k.index>=A.start&&k.index<A.end)||S.push({start:k.index,end:k.index+k[0].length,text:k[1]});let C=a;for(let b of g.reverse()){C=C.substring(0,b.start)+b.text+C.substring(b.end);for(let A of g)A.start>b.start&&(A.start-=2,A.end-=2);for(let A of S)A.start>b.start&&(A.start-=2,A.end-=2)}for(let b of S.reverse())if(C.substring(b.start,b.end).includes("*")||C.substring(b.start,b.end).includes("_")){let A=(C[b.start]==="*",1);C=C.substring(0,b.start)+b.text+C.substring(b.end);for(let T of g)T.start>b.start&&(T.start-=A,T.end-=A);for(let T of S)T.start>b.start&&(T.start-=A,T.end-=A)}e.push(C);let P=r;for(let b of g){let A=P+b.start,T=A+b.text.length;S.some(W=>W.start<b.end&&W.end>b.start||b.start<W.end&&b.end>W.start)?i.push({start:A,end:T,style:"boldItalic"}):i.push({start:A,end:T,style:"bold"})}for(let b of S){let A=P+b.start,T=A+b.text.length;g.some(W=>W.start<b.end&&W.end>b.start||b.start<W.end&&b.end>W.start)||i.push({start:A,end:T,style:"italic"})}if(p>0&&C.trim().length>0){let b=P,A=b+C.length;i.push({start:b,end:A,style:"bold",size:p===1?18:p===2?16:14})}r+=C.length+1}return{text:e.join(`
`),spans:i.sort((s,a)=>s.start-a.start)}}async function Ve(n,t,e){let i=e||"unknown";console.log(`[DC ${i}] placeCritiqueOnCanvas ENTER`,{selectedNode:t?{name:t.name,id:t.id}:null});let{getTopLevelContainerNodeForArtifact:r,computeAnchorBoundsForArtifact:o}=await Promise.resolve().then(()=>(Ne(),In)),{computePlacement:s}=await Promise.resolve().then(()=>(re(),hn)),a=2e4,l=n;n.length>a&&(l=n.substring(0,a)+`

(truncated)`);let p=yr(l),c={regular:{family:"Inter",style:"Regular"},bold:{family:"Inter",style:"Bold"},italic:{family:"Inter",style:"Italic"},boldItalic:{family:"Inter",style:"Bold Italic"}};try{await figma.loadFontAsync(c.regular),await figma.loadFontAsync(c.bold),await figma.loadFontAsync(c.italic);try{await figma.loadFontAsync(c.boldItalic)}catch(h){c.boldItalic=c.bold}}catch(h){try{c.regular={family:"Roboto",style:"Regular"},c.bold={family:"Roboto",style:"Bold"},c.italic={family:"Roboto",style:"Italic"},c.boldItalic={family:"Roboto",style:"Bold Italic"},await figma.loadFontAsync(c.regular),await figma.loadFontAsync(c.bold),await figma.loadFontAsync(c.italic);try{await figma.loadFontAsync(c.boldItalic)}catch(S){c.boldItalic=c.bold}}catch(S){c.regular={family:"Inter",style:"Regular"},c.bold=c.regular,c.italic=c.regular,c.boldItalic=c.regular}}let d=figma.createFrame();d.name="FigmAI \u2014 Critique (fallback)",d.setPluginData("figmai.artifactType","critique"),d.setPluginData("figmai.assistant","design_critique");let u=figma.createText();u.name="Critique Text",u.fontName=c.regular,u.fontSize=12,u.characters=p.text,u.textAutoResize="HEIGHT",u.setRangeFontName(0,p.text.length,c.regular);for(let h of p.spans)if(h.start<p.text.length&&h.end<=p.text.length&&h.start<h.end){let S;switch(h.style){case"bold":S=c.bold;break;case"italic":S=c.italic;break;case"boldItalic":S=c.boldItalic;break;default:S=c.regular}u.setRangeFontName(h.start,h.end,S),h.size&&u.setRangeFontSize(h.start,h.end,h.size)}u.resize(640,u.height),d.appendChild(u),d.resize(u.width,u.height);let m,g=null;t?(m=r(t),g=o(m),console.log(`[DC ${i}] placeCritiqueOnCanvas anchor`,{selectedNode:{name:t.name,id:t.id},anchor:{name:m.name,id:m.id},anchorBounds:g?{x:g.x,y:g.y,width:g.width,height:g.height}:null})):console.log(`[DC ${i}] placeCritiqueOnCanvas anchor`,{selectedNode:null,anchor:null,anchorBounds:null});let f=s(g,d.width,d.height,{mode:"left",offset:40,minX:0});return d.x=f.x,d.y=f.y,console.log(`[DC ${i}] placeCritiqueOnCanvas placement`,{computedX:f.x,computedY:f.y,frameWidth:d.width,frameHeight:d.height}),figma.currentPage.appendChild(d),figma.currentPage.selection=[d],figma.viewport.scrollAndZoomIntoView([d]),console.log(`[DC ${i}] placeCritiqueOnCanvas EXIT`,{frameName:d.name,frameId:d.id}),d}var ei=v(()=>{"use strict"});var je,ti=v(()=>{"use strict";Ue();Jn();Zn();Ne();ei();re();ne();je=class{canHandle(t,e){return t==="design_critique"&&(e==="give-critique"||e==="deceptive-review")}prepareMessages(t){let e=[...t].reverse().find(r=>r.role==="user");if((e==null?void 0:e.content.includes("Dark & Deceptive UX practices"))||!1){let r=this.getDarkUxEvaluationPrompt(),o=t.map((s,a)=>s.role==="user"&&a===t.length-1?B(N({},s),{content:`Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object.

`+s.content}):s);return[{role:"system",content:"Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object."},...o,{role:"user",content:r}]}else return[{role:"system",content:"Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object."},...t,{role:"user",content:"IMPORTANT: Output must be a single JSON object with keys: score (0-100), summary (string), wins (string[]), fixes (string[]), checklist (string[] optional), notes (string[] optional). Do not include any other keys. Return JSON only, no other text."}]}async handleDeceptiveReview(t,e,i){var l,p,c;let{response:r,selectionOrder:o,selection:s,replaceStatusMessage:a}=t;try{let d;if(s.hasSelection&&o.length>0){let m=await figma.getNodeByIdAsync(o[0]);if(m&&m.type!=="DOCUMENT"&&m.type!=="PAGE"){if(d=m,E.isEnabled("assistant:design_critique")){let g=V(d);i.log("Placement verification",{runId:e,selectedNode:{name:d.name,id:d.id,type:d.type,parentType:(l=d.parent)==null?void 0:l.type},placementTarget:{name:g.name,id:g.id,type:g.type,parentType:(p=g.parent)==null?void 0:p.type,isTopLevel:((c=g.parent)==null?void 0:c.type)==="PAGE"}})}}else E.isEnabled("assistant:design_critique")&&i.log("Selected node invalid or missing",{runId:e,nodeType:m==null?void 0:m.type,hasSelection:s.hasSelection,selectionOrderLength:o.length})}else E.isEnabled("assistant:design_critique")&&i.log("No selection for placement",{runId:e,hasSelection:s.hasSelection,selectionOrderLength:o.length});i.log("RAW_RESPONSE_HEAD",{runId:e,head:r.slice(0,120)}),Y("deceptive-report","v1"),i.log("BEFORE parseDeceptiveReportJson",{runId:e});let u=Wn(r,E.isEnabled("assistant:design_critique"));if("data"in u){i.log("parseDeceptiveReportJson RESULT",{runId:e,status:"SUCCESS",overallSeverity:u.data.overallSeverity,findingsCount:u.data.findings.length}),i.log("BEFORE createArtifact (deceptive-report)",{runId:e});try{return await Be({type:"deceptive-report",assistant:"design_critique",selectedNode:d,version:"v1",replace:!0},u.data),i.log("AFTER createArtifact (deceptive-report)",{runId:e,status:"SUCCESS"}),figma.notify("Deceptive Review report placed"),a("Deceptive Review report placed on stage"),{handled:!0}}catch(m){throw i.error("CATCH createArtifact (deceptive-report)",{runId:e,error:m instanceof Error?m.message:String(m),stack:m instanceof Error?m.stack:void 0}),m}}else return i.log("parseDeceptiveReportJson RESULT",{runId:e,status:"FAIL",error:u.error}),i.log("BEFORE placeCritiqueOnCanvas fallback",{runId:e}),await Ve(r,d,e),i.log("AFTER placeCritiqueOnCanvas fallback",{runId:e,status:"SUCCESS"}),figma.notify("Deceptive Review parse failed \u2014 placed text fallback"),a("Deceptive Review report placed on stage"),{handled:!0}}catch(d){let u=d instanceof Error?d.message:String(d);return i.error("handleDeceptiveReview ERROR",{runId:e,error:u}),Y("deceptive-report","v1"),a(`Error: ${u}`,!0),{handled:!0}}}getDarkUxEvaluationPrompt(){return`IMPORTANT: Output must be a single JSON object with this exact schema. Return JSON only, no other text.

{
  "summary": "Overall assessment of deceptive patterns found (string)",
  "overallSeverity": "None" | "Low" | "Medium" | "High",
  "findings": [
    {
      "category": "One of: Forced Action, Nagging, Obstruction, Sneaking, Interface Interference, False Urgency/Scarcity, Confirmshaming, Trick Questions, Hidden Subscription/Roach Motel, Misleading Defaults",
      "severity": "Low" | "Medium" | "High",
      "description": "What was found (string)",
      "whyDeceptive": "Why this pattern is deceptive (string)",
      "userHarm": "Potential harm to users (string)",
      "remediation": "Ethical alternative or fix (string)",
      "evidence": "Specific UI elements/patterns observed (string, optional)"
    }
  ],
  "dimensionsChecklist": [
    {
      "dimension": "Forced Action",
      "passed": true
    },
    {
      "dimension": "Nagging",
      "passed": true
    },
    {
      "dimension": "Obstruction",
      "passed": false
    },
    {
      "dimension": "Sneaking",
      "passed": true
    },
    {
      "dimension": "Interface Interference",
      "passed": false
    },
    {
      "dimension": "False Urgency/Scarcity",
      "passed": true
    },
    {
      "dimension": "Confirmshaming",
      "passed": true
    },
    {
      "dimension": "Trick Questions",
      "passed": true
    },
    {
      "dimension": "Hidden Subscription/Roach Motel",
      "passed": true
    },
    {
      "dimension": "Misleading Defaults",
      "passed": false
    }
  ]
}

CRITICAL: The dimensionsChecklist array must contain exactly 10 items, one for each dimension listed below. For each dimension:
- Set "passed": true if NO deceptive patterns were found for that dimension
- Set "passed": false if deceptive patterns were found (these should also appear in the "findings" array with matching category)

Evaluate the design against these Dark & Deceptive UX categories:

1. **Forced Action**: Requiring users to do something unrelated to their goal (e.g., mandatory account creation, bundled consent)
2. **Nagging**: Repeated prompts interrupting user flow to influence behavior
3. **Obstruction**: Making tasks harder than necessary (e.g., hard-to-find cancel buttons, hidden opt-outs)
4. **Sneaking**: Hiding or disguising information (e.g., pre-checked boxes, hidden fees, visual misdirection)
5. **Interface Interference**: Manipulating visual hierarchy to bias decisions (e.g., dominant "Accept" vs muted "Decline")
6. **False Urgency/Scarcity**: Fake countdowns, pressure tactics, misleading availability
7. **Confirmshaming**: Guilt-inducing language for opting out
8. **Trick Questions**: Confusing or misleading wording that causes accidental consent
9. **Hidden Subscription/Roach Motel**: Easy to enter, hard to exit
10. **Misleading Defaults**: Defaults that benefit the business over the user without clear disclosure

Evaluation Principles:
- Judge intent + effect, not just visual style
- Consider financial harm, loss of autonomy, confusion, and regulatory risk
- If evidence is insufficient, explicitly state this in the summary
- Be specific about what you observe in the design
- For dimensionsChecklist: Evaluate ALL 10 dimensions and set passed=true for dimensions with no issues, passed=false for dimensions with issues found

Return ONLY the JSON object, no markdown fences, no other text.`}async handleResponse(t){var u,m,g,f;let{response:e,selectionOrder:i,selection:r,provider:o,sendAssistantMessage:s,replaceStatusMessage:a,requestId:l,actionId:p}=t,c=`dc_${Date.now()}`,d=E.scope("assistant:design_critique");if(d.log("START",{runId:c,assistantId:t.assistantId,quickActionId:t.actionId}),p==="deceptive-review")return await this.handleDeceptiveReview(t,c,d);try{let h;if(r.hasSelection&&i.length>0){let w=await figma.getNodeByIdAsync(i[0]);if(w&&w.type!=="DOCUMENT"&&w.type!=="PAGE"){if(h=w,E.isEnabled("assistant:design_critique")){let x=V(h),k=((u=h.parent)==null?void 0:u.type)==="PAGE";d.log("selectedNode",{runId:c,name:h.name,id:h.id,type:h.type,parentType:(m=h.parent)==null?void 0:m.type,isDirectChild:k}),d.log("computed anchor",{runId:c,name:x.name,id:x.id,type:x.type,parentType:(g=x.parent)==null?void 0:g.type,isTopLevel:((f=x.parent)==null?void 0:f.type)==="PAGE"})}}else E.isEnabled("assistant:design_critique")&&d.log("selectedNode",{runId:c,status:"invalid_or_missing",nodeType:w==null?void 0:w.type})}else E.isEnabled("assistant:design_critique")&&d.log("selectedNode",{runId:c,status:"no_selection"});d.log("RAW_RESPONSE_HEAD",{runId:c,head:e.slice(0,120)}),d.log("RAW_RESPONSE_LENGTH",{runId:c,length:e.length}),d.log("BEFORE removeExistingArtifacts",{runId:c}),Y("scorecard","v2"),Y("critique"),d.log("AFTER removeExistingArtifacts",{runId:c}),d.log("BEFORE parseScorecardJson",{runId:c});let S=St(e,E.isEnabled("assistant:design_critique"));if("data"in S){d.log("parseScorecardJson RESULT",{runId:c,status:"SUCCESS",score:S.data.score,wins:S.data.wins.length,fixes:S.data.fixes.length}),d.log("BEFORE createArtifact (scorecard)",{runId:c});try{return await Be({type:"scorecard",assistant:"design_critique",selectedNode:h,version:"v2",replace:!0},S.data),d.log("AFTER createArtifact (scorecard)",{runId:c,status:"SUCCESS"}),figma.notify("Scorecard placed (v2)"),a("Scorecard placed on stage"),{handled:!0}}catch(w){throw d.error("CATCH createArtifact (scorecard)",{runId:c,error:w instanceof Error?w.message:String(w),stack:w instanceof Error?w.stack:void 0}),w}}else{d.log("parseScorecardJson RESULT",{runId:c,status:"FAIL",error:S.error}),d.log("BEFORE repair attempt",{runId:c});try{let w=`Convert the following critique into ONLY valid JSON with the required schema. Return JSON only, no other text.

Required schema:
{
  "score": 0-100 (number),
  "summary": "string",
  "wins": ["string"],
  "fixes": ["string"],
  "checklist": ["string"] (optional),
  "notes": ["string"] (optional)
}

Critique text:
${e.substring(0,2e3)}`,x=[{role:"system",content:"Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object."},{role:"user",content:w}],k=await o.sendChat({messages:x,assistantId:t.assistantId,assistantName:"Design Critique",quickActionId:t.actionId});d.log("repair response",{runId:c,length:k.length,head:k.substring(0,120)});let C=St(k,E.isEnabled("assistant:design_critique"));if("data"in C)return d.log("repair RESULT",{runId:c,status:"SUCCESS",score:C.data.score}),d.log("BEFORE createArtifact (scorecard, from repair)",{runId:c}),await Be({type:"scorecard",assistant:"design_critique",selectedNode:h,version:"v2",replace:!0},C.data),d.log("AFTER createArtifact (scorecard, from repair)",{runId:c,status:"SUCCESS"}),figma.notify("Scorecard placed (v2, repaired)"),a("Scorecard placed on stage"),{handled:!0};d.log("repair RESULT",{runId:c,status:"FAIL",error:C.error})}catch(w){d.error("repair CATCH",{runId:c,error:w instanceof Error?w.message:String(w)})}return d.log("BEFORE placeCritiqueOnCanvas fallback",{runId:c}),await Ve(e,h,c),d.log("AFTER placeCritiqueOnCanvas fallback",{runId:c,status:"SUCCESS"}),figma.notify("Scorecard parse failed \u2014 placed critique fallback"),a("Scorecard placed on stage"),{handled:!0}}}catch(h){let S=h instanceof Error?h.message:"Unknown error processing critique";d.error("CATCH handler",{runId:c,error:S,stack:h instanceof Error?h.stack:void 0});try{Y("scorecard","v2"),Y("critique")}catch(w){d.error("Failed to cleanup artifacts",{runId:c,error:w})}try{let w;if(r.hasSelection&&i.length>0){let x=await figma.getNodeByIdAsync(i[0]);x&&x.type!=="DOCUMENT"&&x.type!=="PAGE"&&(w=x)}return d.log("BEFORE placeCritiqueOnCanvas error fallback",{runId:c}),await Ve(e,w,c),d.log("AFTER placeCritiqueOnCanvas error fallback",{runId:c}),figma.notify("Error processing critique \u2014 placed critique fallback"),a("Scorecard placed on stage"),{handled:!0}}catch(w){return console.error(`[DC ${c}] Fallback placement also failed:`,w),figma.notify(`Error: ${S}`),{handled:!0,message:`Error: ${S}`}}}}}});function bt(n){let t=[],e=[],i=[],r=[];if(!n||typeof n!="object")return e.push("Spec is not an object"),r.push({level:"error",message:"Spec is not an object"}),{ok:!1,warnings:t,errors:e,info:i,severity:r};let o=n;if(o.type!=="designScreens"&&(e.push('Missing or invalid type field (must be "designScreens")'),r.push({level:"error",message:'Missing or invalid type field (must be "designScreens")',field:"type"})),(typeof o.version!="number"||o.version!==1)&&(e.push("Missing or invalid version field (must be 1)"),r.push({level:"error",message:"Missing or invalid version field (must be 1)",field:"version"})),!o.meta||typeof o.meta!="object"?(e.push("Missing or invalid meta field"),r.push({level:"error",message:"Missing or invalid meta field",field:"meta"})):typeof o.meta.title!="string"&&(e.push("meta.title is missing or invalid"),r.push({level:"error",message:"meta.title is missing or invalid",field:"meta.title"})),!o.canvas||typeof o.canvas!="object")e.push("Missing or invalid canvas field"),r.push({level:"error",message:"Missing or invalid canvas field",field:"canvas"});else{let a=o.canvas;if(!a.device||typeof a.device!="object")e.push("canvas.device is missing or invalid"),r.push({level:"error",message:"canvas.device is missing or invalid",field:"canvas.device"});else{let l=a.device;["mobile","tablet","desktop"].includes(l.kind)||(e.push('canvas.device.kind is missing or invalid (must be "mobile", "tablet", or "desktop")'),r.push({level:"error",message:'canvas.device.kind is missing or invalid (must be "mobile", "tablet", or "desktop")',field:"canvas.device.kind"})),(typeof l.width!="number"||l.width<=0)&&(e.push("canvas.device.width is missing or invalid (must be positive number)"),r.push({level:"error",message:"canvas.device.width is missing or invalid (must be positive number)",field:"canvas.device.width"})),(typeof l.height!="number"||l.height<=0)&&(e.push("canvas.device.height is missing or invalid (must be positive number)"),r.push({level:"error",message:"canvas.device.height is missing or invalid (must be positive number)",field:"canvas.device.height"}))}}if(!o.render||typeof o.render!="object")e.push("Missing or invalid render field"),r.push({level:"error",message:"Missing or invalid render field",field:"render"});else{let a=o.render;if(!a.intent||typeof a.intent!="object")e.push("render.intent is missing or invalid"),r.push({level:"error",message:"render.intent is missing or invalid",field:"render.intent"});else{let l=a.intent;["wireframe","medium","hi","creative"].includes(l.fidelity)||(e.push('render.intent.fidelity is missing or invalid (must be "wireframe", "medium", "hi", or "creative")'),r.push({level:"error",message:'render.intent.fidelity is missing or invalid (must be "wireframe", "medium", "hi", or "creative")',field:"render.intent.fidelity"}))}}if(!Array.isArray(o.screens))return e.push("screens is not an array"),r.push({level:"error",message:"screens is not an array",field:"screens"}),{ok:e.length===0,warnings:t,errors:e,info:i,severity:r};let s=o.screens;if(s.length===0?(e.push("screens array is empty (must have at least 1 screen)"),r.push({level:"error",message:"screens array is empty (must have at least 1 screen)",field:"screens"})):s.length>5&&(t.push(`screens array has ${s.length} items (will be truncated to 5)`),r.push({level:"warning",message:`screens array has ${s.length} items (will be truncated to 5)`,field:"screens"})),o.meta&&typeof o.meta=="object"){let a=o.meta;if(!a.intent)i.push("No intent specified in meta (will use defaults)"),r.push({level:"info",message:"No intent specified in meta (will use defaults)",field:"meta.intent"});else{let l=a.intent;!l.appType&&!l.tone&&!l.primaryColor&&(i.push("Intent is minimal (appType, tone, or primaryColor not specified)"),r.push({level:"info",message:"Intent is minimal (appType, tone, or primaryColor not specified)",field:"meta.intent"}))}a.userRequest||(i.push("No userRequest stored in meta (traceability reduced)"),r.push({level:"info",message:"No userRequest stored in meta (traceability reduced)",field:"meta.userRequest"}))}return s.forEach((a,l)=>{if(!a||typeof a!="object"){e.push(`screens[${l}] is not an object`);return}let p=a;if(typeof p.name!="string"&&e.push(`screens[${l}].name is missing or invalid`),!Array.isArray(p.blocks)){e.push(`screens[${l}].blocks is missing or not an array`);return}p.blocks.forEach((d,u)=>{if(!d||typeof d!="object"){e.push(`screens[${l}].blocks[${u}] is not an object`);return}let m=d,g=m.type;switch(g){case"heading":typeof m.text!="string"&&e.push(`screens[${l}].blocks[${u}].text is missing or invalid`),m.level!==void 0&&![1,2,3].includes(m.level)&&e.push(`screens[${l}].blocks[${u}].level is invalid (must be 1, 2, or 3)`);break;case"bodyText":typeof m.text!="string"&&e.push(`screens[${l}].blocks[${u}].text is missing or invalid`);break;case"button":typeof m.text!="string"&&e.push(`screens[${l}].blocks[${u}].text is missing or invalid`);break;case"input":m.inputType!==void 0&&!["text","email","password"].includes(m.inputType)&&e.push(`screens[${l}].blocks[${u}].inputType is invalid (must be "text", "email", or "password")`);break;case"card":typeof m.content!="string"&&e.push(`screens[${l}].blocks[${u}].content is missing or invalid`);break;case"spacer":break;case"image":break;default:e.push(`screens[${l}].blocks[${u}].type is invalid or unsupported: ${g}`)}})}),e.forEach(a=>{r.some(l=>l.message===a&&l.level==="error")||r.push({level:"error",message:a})}),t.forEach(a=>{r.some(l=>l.message===a&&l.level==="warning")||r.push({level:"warning",message:a})}),{ok:e.length===0,warnings:t,errors:e,info:i,severity:r}}function At(n){let t=JSON.parse(JSON.stringify(n));if(t.meta||(t.meta={title:"Screens"}),!t.canvas)t.canvas={device:{kind:"mobile",width:375,height:812}};else if(!t.canvas.device)t.canvas.device={kind:"mobile",width:375,height:812};else{if(t.canvas.device.kind||(t.canvas.device.kind="mobile"),!t.canvas.device.width||t.canvas.device.width<=0)switch(t.canvas.device.kind){case"mobile":t.canvas.device.width=375;break;case"tablet":t.canvas.device.width=768;break;case"desktop":t.canvas.device.width=1920;break}if(!t.canvas.device.height||t.canvas.device.height<=0)switch(t.canvas.device.kind){case"mobile":t.canvas.device.height=812;break;case"tablet":t.canvas.device.height=1024;break;case"desktop":t.canvas.device.height=1080;break}}return t.render?t.render.intent?t.render.intent.fidelity||(t.render.intent.fidelity="medium"):t.render.intent={fidelity:"medium"}:t.render={intent:{fidelity:"medium"}},Array.isArray(t.screens)||(t.screens=[]),t.screens.length===0?t.screens=[{name:"Screen 1",blocks:[]}]:t.screens.length>5&&(t.screens=t.screens.slice(0,5),t.meta.truncationNotice="Generated 5 screens. Ask for more to continue."),t.screens=t.screens.map((e,i)=>{let r=N({},e);return r.name||(r.name=`Screen ${i+1}`),r.layout?(r.layout.direction||(r.layout.direction="vertical"),r.layout.padding===void 0&&(r.layout.padding=16),r.layout.gap===void 0&&(r.layout.gap=12)):r.layout={direction:"vertical",padding:16,gap:12},Array.isArray(r.blocks)||(r.blocks=[]),r.blocks=r.blocks.map(o=>{let s=N({},o);switch(s.type){case"heading":s.level||(s.level=1);break;case"button":s.variant||(s.variant="primary");break;case"spacer":s.height||(s.height=16);break;case"input":s.inputType||(s.inputType="text");break}return s}),r}),t}var ni=v(()=>{"use strict"});async function vt(n,t){var p,c,d,u,m,g,f,h,S,w,x,k,C,P,b,A;let e={consumedFields:[],unusedFields:[],fallbacks:[]},i=new Set;if((c=(p=n.render)==null?void 0:p.intent)!=null&&c.fidelity&&(i.add("render.intent.fidelity"),e.consumedFields.push({field:"render.intent.fidelity",value:n.render.intent.fidelity,influence:`Applied ${n.render.intent.fidelity} fidelity styling (typography, corners, shadows)`})),(d=n.meta)!=null&&d.intent){let T=n.meta.intent;T.appType&&(i.add("meta.intent.appType"),e.consumedFields.push({field:"meta.intent.appType",value:T.appType,influence:`Influenced screen content and naming for ${T.appType} app type`})),T.tone&&(i.add("meta.intent.tone"),e.consumedFields.push({field:"meta.intent.tone",value:T.tone,influence:`Applied ${T.tone} tone styling (corner radius, color palette)`})),T.primaryColor&&(i.add("meta.intent.primaryColor"),e.consumedFields.push({field:"meta.intent.primaryColor",value:T.primaryColor,influence:`Used ${T.primaryColor} as primary color in buttons and accents`})),T.accentColors&&T.accentColors.length>0&&(i.add("meta.intent.accentColors"),T.accentColors.length>1&&e.unusedFields.push({field:"meta.intent.accentColors[1+]",value:T.accentColors.slice(1),reason:"Only first accent color is currently supported in rendering"}),e.consumedFields.push({field:"meta.intent.accentColors[0]",value:T.accentColors[0],influence:`Used ${T.accentColors[0]} as accent color`}))}(m=(u=n.render)==null?void 0:u.intent)!=null&&m.styleKeywords&&n.render.intent.styleKeywords.length>0&&(i.add("render.intent.styleKeywords"),e.consumedFields.push({field:"render.intent.styleKeywords",value:n.render.intent.styleKeywords,influence:`Applied style keywords: ${n.render.intent.styleKeywords.join(", ")}`})),(f=(g=n.render)==null?void 0:g.intent)!=null&&f.brandTone&&(i.add("render.intent.brandTone"),e.consumedFields.push({field:"render.intent.brandTone",value:n.render.intent.brandTone,influence:`Applied brand tone: ${n.render.intent.brandTone}`})),(S=(h=n.render)==null?void 0:h.intent)!=null&&S.density?(i.add("render.intent.density"),e.consumedFields.push({field:"render.intent.density",value:n.render.intent.density,influence:`Applied ${n.render.intent.density} density (spacing adjustments)`})):e.fallbacks.push({field:"render.intent.density",fallback:"default comfortable density"}),(x=(w=n.meta)==null?void 0:w.intent)!=null&&x.keywords&&n.meta.intent.keywords.length>0&&(i.has("meta.intent.keywords")||e.unusedFields.push({field:"meta.intent.keywords",value:n.meta.intent.keywords,reason:"Keywords are extracted but not yet used in rendering logic"})),(C=(k=n.meta)==null?void 0:k.intent)!=null&&C.avoidColors&&n.meta.intent.avoidColors.length>0&&e.unusedFields.push({field:"meta.intent.avoidColors",value:n.meta.intent.avoidColors,reason:"Avoid colors not yet implemented in rendering"}),(b=(P=n.meta)==null?void 0:P.intent)!=null&&b.theme&&e.unusedFields.push({field:"meta.intent.theme",value:n.meta.intent.theme,reason:"Theme (light/dark) not yet implemented in rendering"});let r=figma.createFrame();r.name=`Design Workshop \u2014 ${n.meta.title||"Screens"}`,r.layoutMode="HORIZONTAL",r.primaryAxisSizingMode="AUTO",r.counterAxisSizingMode="AUTO",r.itemSpacing=80,r.paddingTop=40,r.paddingRight=40,r.paddingBottom=40,r.paddingLeft=40;let o=[],s=n.render.intent.fidelity,a=(A=n.meta)==null?void 0:A.intent;for(let T of n.screens){let oe=await hr(T,n.canvas.device,s,a);r.appendChild(oe),o.push(oe)}let l=br(r);return r.x=l.x,r.y=l.y,figma.currentPage.appendChild(r),figma.currentPage.selection=[r],figma.viewport.scrollAndZoomIntoView([r]),{section:r,screens:o,report:e}}async function hr(n,t,e,i){var s,a,l,p,c;let r=figma.createFrame();r.name=n.name||"Screen",r.resize(t.width,t.height);let o=n.layout||{direction:"vertical",padding:16,gap:12};r.layoutMode=o.direction==="horizontal"?"HORIZONTAL":"VERTICAL",r.primaryAxisSizingMode="AUTO",r.counterAxisSizingMode="AUTO",typeof o.padding=="number"?(r.paddingTop=o.padding,r.paddingRight=o.padding,r.paddingBottom=o.padding,r.paddingLeft=o.padding):o.padding?(r.paddingTop=(s=o.padding.top)!=null?s:16,r.paddingRight=(a=o.padding.right)!=null?a:16,r.paddingBottom=(l=o.padding.bottom)!=null?l:16,r.paddingLeft=(p=o.padding.left)!=null?p:16):(r.paddingTop=16,r.paddingRight=16,r.paddingBottom=16,r.paddingLeft=16),r.itemSpacing=(c=o.gap)!=null?c:12;for(let d of n.blocks){let u=await Sr(d,e,t.width-(r.paddingLeft+r.paddingRight),i);r.appendChild(u)}return Ar(r,e,i),r}async function Sr(n,t,e,i){let r=await q();switch(n.type){case"heading":{let s=await y(n.text,{fontSize:ii(n.level||1,t),fontName:r.bold,fills:[Ce(t)]});return s.name=`Heading ${n.level||1}`,s.resize(e,s.height),s}case"bodyText":{let s=await y(n.text,{fontSize:wt(t),fontName:r.regular,fills:[Ce(t)]});return s.name="Body Text",s.resize(e,s.height),s}case"button":{let s=U("Button","HORIZONTAL",{padding:{top:12,right:24,bottom:12,left:24},gap:8,primaryAxisAlign:"CENTER",counterAxisAlign:"CENTER"}),a=await y(n.text,{fontSize:wr(t),fontName:r.bold,fills:[xr(n.variant||"primary",t)]});return s.appendChild(a),s.fills=[vr(n.variant||"primary",t,i)],s.strokes=[Tr(n.variant||"primary",t,i)],s.cornerRadius=We(t,i),s.effects=Nr(t),s.resize(e,s.height),s}case"input":{let s=U("Input","VERTICAL",{padding:{top:12,right:16,bottom:12,left:16},gap:4});if(n.label){let l=await y(n.label,{fontSize:12,fontName:r.regular,fills:[Ce(t)]});s.appendChild(l)}let a=await y(n.placeholder||"",{fontSize:wt(t),fontName:r.regular,fills:[ri(t)]});return s.appendChild(a),s.fills=[Ir(t)],s.strokes=[Cr(t,i)],s.cornerRadius=We(t,i),s.effects=kr(t),s.resize(e,s.height),s}case"card":{let s=U("Card","VERTICAL",{padding:{top:16,right:16,bottom:16,left:16},gap:8});if(n.title){let l=await y(n.title,{fontSize:ii(2,t),fontName:r.bold,fills:[Ce(t)]});s.appendChild(l)}let a=await y(n.content,{fontSize:wt(t),fontName:r.regular,fills:[Ce(t)]});return s.appendChild(a),s.fills=[Er(t)],s.strokes=[Rr(t,i)],s.cornerRadius=We(t,i),s.effects=Or(t),s.resize(e,s.height),s}case"spacer":{let s=figma.createRectangle();return s.name="Spacer",s.resize(e,n.height||16),s.fills=[],s.strokes=[],s}case"image":{let s=figma.createFrame();s.name="Image";let a=n.width||e,l=n.height||Math.round(a*.75);if(s.resize(a,l),s.fills=[Dr(t)],s.strokes=[Mr(t,i)],s.cornerRadius=We(t,i),t==="wireframe"){let p=await y("[Image]",{fontSize:12,fontName:r.regular,fills:[ri(t)]});p.textAlignHorizontal="CENTER",s.appendChild(p),s.layoutMode="VERTICAL",s.primaryAxisAlignItems="CENTER",s.counterAxisAlignItems="CENTER"}return s}default:let o=figma.createFrame();return o.name="Unknown Block",o.resize(e,40),o}}function br(n){let e=figma.currentPage.children.filter(o=>o!==n);if(e.length===0)return{x:0,y:0};let i=0;for(let o of e){let s=0;if("absoluteBoundingBox"in o&&o.absoluteBoundingBox)s=o.absoluteBoundingBox.y+o.absoluteBoundingBox.height;else if("absoluteRenderBounds"in o&&o.absoluteRenderBounds)s=o.absoluteRenderBounds.y+o.absoluteRenderBounds.height;else if("y"in o&&"height"in o){let a=o.y,l=o.parent;for(;l&&l.type!=="PAGE"&&l.type!=="DOCUMENT";)"y"in l&&(a+=l.y),l=l.parent;s=a+(o.height||0)}s>i&&(i=s)}let r=i+120;return{x:0,y:Math.max(0,r)}}function Ar(n,t,e){switch(t){case"wireframe":n.fills=[{type:"SOLID",color:{r:.88,g:.88,b:.88}}],n.strokes=[{type:"SOLID",color:{r:.6,g:.6,b:.6},opacity:1}],n.strokeWeight=1,n.cornerRadius=0,n.effects=[];break;case"medium":n.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],n.strokes=[{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1}],n.strokeWeight=1,n.cornerRadius=8,n.effects=[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.1},offset:{x:0,y:1},radius:2,visible:!0,blendMode:"NORMAL"}];break;case"hi":n.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],n.strokes=[{type:"SOLID",color:{r:.9,g:.9,b:.9},opacity:1}],n.strokeWeight=.5,n.cornerRadius=12,n.effects=[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.08},offset:{x:0,y:2},radius:4,visible:!0,blendMode:"NORMAL"},{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.04},offset:{x:0,y:8},radius:16,visible:!0,blendMode:"NORMAL"}];break;case"creative":n.fills=[{type:"SOLID",color:{r:.98,g:.98,b:1}}],n.strokes=[{type:"SOLID",color:{r:.2,g:.4,b:.8},opacity:1}],n.strokeWeight=2,n.cornerRadius=20,n.effects=[{type:"DROP_SHADOW",color:{r:.2,g:.4,b:.8,a:.3},offset:{x:0,y:4},radius:12,visible:!0,blendMode:"NORMAL"},{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.1},offset:{x:0,y:16},radius:32,visible:!0,blendMode:"NORMAL"}];break}}function ii(n,t){let i={1:32,2:24,3:18}[n];switch(t){case"wireframe":return i*.8;case"medium":return i;case"hi":return i*1.1;case"creative":return i*1.3}}function wt(n){switch(n){case"wireframe":return 12;case"medium":return 14;case"hi":return 16;case"creative":return 18}}function wr(n){switch(n){case"wireframe":return 12;case"medium":return 14;case"hi":return 15;case"creative":return 16}}function Ce(n){switch(n){case"wireframe":return{type:"SOLID",color:{r:.4,g:.4,b:.4}};case"medium":return{type:"SOLID",color:{r:.2,g:.2,b:.2}};case"hi":return{type:"SOLID",color:{r:.1,g:.1,b:.1}};case"creative":return{type:"SOLID",color:{r:.05,g:.05,b:.2}}}}function vr(n,t,e){if(n==="primary"&&(e!=null&&e.primaryColor)){let i=fe(e.primaryColor);if(i)return{type:"SOLID",color:i}}if(n==="secondary"&&(e!=null&&e.accentColors)&&e.accentColors.length>0){let i=fe(e.accentColors[0]);if(i)return{type:"SOLID",color:i}}switch(t){case"wireframe":return{type:"SOLID",color:{r:.88,g:.88,b:.88}};case"medium":return n==="primary"?{type:"SOLID",color:{r:0,g:.4,b:.8}}:{type:"SOLID",color:{r:.95,g:.95,b:.95}};case"hi":return n==="primary"?{type:"SOLID",color:{r:0,g:.4,b:.8}}:n==="secondary"?{type:"SOLID",color:{r:.42,g:.46,b:.49}}:{type:"SOLID",color:{r:.96,g:.96,b:.96}};case"creative":return n==="primary"?{type:"SOLID",color:{r:.2,g:.4,b:.9}}:{type:"SOLID",color:{r:.95,g:.7,b:.2}}}}function xr(n,t){switch(t){case"wireframe":return{type:"SOLID",color:{r:.4,g:.4,b:.4}};case"medium":case"hi":return n==="primary"?{type:"SOLID",color:{r:1,g:1,b:1}}:{type:"SOLID",color:{r:.2,g:.2,b:.2}};case"creative":return{type:"SOLID",color:{r:1,g:1,b:1}}}}function Tr(n,t,e){if(n==="primary"&&(e!=null&&e.primaryColor)){let i=fe(e.primaryColor);if(i)return{type:"SOLID",color:i,opacity:.3}}switch(t){case"wireframe":return{type:"SOLID",color:{r:.6,g:.6,b:.6},opacity:1};case"medium":return{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1};case"hi":return{type:"SOLID",color:{r:.9,g:.9,b:.9},opacity:1};case"creative":return{type:"SOLID",color:{r:.2,g:.4,b:.8},opacity:1}}}function Nr(n){switch(n){case"wireframe":return[];case"medium":return[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.1},offset:{x:0,y:1},radius:2,visible:!0,blendMode:"NORMAL"}];case"hi":return[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.12},offset:{x:0,y:2},radius:4,visible:!0,blendMode:"NORMAL"}];case"creative":return[{type:"DROP_SHADOW",color:{r:.2,g:.4,b:.8,a:.4},offset:{x:0,y:4},radius:8,visible:!0,blendMode:"NORMAL"}]}}function Ir(n){switch(n){case"wireframe":return{type:"SOLID",color:{r:.95,g:.95,b:.95}};case"medium":case"hi":return{type:"SOLID",color:{r:1,g:1,b:1}};case"creative":return{type:"SOLID",color:{r:.98,g:.98,b:1}}}}function Cr(n,t){if(t!=null&&t.primaryColor){let e=fe(t.primaryColor);if(e)return{type:"SOLID",color:e,opacity:.2}}switch(n){case"wireframe":return{type:"SOLID",color:{r:.6,g:.6,b:.6},opacity:1};case"medium":return{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1};case"hi":return{type:"SOLID",color:{r:.85,g:.85,b:.85},opacity:1};case"creative":return{type:"SOLID",color:{r:.2,g:.4,b:.8},opacity:1}}}function kr(n){switch(n){case"wireframe":return[];case"medium":return[];case"hi":return[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.05},offset:{x:0,y:1},radius:2,visible:!0,blendMode:"NORMAL"}];case"creative":return[{type:"DROP_SHADOW",color:{r:.2,g:.4,b:.8,a:.2},offset:{x:0,y:2},radius:4,visible:!0,blendMode:"NORMAL"}]}}function Er(n){switch(n){case"wireframe":return{type:"SOLID",color:{r:.95,g:.95,b:.95}};case"medium":case"hi":return{type:"SOLID",color:{r:1,g:1,b:1}};case"creative":return{type:"SOLID",color:{r:.98,g:.98,b:1}}}}function Rr(n,t){if(t!=null&&t.primaryColor){let e=fe(t.primaryColor);if(e)return{type:"SOLID",color:e,opacity:.15}}switch(n){case"wireframe":return{type:"SOLID",color:{r:.6,g:.6,b:.6},opacity:1};case"medium":return{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1};case"hi":return{type:"SOLID",color:{r:.9,g:.9,b:.9},opacity:1};case"creative":return{type:"SOLID",color:{r:.2,g:.4,b:.8},opacity:1}}}function Or(n){switch(n){case"wireframe":return[];case"medium":return[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.1},offset:{x:0,y:1},radius:2,visible:!0,blendMode:"NORMAL"}];case"hi":return[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.08},offset:{x:0,y:2},radius:4,visible:!0,blendMode:"NORMAL"}];case"creative":return[{type:"DROP_SHADOW",color:{r:.2,g:.4,b:.8,a:.3},offset:{x:0,y:4},radius:8,visible:!0,blendMode:"NORMAL"}]}}function Dr(n){switch(n){case"wireframe":return{type:"SOLID",color:{r:1,g:1,b:1},opacity:0};case"medium":return{type:"SOLID",color:{r:.95,g:.95,b:.95}};case"hi":return{type:"SOLID",color:{r:.9,g:.92,b:.95}};case"creative":return{type:"SOLID",color:{r:.85,g:.9,b:1}}}}function Mr(n,t){if(t!=null&&t.primaryColor){let e=fe(t.primaryColor);if(e)return{type:"SOLID",color:e,opacity:.2}}switch(n){case"wireframe":return{type:"SOLID",color:{r:.6,g:.6,b:.6},opacity:1};case"medium":return{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1};case"hi":return{type:"SOLID",color:{r:.85,g:.85,b:.85},opacity:1};case"creative":return{type:"SOLID",color:{r:.2,g:.4,b:.8},opacity:1}}}function ri(n){switch(n){case"wireframe":return{type:"SOLID",color:{r:.6,g:.6,b:.6}};case"medium":return{type:"SOLID",color:{r:.7,g:.7,b:.7}};case"hi":return{type:"SOLID",color:{r:.65,g:.65,b:.65}};case"creative":return{type:"SOLID",color:{r:.4,g:.5,b:.7}}}}function We(n,t){let e;switch(n){case"wireframe":e=0;break;case"medium":e=6;break;case"hi":e=12;break;case"creative":e=20;break}return(t==null?void 0:t.tone)==="playful"?e*1.5:(t==null?void 0:t.tone)==="serious"?e*.7:e}function fe(n){let t=n.toLowerCase().trim(),e={pink:{r:1,g:.4,b:.7},blue:{r:.2,g:.4,b:.9},green:{r:.2,g:.7,b:.4},purple:{r:.6,g:.3,b:.9},orange:{r:1,g:.5,b:.2},red:{r:.9,g:.2,b:.2},yellow:{r:1,g:.9,b:.2},navy:{r:.1,g:.2,b:.5},teal:{r:.2,g:.6,b:.6},magenta:{r:1,g:.2,b:.8}};if(e[t])return e[t];if(t.startsWith("#")){let i=t.slice(1);if(i.length===6){let r=parseInt(i.slice(0,2),16)/255,o=parseInt(i.slice(2,4),16)/255,s=parseInt(i.slice(4,6),16)/255;return{r,g:o,b:s}}}return null}var si=v(()=>{"use strict";se()});var Je,oi=v(()=>{"use strict";ni();si();Ue();se();Je=class{constructor(){I(this,"latestUserRequest","");I(this,"latestIntent",{})}canHandle(t,e){return t==="design_workshop"&&(e==="generate-screens"||e===void 0)}prepareMessages(t){let e=t.filter(s=>s.role==="user"),i=e.length>0?e[e.length-1].content:"Generate design screens";this.latestUserRequest=i;let r=this.extractIntent(i,t);this.latestIntent=r;let o=this.formatIntentSummary(r);return[{role:"system",content:"You are a Figma screen generator. Generate screens based on user requests. Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object matching the DesignSpecV1 schema."},...t,{role:"user",content:`=== USER REQUEST ===
"${i}"

=== EXTRACTED INTENT ===
${o}

=== SCHEMA REQUIREMENTS ===
Output must be a single JSON object matching the DesignSpecV1 schema exactly:

{
  "type": "designScreens",
  "version": 1,
  "meta": { 
    "title": "string",
    "userRequest": "${i.replace(/"/g,'\\"')}",
    "intent": { /* extracted intent fields */ }
  },
  "canvas": {
    "device": {
      "kind": "mobile" | "tablet" | "desktop",
      "width": number,
      "height": number
    }
  },
  "render": {
    "intent": {
      "fidelity": "wireframe" | "medium" | "hi" | "creative",
      "styleKeywords": ["string"],
      "brandTone": "string",
      "density": "compact" | "comfortable" | "spacious"
    }
  },
  "screens": [
    {
      "name": "string",
      "layout": {
        "direction": "vertical" | "horizontal",
        "padding": number | { "top": number, "right": number, "bottom": number, "left": number },
        "gap": number
      },
      "blocks": [
        { "type": "heading", "text": "string", "level": 1 | 2 | 3 },
        { "type": "bodyText", "text": "string" },
        { "type": "button", "text": "string", "variant": "primary" | "secondary" | "tertiary" },
        { "type": "input", "label": "string", "placeholder": "string", "inputType": "text" | "email" | "password" },
        { "type": "card", "title": "string", "content": "string" },
        { "type": "spacer", "height": number },
        { "type": "image", "src": "string", "alt": "string", "width": number, "height": number }
      ]
    }
  ]
}

=== STYLING RULES ===
1. Map user's app type/genre to screen names and content (e.g., "game" \u2192 game-like screens, "fintech" \u2192 financial app screens).
2. Map tone/genre/keywords to render.intent:
   - "playful", "fun", "game" \u2192 use creative fidelity, rounded corners, bright colors
   - "serious", "professional", "fintech" \u2192 use hi fidelity, restrained palette
   - "calm", "mindfulness" \u2192 use medium/hi fidelity, soft colors, spacious density
3. Map color requests to render.intent.styleKeywords and brandTone:
   - If user mentions specific colors (e.g., "pink", "blue"), include them in styleKeywords
   - If user mentions color as "accent", use it sparingly in buttons/highlights
   - Express colors as semantic names (e.g., "pink", "navy blue") or hex values
4. Map fidelity requests:
   - "wireframe" \u2192 wireframe
   - "medium" or no mention \u2192 medium
   - "hi", "high", "high-fidelity" \u2192 hi
   - "creative", "playful", "bold" \u2192 creative
5. Map screen types from user request to screen names (e.g., "onboarding" \u2192 "Onboarding", "home" \u2192 "Home").

CRITICAL: 
- Generate 1-5 screens only. If more are requested, generate exactly 5 and include meta.truncationNotice.
- Follow the user's request EXACTLY (app type, colors, fidelity, screen types).
- Include meta.userRequest and meta.intent in your output.
- Use render.intent.fidelity, styleKeywords, brandTone, and density to capture user's styling preferences.
- Return JSON only, no other text.`}]}extractIntent(t,e){let i={},r=t.toLowerCase(),o=["game","fintech","mindfulness","fitness","dashboard","social","ecommerce","banking","health"];for(let u of o)if(r.includes(u)){i.appType=u;break}r.includes("playful")||r.includes("fun")||r.includes("game")?i.tone="playful":r.includes("serious")||r.includes("professional")?i.tone="serious":(r.includes("calm")||r.includes("peaceful"))&&(i.tone="calm");let s=[],a=["minimalist","bold","modern","classic","vibrant","soft"];for(let u of a)r.includes(u)&&s.push(u);s.length>0&&(i.keywords=s);let l=[{pattern:/pink|rose|magenta/gi,name:"pink"},{pattern:/blue|navy|azure/gi,name:"blue"},{pattern:/green|emerald|mint/gi,name:"green"},{pattern:/purple|violet|lavender/gi,name:"purple"},{pattern:/orange|amber|peach/gi,name:"orange"},{pattern:/red|crimson|scarlet/gi,name:"red"},{pattern:/yellow|gold|amber/gi,name:"yellow"}],p=[];for(let{pattern:u,name:m}of l)u.test(t)&&p.push(m);p.length>0&&(i.primaryColor=p[0],p.length>1&&(i.accentColors=p.slice(1))),r.includes("wireframe")?i.fidelity="wireframe":r.includes("hi")||r.includes("high")||r.includes("high-fidelity")?i.fidelity="hi":r.includes("creative")||r.includes("playful")||r.includes("bold")?i.fidelity="creative":r.includes("medium")&&(i.fidelity="medium"),r.includes("compact")||r.includes("dense")?i.density="compact":r.includes("spacious")||r.includes("airy")?i.density="spacious":r.includes("comfortable")&&(i.density="comfortable");let c=[],d=["onboarding","home","profile","settings","stats","store","dashboard","login","signup"];for(let u of d)r.includes(u)&&c.push(u);return c.length>0&&(i.screenArchetypes=c),i}formatIntentSummary(t){let e=[];return t.appType&&e.push(`App Type: ${t.appType}`),t.tone&&e.push(`Tone: ${t.tone}`),t.keywords&&t.keywords.length>0&&e.push(`Keywords: ${t.keywords.join(", ")}`),t.primaryColor&&e.push(`Primary Color: ${t.primaryColor}`),t.accentColors&&t.accentColors.length>0&&e.push(`Accent Colors: ${t.accentColors.join(", ")}`),t.fidelity&&e.push(`Fidelity: ${t.fidelity}`),t.density&&e.push(`Density: ${t.density}`),t.screenArchetypes&&t.screenArchetypes.length>0&&e.push(`Screen Types: ${t.screenArchetypes.join(", ")}`),e.length>0?e.join(`
`):"No explicit intent extracted (use defaults)"}async handleResponse(t){let{response:e,provider:i,sendAssistantMessage:r,replaceStatusMessage:o}=t,s=`dw_${Date.now()}`;console.log(`[DW ${s}] START`,{assistantId:t.assistantId,actionId:t.actionId});try{let a=e.replace(/generate:\s*\d+\/\d+\s*\(\d+%\)/gi,"").trim();console.log(`[DW ${s}] RAW_RESPONSE_HEAD`,a.slice(0,200)),console.log(`[DW ${s}] RAW_RESPONSE_LENGTH`,a.length);let l=ge(a);l||(l=a.trim(),l=l.replace(/^```json\s*/i,"").replace(/^```\s*/i,"").replace(/\s*```$/i,""));let p;try{p=JSON.parse(l),p&&typeof p=="object"&&!Array.isArray(p)&&console.log(`[DW ${s}] PARSED_JSON_KEYS:`,Object.keys(p));let g=JSON.stringify(p,null,2);console.log(`[DW ${s}] PARSED_JSON_FULL (${g.length} chars):`,g.length>2e3?g.substring(0,2e3)+"...":g)}catch(g){return console.log(`[DW ${s}] JSON parse error:`,g),await this.attemptRepair(t,a,s)}console.log(`[DW][VALIDATION] ${s} - Starting validation`);let c=bt(p);if(!c.ok)return console.log(`[DW][VALIDATION] ${s} - Validation failed:`,c.errors),await this.attemptRepair(t,a,s);c.warnings.length>0&&console.log(`[DW][VALIDATION] ${s} - Warnings:`,c.warnings);let d=p;if(d.meta||(d.meta={title:"Screens"}),d.meta.userRequest=this.latestUserRequest,d.meta.runId=s,!d.meta.intent)d.meta.intent=this.latestIntent;else{let g=d.meta.intent;d.meta.intent=B(N(N({},this.latestIntent),g),{keywords:g.keywords||this.latestIntent.keywords,accentColors:g.accentColors||this.latestIntent.accentColors,screenArchetypes:g.screenArchetypes||this.latestIntent.screenArchetypes})}console.log(`[DW][INTENT] ${s} - User request: "${this.latestUserRequest}"`),console.log(`[DW][INTENT] ${s} - Extracted intent:`,JSON.stringify(d.meta.intent,null,2)),console.log(`[DW][SPEC] ${s} - Normalizing spec`);let u=At(d);console.log(`[DW][SPEC] ${s} - Normalized: ${u.screens.length} screens`),console.log(`[DW][RENDER] ${s} - Starting render`);let m=await vt(u,s);return console.log(`[DW][RENDER] ${s} - Render complete`),m.report&&(console.log(`[DW][REPORT] ${s} - Consumed fields:`,m.report.consumedFields.length),console.log(`[DW][REPORT] ${s} - Unused fields:`,m.report.unusedFields.length),console.log(`[DW][REPORT] ${s} - Fallbacks:`,m.report.fallbacks.length),m.report.unusedFields.length>0&&m.report.unusedFields.forEach(g=>{console.log(`[DW][UNUSED_FIELD] ${s} - ${g.field}:`,g.value,g.reason||"")})),await this.createObservabilityArtifacts(u,m.report,s,m.section),o("Screens placed on stage"),u.meta.truncationNotice&&r(u.meta.truncationNotice),figma.notify("Screens generated successfully"),{handled:!0}}catch(a){console.error(`[DW ${s}] Error:`,a);let l=a instanceof Error?a.message:"Unknown error processing design spec";return o(`Error: ${l}`,!0),figma.notify(`Error generating screens: ${l}`),{handled:!0,message:`Error: ${l}`}}}async attemptRepair(t,e,i){console.log(`[DW ${i}] BEFORE repair attempt`);try{let r=`Convert the following to valid JSON matching the DesignSpecV1 schema exactly. Return JSON only, no other text.

Required schema:
{
  "type": "designScreens",
  "version": 1,
  "meta": { "title": "string" },
  "canvas": {
    "device": {
      "kind": "mobile" | "tablet" | "desktop",
      "width": number,
      "height": number
    }
  },
  "render": {
    "intent": {
      "fidelity": "wireframe" | "medium" | "hi" | "creative"
    }
  },
  "screens": [
    {
      "name": "string",
      "layout": { "direction": "vertical" | "horizontal", "padding": number, "gap": number },
      "blocks": [
        { "type": "heading", "text": "string", "level": 1 | 2 | 3 },
        { "type": "bodyText", "text": "string" },
        { "type": "button", "text": "string", "variant": "primary" | "secondary" | "tertiary" },
        { "type": "input", "label": "string", "placeholder": "string", "inputType": "text" | "email" | "password" },
        { "type": "card", "title": "string", "content": "string" },
        { "type": "spacer", "height": number },
        { "type": "image", "width": number, "height": number }
      ]
    }
  ]
}

CRITICAL: Generate 1-5 screens only.

Original response:
${e.substring(0,2e3)}`,o=[{role:"system",content:"Return ONLY valid JSON. No prose. No markdown. No code fences. Output must be a single JSON object."},{role:"user",content:r}],s=await t.provider.sendChat({messages:o,assistantId:t.assistantId,assistantName:"Design Workshop",quickActionId:t.actionId});console.log(`[DW ${i}] repair response length:`,s.length),console.log(`[DW ${i}] repair response head:`,s.substring(0,200));let a=ge(s);a||(a=s.trim(),a=a.replace(/^```json\s*/i,"").replace(/^```\s*/i,"").replace(/\s*```$/i,""));let l;try{l=JSON.parse(a)}catch(m){return console.log(`[DW ${i}] Repair parse error:`,m),t.replaceStatusMessage("Error: Could not parse design spec. Please try again.",!0),figma.notify("Error: Invalid JSON format"),{handled:!0,message:"Error: Could not parse design spec"}}let p=bt(l);if(!p.ok)return console.log(`[DW ${i}] Repair validation failed:`,p.errors),t.replaceStatusMessage("Error: Design spec validation failed. Please try again.",!0),figma.notify("Error: Invalid design spec format"),{handled:!0,message:"Error: Design spec validation failed"};let c=l;if(c.meta||(c.meta={title:"Screens"}),c.meta.userRequest=this.latestUserRequest,c.meta.runId=i,!c.meta.intent)c.meta.intent=this.latestIntent;else{let m=c.meta.intent;c.meta.intent=B(N(N({},this.latestIntent),m),{keywords:m.keywords||this.latestIntent.keywords,accentColors:m.accentColors||this.latestIntent.accentColors,screenArchetypes:m.screenArchetypes||this.latestIntent.screenArchetypes})}let d=At(c),u=await vt(d,i);return await this.createObservabilityArtifacts(d,u.report,i,u.section),t.replaceStatusMessage("Screens placed on stage"),d.meta.truncationNotice&&t.sendAssistantMessage(d.meta.truncationNotice),figma.notify("Screens generated successfully (repaired)"),{handled:!0}}catch(r){return console.error(`[DW ${i}] Repair error:`,r),t.replaceStatusMessage("Error: Could not repair design spec. Please try again.",!0),figma.notify("Error: Failed to repair design spec"),{handled:!0,message:"Error: Could not repair design spec"}}}async createObservabilityArtifacts(t,e,i,r){try{let o=await q(),s=figma.createFrame();s.name=`Design Workshop \u2014 Spec & Intent (${i})`,s.layoutMode="VERTICAL",s.primaryAxisSizingMode="AUTO",s.counterAxisSizingMode="AUTO",s.paddingTop=16,s.paddingRight=16,s.paddingBottom=16,s.paddingLeft=16,s.itemSpacing=12,s.fills=[{type:"SOLID",color:{r:.98,g:.98,b:.98}}],s.strokes=[{type:"SOLID",color:{r:.8,g:.8,b:.8},opacity:1}],s.strokeWeight=1,s.cornerRadius=8;let a=await y("Design Workshop \u2014 Spec & Intent",{fontSize:14,fontName:o.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});a.name="Title",s.appendChild(a);let l=await y(`Run: ${i}`,{fontSize:11,fontName:o.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});if(l.name="Run ID",s.appendChild(l),t.meta.userRequest){let u=await y("User Request:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});u.name="User Request Label",s.appendChild(u);let m=await y(`"${t.meta.userRequest}"`,{fontSize:11,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});m.name="User Request",m.resize(300,m.height),s.appendChild(m)}if(t.meta.intent){let u=await y("Intent:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});u.name="Intent Label",s.appendChild(u);let m=[];if(t.meta.intent.appType&&m.push(`App: ${t.meta.intent.appType}`),t.meta.intent.tone&&m.push(`Tone: ${t.meta.intent.tone}`),t.meta.intent.primaryColor&&m.push(`Color: ${t.meta.intent.primaryColor}`),t.meta.intent.fidelity&&m.push(`Fidelity: ${t.meta.intent.fidelity}`),m.length>0){let g=await y(m.join(" \u2022 "),{fontSize:11,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});g.name="Intent",g.resize(300,g.height),s.appendChild(g)}}if(e){let u=[];if(e.consumedFields.length>0&&u.push(`Applied: ${e.consumedFields.length} fields`),e.unusedFields.length>0&&u.push(`Unused: ${e.unusedFields.length} fields`),e.fallbacks.length>0&&u.push(`Fallbacks: ${e.fallbacks.length}`),u.length>0){let m=await y("Render Report:",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});m.name="Report Label",s.appendChild(m);let g=await y(u.join(" \u2022 "),{fontSize:11,fontName:o.regular,fills:[{type:"SOLID",color:{r:.3,g:.3,b:.3}}]});g.name="Report",g.resize(300,g.height),s.appendChild(g)}}let p=await y("Spec (preview):",{fontSize:12,fontName:o.bold,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});p.name="Spec Label",s.appendChild(p);let c={screens:t.screens.length,fidelity:t.render.intent.fidelity,device:t.canvas.device.kind},d=await y(JSON.stringify(c,null,2),{fontSize:10,fontName:o.regular,fills:[{type:"SOLID",color:{r:.4,g:.4,b:.4}}]});d.name="Spec Preview",d.resize(300,d.height),s.appendChild(d),s.x=r.x+r.width+40,s.y=r.y,figma.currentPage.appendChild(s)}catch(o){console.error("[DW] Error creating observability artifacts:",o)}}}});function ai(n,t=48){if(!n||n.trim().length===0)return"Discovery Session";let e=n.trim();return e.length<=t?e:e.substring(0,t-3)+"..."}var li=v(()=>{"use strict"});function ye(n,t){return n.length<=t?n:n.substring(0,t-3)+"..."}function Lr(n){let e=figma.currentPage.children.filter(o=>o!==n);if(e.length===0)return{x:0,y:0};let i=0;for(let o of e){let s=0;if("absoluteBoundingBox"in o&&o.absoluteBoundingBox)s=o.absoluteBoundingBox.y+o.absoluteBoundingBox.height;else if("absoluteRenderBounds"in o&&o.absoluteRenderBounds)s=o.absoluteRenderBounds.y+o.absoluteRenderBounds.height;else if("y"in o&&"height"in o){let a=o.y,l=o.parent;for(;l&&l.type!=="PAGE"&&l.type!=="DOCUMENT";)"y"in l&&(a+=l.y),l=l.parent;s=a+(o.height||0)}s>i&&(i=s)}let r=i+120;return{x:0,y:Math.max(0,r)}}async function di(n,t){let e=await q(),i=figma.createFrame();i.name=`Discovery \u2014 ${n}`,i.layoutMode="VERTICAL",i.primaryAxisSizingMode="AUTO",i.counterAxisSizingMode="FIXED",i.resize(800,100),i.itemSpacing=24,i.paddingTop=40,i.paddingRight=40,i.paddingBottom=40,i.paddingLeft=40,i.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],i.strokes=[{type:"SOLID",color:{r:.88,g:.88,b:.88},opacity:1}],i.strokeWeight=1,i.cornerRadius=8,i.effects=[{type:"DROP_SHADOW",color:{r:0,g:0,b:0,a:.1},offset:{x:0,y:2},radius:4,visible:!0,blendMode:"NORMAL"}];let r=await pi(t,e);i.appendChild(r),await mi(i,{problemFrame:void 0,risksAndAssumptions:[],hypothesesAndExperiments:[],decisionLog:[],asyncTasks:[]},t,e);let o=Lr(i);return i.x=o.x,i.y=o.y,figma.currentPage.appendChild(i),figma.currentPage.selection=[i],figma.viewport.scrollAndZoomIntoView([i]),i}async function ui(n,t,e){var s;let i=await q();if(n.children.length>0){let a=n.children[0];a.name==="Status Badge"&&a.remove()}let r=await pi(e,i);n.insertChild(0,r);let o=[];for(let a=1;a<n.children.length;a++)o.push(n.children[a]);for(let a of o)a.remove();await mi(n,t,e,i),(s=t.meta)!=null&&s.title&&(n.name=`Discovery \u2014 ${t.meta.title}`)}async function pi(n,t){let e=U("Status Badge","HORIZONTAL",{padding:{top:8,right:16,bottom:8,left:16},gap:8});e.counterAxisSizingMode="FIXED",e.resize(200,32);let r=await y(`STATUS: ${n==="COMPLETED"?"COMPLETED":"IN PROGRESS"}`,{fontSize:14,fontName:t.bold,fills:[{type:"SOLID",color:{r:1,g:1,b:1}}]});return e.appendChild(r),n==="COMPLETED"?e.fills=[{type:"SOLID",color:{r:.2,g:.7,b:.2}}]:e.fills=[{type:"SOLID",color:{r:1,g:.6,b:.2}}],e.cornerRadius=4,e}async function mi(n,t,e,i){await Pr(n,t.problemFrame,i),t.risksAndAssumptions&&t.risksAndAssumptions.length>0?await Fr(n,t.risksAndAssumptions,i):await ci(n,"Risks & Assumptions","No risks or assumptions identified yet.",i),t.hypothesesAndExperiments&&t.hypothesesAndExperiments.length>0?await $r(n,t.hypothesesAndExperiments,i):await ci(n,"Hypotheses & Experiments","No hypotheses identified yet.",i),t.decisionLog&&t.decisionLog.length>0&&await zr(n,t.decisionLog,i),t.asyncTasks&&t.asyncTasks.length>0&&await Ur(n,t.asyncTasks,i)}async function Pr(n,t,e){let i=U("Problem Frame","VERTICAL",{gap:12});i.counterAxisSizingMode="FIXED",i.primaryAxisSizingMode="AUTO",i.resize(720,100);let r=await y("Problem Frame",{fontSize:20,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(r);let o=await y("What:",{fontSize:16,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(o);let s=(t==null?void 0:t.what)||"TBD",a=await y(s,{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:t!=null&&t.what?{r:.2,g:.2,b:.2}:{r:.6,g:.6,b:.6}}]});i.appendChild(a);let l=await y("Who:",{fontSize:16,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(l);let p=(t==null?void 0:t.who)||"TBD",c=await y(p,{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:t!=null&&t.who?{r:.2,g:.2,b:.2}:{r:.6,g:.6,b:.6}}]});i.appendChild(c);let d=await y("Why:",{fontSize:16,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(d);let u=(t==null?void 0:t.why)||"TBD",m=await y(u,{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:t!=null&&t.why?{r:.2,g:.2,b:.2}:{r:.6,g:.6,b:.6}}]});i.appendChild(m);let g=await y("Success:",{fontSize:16,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(g);let f=(t==null?void 0:t.success)||"TBD",h=await y(f,{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:t!=null&&t.success?{r:.2,g:.2,b:.2}:{r:.6,g:.6,b:.6}}]});i.appendChild(h),n.appendChild(i)}async function Fr(n,t,e){let i=U("Risks & Assumptions","VERTICAL",{gap:8});i.counterAxisSizingMode="FIXED",i.primaryAxisSizingMode="AUTO",i.resize(720,100);let r=await y("Risks & Assumptions",{fontSize:20,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(r);for(let o of t){let s=U(`Item ${o.id}`,"HORIZONTAL",{gap:8});s.counterAxisSizingMode="AUTO",s.primaryAxisSizingMode="AUTO";let a=`\u2022 [${o.type.toUpperCase()}]`,l=await y(a,{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});s.appendChild(l);let p=await y(ye(o.description,400),{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});s.appendChild(p),i.appendChild(s)}n.appendChild(i)}async function $r(n,t,e){let i=U("Hypotheses & Experiments","VERTICAL",{gap:12});i.counterAxisSizingMode="FIXED",i.primaryAxisSizingMode="AUTO",i.resize(720,100);let r=await y("Hypotheses & Experiments",{fontSize:20,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});i.appendChild(r);for(let o of t){let s=U(`Hypothesis ${o.id}`,"VERTICAL",{gap:4});s.counterAxisSizingMode="FIXED",s.primaryAxisSizingMode="AUTO",s.resize(720,100);let a=await y("Hypothesis:",{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});s.appendChild(a);let l=await y(ye(o.hypothesis,400),{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});if(s.appendChild(l),o.experiment){let p=await y("Experiment:",{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});s.appendChild(p);let c=await y(ye(o.experiment,400),{fontSize:14,fontName:e.italic,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});s.appendChild(c)}i.appendChild(s)}n.appendChild(i)}async function zr(n,t,e){let i=U("Decision Log","VERTICAL",{gap:8});i.counterAxisSizingMode="FIXED",i.primaryAxisSizingMode="AUTO",i.resize(720,100);let r=await y("Decision Log",{fontSize:20,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});if(i.appendChild(r),!!t){for(let o of t){let s=U("Decision Entry","VERTICAL",{gap:4});s.counterAxisSizingMode="FIXED",s.primaryAxisSizingMode="AUTO",s.resize(720,100);let a=await y(o.timestamp,{fontSize:12,fontName:e.regular,fills:[{type:"SOLID",color:{r:.6,g:.6,b:.6}}]});s.appendChild(a);let l=await y(ye(o.decision,400),{fontSize:14,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});if(s.appendChild(l),o.rationale){let p=await y(ye(o.rationale,300),{fontSize:12,fontName:e.regular,fills:[{type:"SOLID",color:{r:.5,g:.5,b:.5}}]});s.appendChild(p)}i.appendChild(s)}n.appendChild(i)}}async function Ur(n,t,e){let i=U("Async Tasks","VERTICAL",{gap:8});i.counterAxisSizingMode="FIXED",i.primaryAxisSizingMode="AUTO",i.resize(720,100);let r=await y("Async Tasks",{fontSize:20,fontName:e.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});if(i.appendChild(r),!!t){for(let o of t){let s=U(`Task ${o.ownerRole}`,"HORIZONTAL",{gap:12});s.counterAxisSizingMode="AUTO",s.primaryAxisSizingMode="AUTO";let a=await y(o.ownerRole,{fontSize:12,fontName:e.bold,fills:[{type:"SOLID",color:{r:1,g:1,b:1}}]}),l=U("Role Badge","HORIZONTAL",{padding:{top:4,right:8,bottom:4,left:8},gap:4});l.counterAxisSizingMode="FIXED",l.resize(100,24),l.fills=[{type:"SOLID",color:{r:.2,g:.4,b:.9}}],l.cornerRadius=4,l.appendChild(a),s.appendChild(l);let p=await y(ye(o.task,400),{fontSize:14,fontName:e.regular,fills:[{type:"SOLID",color:{r:.2,g:.2,b:.2}}]});s.appendChild(p),i.appendChild(s)}n.appendChild(i)}}async function ci(n,t,e,i){let r=U(t,"VERTICAL",{gap:8});r.counterAxisSizingMode="FIXED",r.primaryAxisSizingMode="AUTO",r.resize(720,100);let o=await y(t,{fontSize:20,fontName:i.bold,fills:[{type:"SOLID",color:{r:.1,g:.1,b:.1}}]});r.appendChild(o);let s=await y(e,{fontSize:14,fontName:i.italic,fills:[{type:"SOLID",color:{r:.6,g:.6,b:.6}}]});r.appendChild(s),n.appendChild(r)}var gi=v(()=>{"use strict";se()});function _r(n){let t={},e=null;for(let i=0;i<n.length;i++){let r=n[i],o=r.content;if(r.role==="assistant"){let s=o.toLowerCase();(s.includes("what problem")||s.includes("what are you")||s.includes("**what**"))&&!t.what?e="what":(s.includes("who is affected")||s.includes("who are")||s.includes("**who**"))&&!t.who?e="who":(s.includes("why does this matter")||s.includes("why is")||s.includes("**why**"))&&!t.why?e="why":(s.includes("what does success look like")||s.includes("success")||s.includes("**success**"))&&!t.success&&(e="success");let a=/(?:what|problem)[:\-]\s*(.+?)(?:\n|who|why|success|$)/i,l=o.match(a);l&&!t.what&&l[1]&&l[1].trim().length>3&&(t.what=l[1].trim());let p=/(?:who|affected)[:\-]\s*(.+?)(?:\n|why|success|what|$)/i,c=o.match(p);c&&!t.who&&c[1]&&c[1].trim().length>3&&(t.who=c[1].trim());let d=/(?:why|matters?)[:\-]\s*(.+?)(?:\n|success|what|who|$)/i,u=o.match(d);u&&!t.why&&u[1]&&u[1].trim().length>3&&(t.why=u[1].trim());let m=/(?:success|looks? like)[:\-]\s*(.+?)(?:\n|what|who|why|$)/i,g=o.match(m);g&&!t.success&&g[1]&&g[1].trim().length>3&&(t.success=g[1].trim())}if(r.role==="user"&&e){let s=o.trim();s.length>5&&!s.match(/^(yes|no|ok|okay|sure|yep|nope)$/i)&&(e==="what"&&!t.what?t.what=s:e==="who"&&!t.who?t.who=s:e==="why"&&!t.why?t.why=s:e==="success"&&!t.success&&(t.success=s),e=null)}if(r.role==="user"){let s=r.content.match(/(?:what|what problem)[:\-]\s*(.+?)(?:\n|$)/i);s&&!t.what&&s[1]&&s[1].trim().length>3&&(t.what=s[1].trim());let a=r.content.match(/(?:who|who is affected)[:\-]\s*(.+?)(?:\n|$)/i);a&&!t.who&&a[1]&&a[1].trim().length>3&&(t.who=a[1].trim());let l=r.content.match(/(?:why|why does this matter)[:\-]\s*(.+?)(?:\n|$)/i);l&&!t.why&&l[1]&&l[1].trim().length>3&&(t.why=l[1].trim());let p=r.content.match(/(?:success|what does success look like)[:\-]\s*(.+?)(?:\n|$)/i);p&&!t.success&&p[1]&&p[1].trim().length>3&&(t.success=p[1].trim())}}return t}function qr(n){let t=[],e=new Set;for(let i of n){let r=i.content,o=/[\-\*]\s*(?:\[?(?:RISK|ASSUMPTION|risk|assumption)\]?\s*)?(.+?)(?:\n|$)/gi,s;for(;(s=o.exec(r))!==null;){let l=s[1].trim();if(!l||l.length<5)continue;let p=l.toLowerCase(),c=p.includes("risk")||r.toLowerCase().includes("risk"),d=p.includes("assumption")||r.toLowerCase().includes("assumption"),u;p.includes("high impact")||p.includes("impact: high")?u="high":p.includes("medium impact")||p.includes("impact: medium")?u="medium":(p.includes("low impact")||p.includes("impact: low"))&&(u="low");let m=l.replace(/\[?(?:RISK|ASSUMPTION|risk|assumption)\]?/gi,"").replace(/impact:\s*(?:high|medium|low)/gi,"").trim();if(m.length<3)continue;let g=`${c?"risk":"assumption"}-${t.length+1}`,f=`${c?"risk":"assumption"}-${m.substring(0,50).toLowerCase()}`;e.has(f)||(e.add(f),t.push(N({id:g,type:c?"risk":d?"assumption":"risk",description:m},u&&{impact:u})))}let a=/\d+[\.\)]\s*(?:\[?(?:RISK|ASSUMPTION|risk|assumption)\]?\s*)?(.+?)(?:\n|$)/gi;for(;(s=a.exec(r))!==null;){let l=s[1].trim();if(!l||l.length<5)continue;let p=l.toLowerCase(),c=p.includes("risk"),d=p.includes("assumption"),u=l.replace(/\[?(?:RISK|ASSUMPTION|risk|assumption)\]?/gi,"").trim();if(u.length<3)continue;let m=`${c?"risk":"assumption"}-${t.length+1}`,g=`${c?"risk":"assumption"}-${u.substring(0,50).toLowerCase()}`;e.has(g)||(e.add(g),t.push({id:m,type:c?"risk":d?"assumption":"risk",description:u}))}}return t.slice(0,12)}function Hr(n){let t=[],e=new Set;for(let i of n){let r=i.content,o=/(?:hypothesis|hypothesis:)[:\-]?\s*(.+?)(?:\n|experiment|$)/gi,s;for(;(s=o.exec(r))!==null;){let l=s[1].trim();if(!l||l.length<5)continue;let p=r.match(/(?:experiment|experiment:)[:\-]?\s*(.+?)(?:\n|hypothesis|$)/i),c=p?p[1].trim():void 0,d=l.substring(0,50).toLowerCase();e.has(d)||(e.add(d),t.push(N({id:`hyp-${t.length+1}`,hypothesis:l},c&&{experiment:c})))}let a=/[\-\*]\s*(?:hypothesis:?\s*)?(.+?)(?:\n|$)/gi;for(;(s=a.exec(r))!==null;){let l=s[1].trim();if(!l||l.length<5)continue;let p=l.toLowerCase();if(p.includes("hypothesis")||p.includes("if")||p.includes("we believe")){let c=l.substring(0,50).toLowerCase();e.has(c)||(e.add(c),t.push({id:`hyp-${t.length+1}`,hypothesis:l}))}}}return t.slice(0,12)}function Br(n){let t=[];for(let e of n){let i=e.content,r=/(?:decision|decided)[:\-]?\s*(.+?)(?:\n|rationale|context|$)/gi,o;for(;(o=r.exec(i))!==null;){let s=o[1].trim();if(!s||s.length<5)continue;let a=i.match(/(?:rationale|reason)[:\-]?\s*(.+?)(?:\n|context|$)/i),l=a?a[1].trim():void 0,p=i.match(/(?:context)[:\-]?\s*(.+?)(?:\n|rationale|$)/i),c=p?p[1].trim():void 0;t.push(N(N({timestamp:new Date().toISOString(),decision:s},l&&{rationale:l}),c&&{context:c}))}}return t.slice(0,20)}function Vr(n){let t=[],e=new Set,i={design:"Design",product:"Product",dev:"Dev",development:"Dev",research:"Research",analytics:"Analytics"};for(let r of n){let o=r.content,s=/(?:task|todo|action)[:\-]?\s*(.+?)(?:\n|owner|due|$)/gi,a;for(;(a=s.exec(o))!==null;){let l=a[1].trim();if(!l||l.length<5)continue;let p="Other",c=l.toLowerCase();for(let[g,f]of Object.entries(i))if(c.includes(g)){p=f;break}let d=o.match(/(?:due|deadline)[:\-]?\s*(\d+)\s*(?:hours?|hrs?|h)/i),u=d?parseInt(d[1],10):void 0,m=l.substring(0,50).toLowerCase();e.has(m)||(e.add(m),t.push(N({ownerRole:p,task:l},u&&{dueInHours:u})))}}return t.slice(0,6)}function fi(n){var r,o,s,a;let t=((r=n.problemFrame)==null?void 0:r.what)&&((o=n.problemFrame)==null?void 0:o.who)&&((s=n.problemFrame)==null?void 0:s.why)&&((a=n.problemFrame)==null?void 0:a.success),e=n.risksAndAssumptions&&n.risksAndAssumptions.length>0,i=n.hypothesesAndExperiments&&n.hypothesesAndExperiments.length>0;return t&&e&&i?"COMPLETED":"IN_PROGRESS"}function yi(n){let t=_r(n);return B(N({},Object.keys(t).length>0&&{problemFrame:t}),{risksAndAssumptions:qr(n),hypothesesAndExperiments:Hr(n),decisionLog:Br(n),asyncTasks:Vr(n)})}var hi=v(()=>{"use strict"});var Ge,Si=v(()=>{"use strict";li();gi();hi();Ge=class{constructor(){I(this,"documentFrame",null);I(this,"documentTitle","Discovery Session");I(this,"messageHistory",[])}canHandle(t,e){return t==="discovery_copilot"&&(e==="start-discovery"||e===void 0)}prepareMessages(t){this.messageHistory=t;let e=t.filter(r=>r.role==="user"),i=e.length>0?e[e.length-1].content:"Start discovery session";return e.length>0&&!this.documentFrame&&(this.documentTitle=ai(e[0].content,48)),[{role:"system",content:`You are a Discovery Copilot assistant. Guide users through a structured 3-step discovery process:

**Step 1: Problem Frame** - Ask about What, Who, Why, and Success
**Step 2: Risks & Assumptions** - Ask about risks and assumptions
**Step 3: Hypotheses & Experiments** - Ask about hypotheses and experiments

After collecting all information, ask if they want to add Decision Log or Async Tasks.

Be conversational and guide them step-by-step. Show progress indicators like "Step 1 of 3: Problem Frame".`},...t]}async handleResponse(t){var s;let{response:e,sendAssistantMessage:i,replaceStatusMessage:r}=t,o=`dc_${Date.now()}`;console.log(`[DC ${o}] START`,{assistantId:t.assistantId,actionId:t.actionId});try{let a=[...this.messageHistory,{role:"assistant",content:e}];if(!this.documentFrame){let c=figma.currentPage.children.find(d=>d.type==="FRAME"&&d.name.startsWith("Discovery \u2014"));c?(console.log(`[DC ${o}] Found existing document frame`),this.documentFrame=c):(console.log(`[DC ${o}] Creating initial document`),this.documentFrame=await di(this.documentTitle,"IN_PROGRESS"))}console.log(`[DC ${o}] Extracting data from conversation`);let l=yi(a);l.meta?l.meta.title=this.documentTitle:l.meta={title:this.documentTitle};let p=fi(l);return console.log(`[DC ${o}] Status: ${p}`),this.documentFrame&&(console.log(`[DC ${o}] Updating document`),await ui(this.documentFrame,l,p),(s=l.meta)!=null&&s.title&&(this.documentFrame.name=`Discovery \u2014 ${l.meta.title}`)),console.log(`[DC ${o}] Document updated, continuing conversation`),{handled:!1}}catch(a){console.error(`[DC ${o}] Error:`,a);let l=a instanceof Error?a.message:"Unknown error processing discovery document";return r(`Error: ${l}`,!0),figma.notify(`Error updating discovery document: ${l}`),{handled:!1}}}}});function xt(n,t){return jr.find(e=>e.canHandle(n,t))}var jr,bi=v(()=>{"use strict";Vn();ti();oi();Si();jr=[new ze,new je,new Je,new Ge]});var Ai,wi=v(()=>{"use strict";Ai="1.0.0"});var ki={};Z(ki,{default:()=>Jr});async function Wr(){try{R=await K(Q)}catch(n){console.error("[Main] Failed to initialize provider:",n);let{StubProvider:t}=await Promise.resolve().then(()=>(nt(),$t));R=new t}}function X(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Ti(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Ni(n,t){let e=0;for(let r=n.length-1;r>=0;r--)if(n[r].isBoundary&&n[r].assistantId===t){e=r+1;break}return n.slice(e).filter(r=>r.isBoundary||r.isGreeting||r.isInstructions||r.isStatus?!1:r.role==="user"||r.role==="assistant")}function Ye(){let n=ie(D);figma.ui.postMessage({pluginMessage:{type:"SELECTION_STATE",state:n}})}function Ii(n){if(!n)return"";let t=n.replace(/generate:\s*\d+\/\d+\s*\(\d+%\)/gi,"").replace(/generate:\s*\d+\/\d+/gi,"").replace(/\(\d+%\)/g,"").trim(),e=t.split(/\n+/).filter(o=>o.trim().length>0),i=[],r=new Set;for(let o of e){let s=o.trim().toLowerCase().replace(/\s+/g," ");r.has(s)||(r.add(s),i.push(o.trim()))}return t=i.join(`
`),t=t.replace(/[ \t]+/g," ").trim(),t}function he(n,t,e){let i=Ii(n),r={id:X(),role:"assistant",content:i,timestamp:Date.now(),toolCallId:t,requestId:e};F.push(r),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:r}})}function Ci(n,t="Processing..."){let e={id:X(),role:"assistant",content:t,timestamp:Date.now(),isStatus:!0,statusStyle:"loading",requestId:n};return F.push(e),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:e}}),e}function _(n,t,e=!1){let i=F.findIndex(s=>s.requestId===n&&s.isStatus===!0);if(i===-1){console.warn("[Main] Status message not found for requestId:",n),he(t,void 0,n);return}let r=Ii(t),o={id:F[i].id,role:"assistant",content:r,timestamp:Date.now(),requestId:n,isStatus:!1,statusStyle:e?"error":void 0};F[i]=o,figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:o}})}function vi(n,t,e){let i={id:X(),role:"tool",content:n,timestamp:Date.now(),toolCallId:t};F.push(i),figma.ui.postMessage({pluginMessage:{type:"TOOL_RESULT",message:i,data:e}})}function Jr(){Qe({height:600,width:400,title:Dt.brandName}),figma.on("selectionchange",function(){let t=figma.currentPage.selection,e=new Set(t.map(r=>r.id)),i=new Set(D);D=D.filter(r=>e.has(r));for(let r of t)i.has(r.id)||D.push(r.id);Ye()}),D=figma.currentPage.selection.map(t=>t.id),Ye()}var H,xi,Q,R,F,D,Tt,ke,Ei=v(()=>{"use strict";Ot();Mt();te();Pt();Xt();be();ln();pt();fn();ce();de();An();ft();bi();re();wi();H=et(),xi=O.defaultMode,Q=O.provider,R=null,F=[],D=[],Tt=null,ke=null;console.log("[Main] Build version:",Ai);Wr();if(O.dev.enableSyncApiErrorDetection){let n=console.error;console.error=function(...t){let e=t.join(" ");e.includes("getNodeById")&&e.includes("Cannot call with documentAccess: dynamic-page")&&(console.error("[SYNC_API_ERROR] \u26A0\uFE0F Detected sync getNodeById call!"),console.error("[SYNC_API_ERROR] Error message:",e),console.error("[SYNC_API_ERROR] Stack trace:",new Error().stack),console.error("[SYNC_API_ERROR] This indicates a sync API call exists somewhere in the codebase"),console.error("[SYNC_API_ERROR] Please search for: figma.getNodeById( or .getNodeById(")),e.includes("getStyleById")&&e.includes("Cannot call with documentAccess: dynamic-page")&&(console.error("[SYNC_API_ERROR] \u26A0\uFE0F Detected sync getStyleById call!"),console.error("[SYNC_API_ERROR] Error message:",e),console.error("[SYNC_API_ERROR] Stack trace:",new Error().stack)),e.includes("getVariableById")&&e.includes("Cannot call with documentAccess: dynamic-page")&&(console.error("[SYNC_API_ERROR] \u26A0\uFE0F Detected sync getVariableById call!"),console.error("[SYNC_API_ERROR] Error message:",e),console.error("[SYNC_API_ERROR] Stack trace:",new Error().stack)),n.apply(console,t)}}Ke("RESET",async function(){F=[],H=et(),xi=O.defaultMode,Q=O.provider,R=await K(Q),D=[];let n={id:X(),role:"assistant",content:H.intro,timestamp:Date.now()};F.push(n),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:n}}),Ye(),figma.ui.postMessage({pluginMessage:{type:"RESET_DONE"}})});$("REQUEST_SELECTION_STATE",function(){console.log("[Main] onmessage REQUEST_SELECTION_STATE"),Ye()});$("SET_ASSISTANT",function(n){console.log("[Main] onmessage SET_ASSISTANT",{assistantId:n,lastAssistantId:Tt});let t=Ze(n);if(t){let e=Tt!==n;if(H=t,e){ke=null;let i={id:X(),role:"assistant",content:"",timestamp:Date.now(),assistantId:n,isBoundary:!0};F.push(i),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:i}});let r={id:X(),role:"assistant",content:`Hi! I'm your ${t.label} Assistant!`,timestamp:Date.now(),assistantId:n,isGreeting:!0};F.push(r),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:r}});let o={id:X(),role:"assistant",content:t.intro,timestamp:Date.now(),assistantId:n,isInstructions:!0};F.push(o),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:o}}),console.log("[Main] Inserted boundary + greeting + instructions for assistant:",n)}else console.log("[Main] Assistant unchanged, skipping boundary insertion:",n);Tt=n}});$("SET_MODE",function(n){xi=n});$("SET_LLM_PROVIDER",async function(n){Q=n,R=await K(n)});$("SEND_MESSAGE",async function(n,t){console.log("[Main] onmessage SEND_MESSAGE",{messageLength:n.length,includeSelection:t});let e=Ti(),i={id:X(),role:"user",content:n,timestamp:Date.now()};F.push(i),console.log("[Main] Sending user message to UI (single source of truth):",i.id),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:i}}),Ci(e,"Processing...");let r;if(t&&R&&(r=await $e({selectionOrder:D,quickAction:void 0,provider:R})),H.kind==="tool"){_(e,`Tool-only assistant "${H.label}" is active. Tool execution would happen here.`);return}let o=Ni(F,H.id),a=Re(o.map(p=>({role:p.role,content:p.content})));if(R&&R.capabilities.supportsPreambleInjection&&o.length>0&&o[0].role==="user"&&ke!==H.id&&a.length>0&&a[0].role==="user"){let c=`${H.label} context: ${tt(H)}. Ignore previous assistant instructions.

`;a[0]=B(N({},a[0]),{content:c+a[0].content}),ke=H.id,console.log("[Main] Injected preamble for Internal API (first message in segment)")}let l=xt(H.id,void 0);if(l&&l.prepareMessages){let p=l.prepareMessages(a);p&&(a=p)}try{R||(R=await K(Q),t&&(r=await $e({selectionOrder:D,quickAction:void 0,provider:R})));let p=await R.sendChat({messages:a,assistantId:H.id,assistantName:H.label,selection:r==null?void 0:r.selection,selectionSummary:r==null?void 0:r.selectionSummary,images:r==null?void 0:r.images,quickActionId:void 0});if(l){let c={assistantId:H.id,actionId:void 0,response:p,selectionOrder:D,selection:(r==null?void 0:r.selection)||ie(D),provider:R,sendAssistantMessage:he,replaceStatusMessage:(u,m)=>_(e,u,m),requestId:e},d=await l.handleResponse(c);if(d.handled){F.findIndex(m=>m.requestId===e&&m.isStatus===!0)!==-1&&_(e,d.message||"Completed");return}}_(e,p)}catch(p){let c=J(p);_(e,`Error: ${c}`,!0)}});$("RUN_QUICK_ACTION",async function(n,t){console.log("[Main] onmessage RUN_QUICK_ACTION",{actionId:n,assistantId:t});let e=Ti();try{let i=Ze(t);if(!i){console.error("[Main] Assistant not found:",t),he(`Error: Assistant "${t}" not found`);return}let r=i.quickActions.find(d=>d.id===n);if(!r){console.error("[Main] Action not found:",n,"for assistant:",t),he(`Error: Action "${n}" not found`);return}let o=xt(t,n);if(o&&t==="content_table"&&n==="generate-table"){let d={assistantId:t,actionId:n,response:"",selectionOrder:D,selection:ie(D),provider:R||await K(Q),sendAssistantMessage:he,replaceStatusMessage:(m,g)=>_(e,m,g),requestId:e},u=await o.handleResponse(d);if(u.handled){F.findIndex(g=>g.requestId===e&&g.isStatus===!0)!==-1&&_(e,u.message||"Table generated");return}}if(t==="code2design"){if(n==="send-json"||n==="get-json")return;if(n==="json-format-help"){_(e,`**FigmAI Template JSON Format**

**Schema Version:** 1.0

**Required Top-Level Keys:**
- \`schemaVersion\`: Must be "1.0"
- \`root\`: The root template node

**Supported Node Types (v1):**
- \`FRAME\`: Container with optional auto-layout
- \`TEXT\`: Text node with content
- \`RECTANGLE\`: Rectangle shape

**Safety Limits:**
- Maximum depth: 12 levels
- Maximum nodes: 300
- Invalid JSON will not modify the canvas

**Example Structure:**
\`\`\`json
{
  "schemaVersion": "1.0",
  "meta": { "name": "My Design" },
  "root": {
    "type": "FRAME",
    "name": "Card",
    "layout": { "mode": "AUTO_LAYOUT", "direction": "VERTICAL" },
    "children": [...]
  }
}
\`\`\`

Use SEND JSON to import or GET JSON to export your designs.`);return}}let s=ie(D);if(r.requiresSelection&&!s.hasSelection){_(e,"Error: This action requires a selection. Please select one or more nodes first.",!0);return}if(r.requiresVision&&!s.hasSelection){_(e,"Error: This action requires a selection to analyze. Please select a frame or design element first.",!0);return}let a={id:X(),role:"user",content:r.templateMessage,timestamp:Date.now()};if(F.push(a),console.log("[Main] Sending user message to UI (single source of truth):",a.id),figma.ui.postMessage({pluginMessage:{type:"ASSISTANT_MESSAGE",message:a}}),Ci(e,"Processing..."),i.kind==="tool"){_(e,`Tool-only assistant "${i.label}" is active. Tool execution would happen here.`);return}let l=Ni(F,i.id),p=Re(l.map(d=>({role:d.role,content:d.content})));if(R&&R.capabilities.supportsPreambleInjection&&l.length>0&&l[0].role==="user"&&ke!==i.id&&p.length>0&&p[0].role==="user"){let u=`${i.label} context: ${tt(i)}. Ignore previous assistant instructions.

`;p[0]=B(N({},p[0]),{content:u+p[0].content}),ke=i.id,console.log("[Main] Injected preamble for Internal API (first message in segment, quick action)")}if(o&&o.prepareMessages){let d=o.prepareMessages(p);d&&(p=d,i.id==="design_critique"&&r.id==="give-critique"&&console.log("[DC] FINAL_MESSAGES",p.map(u=>({role:u.role,contentPreview:u.content.substring(0,120)}))))}let c;R||(R=await K(Q)),c=await $e({selectionOrder:D,quickAction:r,provider:R}),c.selectionSummary?console.log("[Main] Selection summary for quick action:",c.selectionSummary.substring(0,200)+"..."):console.log("[Main] No selection summary - hasSelection:",c.selection.hasSelection);try{if(i.id==="design_critique"&&r.id==="give-critique"&&(console.log("[DC] Calling provider.sendChat with:"),console.log("[DC] assistantId=",i.id),console.log("[DC] quickActionId=",r.id),console.log("[DC] hasSelection=",c.selection.hasSelection),c.selection.hasSelection&&D.length>0)){let m=await figma.getNodeByIdAsync(D[0]);if(m&&m.type!=="DOCUMENT"&&m.type!=="PAGE"){let g=V(m);console.log("[DC] selectedNode=",m.name,"id=",m.id),console.log("[DC] anchor=",g.name,"id=",g.id)}}let d=await R.sendChat({messages:p,assistantId:i.id,assistantName:i.label,selection:r.requiresSelection?c.selection:void 0,selectionSummary:c.selectionSummary,images:c.images,quickActionId:r.id}),u=!1;if(o){let m={assistantId:i.id,actionId:r.id,response:d,selectionOrder:D,selection:c.selection,provider:R,sendAssistantMessage:he,replaceStatusMessage:(f,h)=>_(e,f,h),requestId:e},g=await o.handleResponse(m);g.handled&&(u=!0,F.findIndex(h=>h.requestId===e&&h.isStatus===!0)!==-1&&_(e,g.message||"Completed"))}u||_(e,d)}catch(d){let u=J(d);_(e,`Error: ${u}`,!0)}}catch(i){console.error("[Main] Unhandled error in RUN_QUICK_ACTION:",i);let r=i instanceof Error?i.message:"Unknown error";_(e,`Error: ${r}`,!0)}});$("RUN_TOOL",async function(n,t){let e=ie(D),i=await an({id:X(),name:n,arguments:t},e),r;if(n==="EXPORT_SELECTION_TO_TEMPLATE_JSON"&&i.startsWith("JSON_EXPORT:"))try{r={exportedJson:i.replace("JSON_EXPORT:","")};let s=i.includes("frame(s)")?`Exported ${(e==null?void 0:e.count)||0} frame(s) to JSON template.`:"Exported selection to JSON template.";vi(s,n,r);return}catch(o){}vi(i,n,r)});$("SAVE_SETTINGS",async function(n){try{await Ht(n),R=await K(Q)}catch(t){let e=J(t);figma.ui.postMessage({pluginMessage:{type:"TEST_RESULT",success:!1,message:`Failed to save settings: ${e}`}})}});$("REQUEST_SETTINGS",async function(){try{let n=await z();figma.ui.postMessage({pluginMessage:{type:"SETTINGS_RESPONSE",settings:n}})}catch(n){figma.ui.postMessage({pluginMessage:{type:"SETTINGS_RESPONSE",settings:await z()}})}});$("TEST_PROXY_CONNECTION",async function(n){try{let t=await z(),e=(n==null?void 0:n.connectionType)||t.connectionType||"proxy",i;if(e==="internal-api"){let{InternalApiProvider:r}=await Promise.resolve().then(()=>(ot(),Jt));i=new r;let o=await i.testConnection(n==null?void 0:n.internalApiUrl);figma.ui.postMessage({pluginMessage:{type:"TEST_RESULT",success:o.success,message:o.message,diagnostics:o.diagnostics}});return}else{R||(R=await K(Q)),i=R;let r=await i.testConnection();figma.ui.postMessage({pluginMessage:{type:"TEST_RESULT",success:r.success,message:r.message,diagnostics:r.diagnostics}});return}}catch(t){let e=J(t);figma.ui.postMessage({pluginMessage:{type:"TEST_RESULT",success:!1,message:`Connection test failed: ${e}`}})}});$("COPY_TABLE_STATUS",function(n,t){console.log("[Main] onmessage COPY_TABLE_STATUS",{status:n,message:t}),n==="success"?figma.notify(t||"Successfully copied table to clipboard"):n==="error"&&figma.notify(t||"Failed to copy table. See console for details.")});$("RUN_PLACEHOLDER_SCORECARD",async function(){console.log("[Main] RUN_PLACEHOLDER_SCORECARD received");try{let n;if(D.length>0){let t=await figma.getNodeByIdAsync(D[0]);t&&t.type!=="DOCUMENT"&&t.type!=="PAGE"&&(n=t)}await bn(n),figma.ui.postMessage({pluginMessage:{type:"PLACEHOLDER_SCORECARD_PLACED"}}),figma.notify("Placeholder scorecard added to stage")}catch(n){console.error("[Main] Error rendering placeholder scorecard:",n);let t=n instanceof Error?n.message:"Unknown error";figma.ui.postMessage({pluginMessage:{type:"PLACEHOLDER_SCORECARD_ERROR",message:t}}),figma.notify(`Error: ${t}`)}});$("RUN_SCORECARD_V2_PLACEHOLDER",async function(){console.log("[Main] RUN_SCORECARD_V2_PLACEHOLDER received");try{let n;if(D.length>0){let e=await figma.getNodeByIdAsync(D[0]);e&&e.type!=="DOCUMENT"&&e.type!=="PAGE"&&(n=e)}await kn({score:82,summary:"This is a placeholder scorecard v2 for visual design iteration. It demonstrates the new 2-column layout with colored score pill and tighter card design.",wins:["Clear visual hierarchy with consistent spacing","Strong color contrast meets WCAG AA standards","Interactive elements have clear affordances","Responsive layout adapts well to different screen sizes"],fixes:["Increase text contrast for body text (currently #666, suggest #333)","Add 8px spacing between related form fields to improve grouping","Make hover states more obvious with visual feedback","Consider adding loading states for async actions"],checklist:["\u2713 Primary action is visually dominant","\u2713 Related elements are grouped using spacing","\u2717 Interactive elements need hover states","\u2713 Text is readable without zooming","\u2713 Color palette is accessible"],notes:["Overall solid design with room for improvement in micro-interactions","Consider adding loading states for async actions"]},n),figma.ui.postMessage({pluginMessage:{type:"PLACEHOLDER_SCORECARD_PLACED"}}),figma.notify("Scorecard v2 (placeholder) added to stage")}catch(n){console.error("[Main] Error rendering scorecard v2 placeholder:",n);let t=n instanceof Error?n.message:"Unknown error";figma.ui.postMessage({pluginMessage:{type:"PLACEHOLDER_SCORECARD_ERROR",message:t}}),figma.notify(`Error: ${t}`)}});$("EXPORT_CONTENT_TABLE_REF_IMAGE",async function(n){console.log("[Main] EXPORT_CONTENT_TABLE_REF_IMAGE received",{rootNodeId:n});try{let t=await figma.getNodeByIdAsync(n);if(!t){console.error("[Main] Export Ref Image: Node not found for rootNodeId:",n),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_REF_IMAGE_ERROR",message:"Root node not found"}});return}if(t.type==="DOCUMENT"||t.type==="PAGE"){console.error("[Main] Export Ref Image: Cannot export document or page"),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_REF_IMAGE_ERROR",message:"Cannot export document or page as image"}});return}let e=t,i;try{i=await e.exportAsync({format:"PNG",constraint:{type:"WIDTH",value:600}})}catch(s){console.warn("[Main] Export Ref Image: WIDTH constraint failed, trying SCALE:",s);let a="width"in e?e.width:600,l=Math.min(1,600/a);i=await e.exportAsync({format:"PNG",constraint:{type:"SCALE",value:l}})}console.log("[Main] Export Ref Image: Export succeeded, bytes length:",i.length);let o=`data:image/png;base64,${figma.base64Encode(i)}`;console.log("[Main] Export Ref Image: Sending READY, dataUrl length:",o.length),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_REF_IMAGE_READY",dataUrl:o}})}catch(t){let e=t instanceof Error?t.message:"Unknown error";console.error("[Main] Export Ref Image: Failed to export ref image:",t),figma.ui.postMessage({pluginMessage:{type:"CONTENT_TABLE_REF_IMAGE_ERROR",message:`Could not export reference image: ${e}`}})}})});var Gr={"src/main.ts--default":(Ei(),_i(ki)).default},Yr="src/main.ts--default";Gr[Yr]();
